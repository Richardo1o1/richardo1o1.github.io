<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Uric组件2022文档 |  New structure for utility</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/web1.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?6df1890c9854cdf70d1c67b43e743c4d";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
        pre.mermaid {
	  background: #dedede;
	}	
      </style>
    <link rel="alternate" href="/atom.xml" title="New structure for utility" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-uric2022"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Uric组件2022文档
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/03/01/uric2022/" class="article-date">
  <time datetime="2023-03-01T12:32:50.000Z" itemprop="datePublished">2023-03-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">40.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">202 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1>Uric组件2022文档</h1>
<p>预备知识点：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Python基础</span><br><span class="line">Mysql</span><br><span class="line">前端</span><br><span class="line">Django</span><br><span class="line">DRF组件+VUE3</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1>一 前端项目初始化</h1>
<h2 id="1-1-客户端项目创建">1.1 客户端项目创建</h2>
<p>我们使用的vue-cli脚手架作为我们前端开发使用的框架，下面看一下vue-cli的安装。</p>
<p>安装脚手架：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g @vue/cli</span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line">$ yarn global add @vue/cli</span><br></pre></td></tr></table></figure>
<p>项目前端环境版本依赖</p>
<p><img src="assets/image-20220525%E4%B8%8A%E5%8D%88115212287-3450733.png" alt="image-20220525上午115212287"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node的版本：v14.16.0以上</span><br><span class="line">vue-cli需要的安装和运行需要借助到node.js的环境(换句话说也是js代码的解释器)</span><br><span class="line">vue：3版本</span><br><span class="line">@vue/cli 4.5.13</span><br></pre></td></tr></table></figure>
<h3 id="1-1-1-Node-js的安装">1.1.1 Node.js的安装</h3>
<p>Node.js是一个服务端语言，它的语法和JavaScript类似，所以可以说它是属于前端的后端语言，后端语言和前端语言的区别：</p>
<ul>
<li>
<p>运行环境：后端语言一般运行在服务器端，前端语言运行在客户端的浏览器上</p>
</li>
<li>
<p>功能：后端语言可以操作文件，可以读写数据库，前端语言不能操作文件，不能读写数据库。</p>
<p>我们一般安装LTS(长线支持版本)：</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://nodejs.org/en/download/%E3%80%90%E4%B8%8A%E9%9D%A2%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E4%BA%86nvm%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E9%87%8C%E4%B8%8D%E7%94%A8%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85%E4%BA%86%E3%80%91">https://nodejs.org/en/download/【上面已经安装了nvm，那么这里不用手动安装了】</a></p>
<p>下载之后双击安装，一路点击下一步就可以了。</p>
</li>
</ul>
<p>node.js的版本有两大分支：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">官方发布的node.js版本：0.xx.xx 这种版本号就是官方发布的版本</span><br><span class="line">社区发布的node.js版本：xx.xx.x  就是社区开发的版本</span><br></pre></td></tr></table></figure>
<p>Node.js如果安装成功，可以查看Node.js的版本,在终端输入如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v   #pip</span><br></pre></td></tr></table></figure>
<p>在安装node.js完成后，在node.js中会同时帮我们安装一个包管理器npm。我们可以借助npm命令来安装node.js的第三方包。这个工具相当于python的pip管理器，php的composer，go语言的go get，java的maven。</p>
<h3 id="1-1-2-npm">1.1.2 npm</h3>
<p>常用指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install -g 包名              # 安装模块   -g表示全局安装，如果没有-g，则表示在当前项目跟母下.node_modules下保存</span><br><span class="line">npm list                        # 查看当前目录下已安装的node包</span><br><span class="line">npm view 包名 engines            # 查看包所依赖的Node的版本 </span><br><span class="line">npm outdated                    # 检查包是否已经过时，命令会列出所有已过时的包</span><br><span class="line">npm update 包名                  # 更新node包</span><br><span class="line">npm uninstall 包名               # 卸载node包</span><br><span class="line">npm 命令 -h                      # 查看指定命令的帮助文档</span><br></pre></td></tr></table></figure>
<p>如果npm大家觉得速度比较慢，可以安装cnpm来进行国内包源的下载</p>
<h4 id="cnpm介绍">cnpm介绍</h4>
<ol>
<li>说明：因为谷歌安装插件是从国外服务器下载，受网络影响大，可能出现异常，如果谷歌的服务器在中国就好了，所以我们乐于分享的淘宝团队干了这事来自官网：“这是一个完整npmjs.org镜像，你可以用此代替官方版本（只读），同步频率目前为10分钟一次以保证尽量与官方服务同步“。</li>
<li>官方网址：<a target="_blank" rel="noopener" href="http://npm.taobao.org/">http://npm.taobao.org</a></li>
<li>安装：命令提示符执行<code>npm install cnpm -g --registry=https://registry.npm.taobao.org</code></li>
<li>注意：安装完后最好查看其版本cnpm -v或关闭命令提示符重新打开，安装完直接使用有可能会出现错误</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//临时使用</span><br><span class="line">npm install jquery --registry https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line">//可以把这个选型配置到文件中，这样不用每一次都很麻烦</span><br><span class="line">npm config set registry https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line">//验证是否配置成功 </span><br><span class="line">npm config list 或者 npm config get registry</span><br><span class="line"></span><br><span class="line">//安装cnpm，在任意目录下都可执行,--global是全局安装，不可省略</span><br><span class="line">npm install --global cnpm 或者 npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line">//安装后直接使用</span><br><span class="line">cnpm install jquery</span><br></pre></td></tr></table></figure>
<p>说明：NPM（节点包管理器）是的NodeJS的包管理器，用于节点插件管理（包括安装，卸载，管理依赖等）</p>
<blockquote>
<ol>
<li>使用NPM安装插件：命令提示符执行<code>npm install &lt;name&gt; [-g] [--save-dev]</code><br>
<code>&lt;name&gt;</code>：节点插件名称。<br>
例：<code>npm install gulp-less --save-dev</code></li>
<li><code>-g</code>：全局安装。 将会安装在C：\ Users \ Administrator \ AppData \ Roaming \ npm，并且写入系统环境变量;非全局安装：将会安装在当前定位目录;全局安装可以通过命令行任何地方调用它，本地安装将安装在定位目录的node_modules文件夹下，通过要求（）调用;</li>
<li><code>--save</code>：将保存至的package.json（的package.json是的NodeJS项目配置文件）</li>
<li><code>-dev</code>：保存至的package.json的devDependencies节点，不指定-dev将保存至依赖节点</li>
</ol>
</blockquote>
<p>为什么要保存至的的package.json？因为节点插件包相对来说非常庞大，所以不加入版本管理，将配置信息写入的package.json并将其加入版本管理，其他开发者对应下载即可（命令提示符执行npm install，则会根据package.json下载所有需要的包）</p>
<h3 id="1-1-3-vue-cli创建项目">1.1.3  vue-cli创建项目</h3>
<h4 id="创建项目">创建项目</h4>
<pre><code>使用vue自动化工具可以快速搭建单页应用项目目录。

该工具为现代化的前端开发工作流提供了开箱即用的构建配置。只需几分钟即可创建并启动一个带热重载、保存时静态检查以及可用于生产环境的构建配置的项目：
</code></pre>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vue create uric_web</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动开发服务器 ctrl+c 停止服务</span></span><br><span class="line">cd uric_web</span><br><span class="line">npm run serve           <span class="comment">// 运行这个命令就可以启动node提供的测试http服务器</span></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8A%E5%8D%88115358990-3450841.png" alt="image-20220525上午115358990"></p>
<p><img src="assets/image-20220525%E4%B8%8A%E5%8D%88115430157-3450872.png" alt="image-20220525上午115430157"></p>
<p><img src="assets/image-20220525%E4%B8%8A%E5%8D%88115523518-3450924.png" alt="image-20220525上午115523518"></p>
<p><img src="assets/image-20220525%E4%B8%8A%E5%8D%88115622757-3450984.png" alt="image-20220525上午115622757"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 那么访问一下命令执行完成后提示出来的网址就可以看到网站了：http://localhost:8080/</span></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8A%E5%8D%88115725344-3451046.png" alt="image-20220525上午115725344"></p>
<p>项目创建完成之后，我们会看到urilsweb项目其实是一个文件夹，我们进入到文件夹内部就会发现一些目录和文件，我们简单介绍一下它们都是干什么的</p>
<h4 id="项目目录结构介绍">项目目录结构介绍</h4>
<p>核心文件和目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">src/         主开发目录，要开发的客户端代码文件（单文件组件，样式、工具函数等等）全部在这个目录下</span><br><span class="line"></span><br><span class="line">static/      静态资源目录，项目中的静态资源(css，js，图片等文件)放在这个文件夹</span><br><span class="line"></span><br><span class="line">dist/        项目打包发布文件夹，目前没有这个文件夹，最后要上线单文件项目文件都在这个文件夹中	</span><br><span class="line">		    后面使用npm build 打包项目，让项目中的vue组件经过编译变成js 代码以后,dist就出现了</span><br><span class="line"></span><br><span class="line">node_modules/     node的包目录，项目运行的依赖包存储目录，</span><br><span class="line">                  package.json和package-lock.json文件中会自动记录了这个目录下所有的包以及包的版本信息，</span><br><span class="line">                  如果node_modules没有，但是有package.json，则可以在终端下，通过npm install进行恢复。</span><br><span class="line"></span><br><span class="line">config/      配置目录，是环境配置目录与项目无关。</span><br><span class="line"></span><br><span class="line">build/       项目打包时依赖的目录</span><br><span class="line"></span><br><span class="line">src/router/  路由，是我们创建项目的时候，如果选择安装vue-router，就自动会生成这个目录。</span><br><span class="line">src/assets/  静态资源存储目录，与static目录作用类似。</span><br><span class="line">src/components/  组件存储目录，就是浏览器中用户看到的页面的一部分内容。</span><br><span class="line">src/views/       组件存储目录，就是浏览器中用户看到的页面内容，views往往会加载并包含components中的组件进来</span><br></pre></td></tr></table></figure>
<p>目录结构详细介绍</p>
<p><img src="assets/image-20210907100137864-16309801001818.png" alt="image-20210907100137864"></p>
<h4 id="项目执行流程图">项目执行流程图</h4>
<p><img src="assets/1625305034687.png" alt="1625305034687"></p>
<h3 id="1-1-4-展示中心组件">1.1.4 展示中心组件</h3>
<p>src/main.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>src/App.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-view</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#app</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">font-family</span>: Avenir, Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="language-css">  -webkit-<span class="attribute">font-smoothing</span>: antialiased;</span></span><br><span class="line"><span class="language-css">  -moz-osx-<span class="attribute">font-smoothing</span>: grayscale;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#2c3e50</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#nav</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">padding</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#nav</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#2c3e50</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#nav</span> <span class="selector-tag">a</span><span class="selector-class">.router-link-exact-active</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#42b983</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>router/index.js，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ShowCenter</span> <span class="keyword">from</span> <span class="string">&#x27;../views/ShowCenter.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;ShowCenter&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ShowCenter</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>views/ShowCenter.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;showcenter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>show center<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;ShowCenter&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8080</a>  就看到了我们的展示中心页面。</p>
<h3 id="1-1-5-调整配置">1.1.5 调整配置</h3>
<p>为了方便开发，我们做一些配置调整</p>
<p>Vue.config.js是一个可选的配置文件，如果项目的根目录存在这个文件，那么它就会被 <code>@vue/cli-service</code> 自动加载。你也可以使用package.json中的vue字段，但要注意严格遵守JSON的格式来写。这里使用配置vue.config.js的方式进行处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;defineConfig&#125; = <span class="built_in">require</span>(<span class="string">&#x27;@vue/cli-service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">transpileDependencies</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">devServer</span>: &#123;</span><br><span class="line">        <span class="attr">host</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">        <span class="comment">/* 本地ip地址 */</span></span><br><span class="line">        <span class="comment">//host: &quot;192.168.0.131&quot;,</span></span><br><span class="line">        <span class="comment">// host: &quot;www.uric.cn&quot;, //局域网和本地访问</span></span><br><span class="line">        <span class="attr">port</span>: <span class="string">&quot;8000&quot;</span>,</span><br><span class="line">        <span class="comment">// hot: true,</span></span><br><span class="line">        <span class="comment">/* 自动打开浏览器 */</span></span><br><span class="line">        <span class="comment">// open: false,</span></span><br><span class="line">        <span class="comment">/*overlay: &#123;</span></span><br><span class="line"><span class="comment">            warning: false,</span></span><br><span class="line"><span class="comment">            error: true</span></span><br><span class="line"><span class="comment">        &#125;,*/</span></span><br><span class="line">        <span class="comment">/* 跨域代理 */</span></span><br><span class="line">        <span class="comment">/*proxy: &#123;</span></span><br><span class="line"><span class="comment">            &quot;/api&quot;: &#123;</span></span><br><span class="line"><span class="comment">                /!* 目标代理服务器地址 *!/</span></span><br><span class="line"><span class="comment">                target: &quot;http://xxxx.top&quot;, //</span></span><br><span class="line"><span class="comment">                /!* 允许跨域 *!/</span></span><br><span class="line"><span class="comment">                changeOrigin: true,</span></span><br><span class="line"><span class="comment">                ws: true,</span></span><br><span class="line"><span class="comment">                pathRewrite: &#123;</span></span><br><span class="line"><span class="comment">                    &quot;^/api&quot;: &quot;&quot;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们现在为前端和后端分别设置两个不同的域名：</p>
<table>
<thead>
<tr>
<th>位置</th>
<th>域名</th>
</tr>
</thead>
<tbody>
<tr>
<td>前端</td>
<td><code>www.uric.cn</code></td>
</tr>
<tr>
<td>后端</td>
<td><code>api.uric.cn</code></td>
</tr>
</tbody>
</table>
<p>Linux/mac系统下执行指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">windows下是C:/windows/system32/drivers/etc/hosts</span></span><br></pre></td></tr></table></figure>
<p>加上如下内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost</span><br><span class="line">127.0.0.1   api.uric.cn</span><br><span class="line">127.0.0.1   www.uric.cn</span><br></pre></td></tr></table></figure>
<p>部分使用windows开发的同学，如果hosts修改保存不了，可以复制这个文件到桌面，修改完成以后，在粘贴到对应目录下。</p>
<p><img src="assets/image-20220625103718596-6124639.png" alt="image-20220625103718596"></p>
<p>在开发过程中，我们可能经常会在前端项目的业务里面使用到某些变量，我们可以添加到配置文件中，比如我们在src目录下创建一个settings.js文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123; <span class="comment">// 注意，对象要抛出后，其他文件中才能引入使用</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;http://api.urils.cn:8000&#x27;</span> <span class="comment">// 我们的后台项目将来就通过这个域名和端口来启动</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了方便后面其他页面组件使用settings中的配置变量，我们在main.js文件中引入封装成vue对象的全局属性.</p>
<p>main.js，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createApp&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> settings <span class="keyword">from</span> <span class="string">&quot;@/settings&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$settings</span> = settings;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-6-安装axios">1.1.6 安装axios</h3>
<p>后面我们需要在前端来获取后端的数据，意味着要发送请求，我们使用axios模块来进行http请求的发送，</p>
<p>它的特点和ajax一样：异步请求。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">项目根目录下执行如下指令</span><br><span class="line">npm install -S axios --registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p><code>ShowCenter</code>组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;showcenter&quot;&gt;</span><br><span class="line">    &lt;h1&gt;show center&lt;/h1&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;ShowCenter&#x27;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log(this.$settings.host)</span><br><span class="line">    axios.get(&#x27;http://wthrcdn.etouch.cn/weather_mini?city=北京&#x27;)</span><br><span class="line">        .then((response) =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response.data.data.forecast)</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8B%E5%8D%8815735710-3458256.png" alt="image-20220525下午15735710"></p>
<p>接下来我们将展示中心页面写的好看一些。</p>
<p>我们当前前端项目使用的用于展示界面的前端插件是Ant Design，能够帮我们快速优雅的完成前端页面效果，下面介绍一下。</p>
<h2 id="1-2-ant-design插件">1.2 ant-design插件</h2>
<h3 id="介绍">介绍</h3>
<pre><code>Ant Design 是一个致力于提升『用户』和『设计者』使用体验的中台设计语言。它模糊了产品经理、交互设计师、视觉设计师、前端工程师、开发工程师等角色边界，将进行 UE 设计和 UI 设计人员统称为『设计者』，利用统一的规范进行设计赋能，全面提高中台产品体验和研发效率，是蚂蚁金服出品的开源框架。

Ant Design 官方介绍： &quot;在中台产品的研发过程中，会出现不同的设计规范和实现方式，但其中往往存在很多类似的页面和组件，给设计师和工程师带来很多困扰和重复建设，大大降低了产品的研发效率。&quot;

蚂蚁金服体验技术部经过大量的项目实践和总结，沉淀出设计语言 Ant Design，这可不单纯只是设计原则、控件规范和视觉尺寸，还配套有前端代码实现方案。也就是说采用Ant Design后，UI设计和前端界面研发可同步完成，效率大大提升。目前有阿里、美团、滴滴、简书采用。Ant Design有Web版和Moblie版。

如果前端这些插件都是我们通过js或者jquery手撸的话，工作量太重不说，效率还低。

Ant Design 则封装了一系列高质量的 React 组件，十分适用于在企业级的应用中，框架提供的 api 十分详尽，上手和使用相对简单，值得一提的是， Ant Design 使用 ES6 进行编写，因此使用过程中对 ES6 也是一次学习的机会。

我们现在学习的是vue框架和ant-desigin的兼容，那么已经有高手开源出了一套ant-design的vue实现，下面我们就来学习使用。
</code></pre>
<p>ant-desigin特点</p>
<ul>
<li>专为Web应用程序设计的企业级UI。</li>
<li>开箱即用的一组高质量React组件。</li>
<li>用具有可预测的静态类型的TypeScript编写。</li>
<li>整套设计资源和开发工具。</li>
<li>支持数十种语言的国际化。</li>
<li>强大的主题自定义细节。</li>
</ul>
<h3 id="常用网址">常用网址</h3>
<p>官网：<a target="_blank" rel="noopener" href="https://ant.design/%EF%BC%8Cantdv%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%8C%E5%85%A8%E7%A7%B0">https://ant.design/，antdv工具的使用，全称</a> Ant Design of Vue。</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://next.antdv.com/docs/vue/getting-started-cn">https://next.antdv.com/docs/vue/getting-started-cn</a></p>
<p>Ant Design of Vue的使用，我们在项目中学习。</p>
<h3 id="安装上手">安装上手</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i --save ant-design-vue@next</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：package.json中的<code>&quot;ant-design-vue&quot;: &quot;^3.2.7&quot;</code>,一定是3以上版本</p>
</blockquote>
<p>在main.js文件中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createApp&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Antd</span> <span class="keyword">from</span> <span class="string">&#x27;ant-design-vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;ant-design-vue/dist/antd.css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./settings&#x27;</span></span><br><span class="line"><span class="keyword">import</span> settings <span class="keyword">from</span> <span class="string">&quot;@/settings&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="title function_">use</span>(router).<span class="title function_">use</span>(<span class="title class_">Antd</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$settings</span> = settings;</span><br></pre></td></tr></table></figure>
<p>下面测试一下效果，我们在ShowCenter.vue组件中引入一个ant-design的button按钮，看看怎么样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;showcenter&quot;&gt;</span><br><span class="line">    &lt;h1&gt;show center&lt;/h1&gt;</span><br><span class="line">    &lt;a-button type=&quot;primary&quot;&gt;Primary&lt;/a-button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;ShowCenter&#x27;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log(this.$settings.host)</span><br><span class="line">    axios.get(&#x27;http://wthrcdn.etouch.cn/weather_mini?city=北京&#x27;)</span><br><span class="line">        .then((response) =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response.data.data.forecast)</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>好，效果有了。</p>
<p><img src="assets/image-20220525%E4%B8%8B%E5%8D%8820217438.png" alt="image-20220525下午20217438"></p>
<h3 id="中文支持">中文支持</h3>
<p>ShowCenter.vue展示中文日历，没有配置之前：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;showcenter&quot;&gt;</span><br><span class="line">    &lt;h1&gt;show center&lt;/h1&gt;</span><br><span class="line">    &lt;a-button type=&quot;primary&quot;&gt;Primary&lt;/a-button&gt;</span><br><span class="line">    &lt;div :style=&quot;&#123; width: &#x27;300px&#x27;, border: &#x27;1px solid #d9d9d9&#x27;, borderRadius: &#x27;4px&#x27; &#125;&quot;&gt;</span><br><span class="line">      &lt;a-calendar v-model:value=&quot;value&quot; :fullscreen=&quot;false&quot; @panelChange=&quot;onPanelChange&quot;/&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;ShowCenter&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const value = ref();</span><br><span class="line"></span><br><span class="line">    const onPanelChange = (value, mode) =&gt; &#123;</span><br><span class="line">      console.log(value, mode);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      value,</span><br><span class="line">      onPanelChange,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log(this.$settings.host)</span><br><span class="line">    axios.get(&#x27;http://wthrcdn.etouch.cn/weather_mini?city=北京&#x27;)</span><br><span class="line">        .then((response) =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response.data.data.forecast)</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>ant-design-vue</code> 目前的默认文案是英文。在使用某些插件(比如时间日期选择框等)的时候，需要我们来做中文支持，设置如下。</p>
<p>src/App.vue，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-config-provider :locale=&quot;locale&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;showcenter&quot;&gt;</span><br><span class="line">      &lt;h1&gt;show center&lt;/h1&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot;&gt;Primary&lt;/a-button&gt;</span><br><span class="line">      &lt;div :style=&quot;&#123; width: &#x27;300px&#x27;, border: &#x27;1px solid #d9d9d9&#x27;, borderRadius: &#x27;4px&#x27; &#125;&quot;&gt;</span><br><span class="line">        &lt;a-calendar v-model:value=&quot;value&quot; :fullscreen=&quot;false&quot; @panelChange=&quot;onPanelChange&quot;/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/a-config-provider&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">import zhCN from &#x27;ant-design-vue/es/locale/zh_CN&#x27;;</span><br><span class="line">import dayjs from &#x27;dayjs&#x27;;</span><br><span class="line">import &#x27;dayjs/locale/zh-cn&#x27;;</span><br><span class="line"></span><br><span class="line">dayjs.locale(&#x27;zh-cn&#x27;);</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;ShowCenter&#x27;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      locale: zhCN,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const value = ref();</span><br><span class="line"></span><br><span class="line">    const onPanelChange = (value, mode) =&gt; &#123;</span><br><span class="line">      console.log(value, mode);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      value,</span><br><span class="line">      onPanelChange,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log(this.$settings.host)</span><br><span class="line">    axios.get(&#x27;http://wthrcdn.etouch.cn/weather_mini?city=北京&#x27;)</span><br><span class="line">        .then((response) =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response.data.data.forecast)</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要安装一个包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install dayjs</span><br></pre></td></tr></table></figure>
<h3 id="echarts图表插件">echarts图表插件</h3>
<p>由于我们有很多的图表数据展示，而Ant-desigin中没有很优秀的图表插件，所以我们还需要借助其他开源插件，比如echarts和hcharts，我们本次采用的是百度开源的echarts，那么我们如何引入使用呢，看下面的步骤。</p>
<p><a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">Echarts官方</a></p>
<p>下载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install echarts --save --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p>为了方便后面组件的使用，我们在src/main.js中引入一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import echarts from &#x27;echarts&#x27;</span></span><br><span class="line"><span class="keyword">let</span> echarts = <span class="built_in">require</span>(<span class="string">&#x27;echarts&#x27;</span>)</span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$echarts</span> = echarts</span><br></pre></td></tr></table></figure>
<p>在ShowCenter.vue组件中简单使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;show center&lt;/h1&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-button type=&quot;primary&quot;&gt;Primary&lt;/a-button&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;a-config-provider :locale=&quot;locale&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;showcenter&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;calendar&quot; :style=&quot;&#123; width: &#x27;400px&#x27;, border: &#x27;1px solid #d9d9d9&#x27;, borderRadius: &#x27;4px&#x27;&#125;&quot;&gt;</span><br><span class="line">        &lt;a-calendar v-model:value=&quot;value&quot; :fullscreen=&quot;false&quot; @panelChange=&quot;onPanelChange&quot;/&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;chart&quot; ref=&quot;chart&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/a-config-provider&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">import zhCN from &#x27;ant-design-vue/es/locale/zh_CN&#x27;;</span><br><span class="line">import dayjs from &#x27;dayjs&#x27;;</span><br><span class="line">import &#x27;dayjs/locale/zh-cn&#x27;;</span><br><span class="line"></span><br><span class="line">dayjs.locale(&#x27;zh-cn&#x27;);</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;ShowCenter&#x27;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      locale: zhCN,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    init_chart() &#123;</span><br><span class="line">      // 基于准备好的dom，初始化echarts实例</span><br><span class="line">      let myChart = this.$echarts.init(this.$refs.chart)</span><br><span class="line">      // 绘制图表</span><br><span class="line">      let option = &#123;</span><br><span class="line">        tooltip: &#123;</span><br><span class="line">          trigger: &#x27;axis&#x27;,</span><br><span class="line">          axisPointer: &#123;</span><br><span class="line">            // Use axis to trigger tooltip</span><br><span class="line">            type: &#x27;shadow&#x27; // &#x27;shadow&#x27; as default; can also be &#x27;line&#x27; or &#x27;shadow&#x27;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        legend: &#123;&#125;,</span><br><span class="line">        grid: &#123;</span><br><span class="line">          left: &#x27;3%&#x27;,</span><br><span class="line">          right: &#x27;4%&#x27;,</span><br><span class="line">          bottom: &#x27;3%&#x27;,</span><br><span class="line">          containLabel: true</span><br><span class="line">        &#125;,</span><br><span class="line">        xAxis: &#123;</span><br><span class="line">          type: &#x27;value&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        yAxis: &#123;</span><br><span class="line">          type: &#x27;category&#x27;,</span><br><span class="line">          data: [&#x27;Mon&#x27;, &#x27;Tue&#x27;, &#x27;Wed&#x27;, &#x27;Thu&#x27;, &#x27;Fri&#x27;, &#x27;Sat&#x27;, &#x27;Sun&#x27;]</span><br><span class="line">        &#125;,</span><br><span class="line">        series: [</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;Direct&#x27;,</span><br><span class="line">            type: &#x27;bar&#x27;,</span><br><span class="line">            stack: &#x27;total&#x27;,</span><br><span class="line">            label: &#123;</span><br><span class="line">              show: true</span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">              focus: &#x27;series&#x27;</span><br><span class="line">            &#125;,</span><br><span class="line">            data: [320, 302, 301, 334, 390, 330, 320]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;Mail Ad&#x27;,</span><br><span class="line">            type: &#x27;bar&#x27;,</span><br><span class="line">            stack: &#x27;total&#x27;,</span><br><span class="line">            label: &#123;</span><br><span class="line">              show: true</span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">              focus: &#x27;series&#x27;</span><br><span class="line">            &#125;,</span><br><span class="line">            data: [120, 132, 101, 134, 90, 230, 210]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;Affiliate Ad&#x27;,</span><br><span class="line">            type: &#x27;bar&#x27;,</span><br><span class="line">            stack: &#x27;total&#x27;,</span><br><span class="line">            label: &#123;</span><br><span class="line">              show: true</span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">              focus: &#x27;series&#x27;</span><br><span class="line">            &#125;,</span><br><span class="line">            data: [220, 182, 191, 234, 290, 330, 310]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;Video Ad&#x27;,</span><br><span class="line">            type: &#x27;bar&#x27;,</span><br><span class="line">            stack: &#x27;total&#x27;,</span><br><span class="line">            label: &#123;</span><br><span class="line">              show: true</span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">              focus: &#x27;series&#x27;</span><br><span class="line">            &#125;,</span><br><span class="line">            data: [150, 212, 201, 154, 190, 330, 410]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;Search Engine&#x27;,</span><br><span class="line">            type: &#x27;bar&#x27;,</span><br><span class="line">            stack: &#x27;total&#x27;,</span><br><span class="line">            label: &#123;</span><br><span class="line">              show: true</span><br><span class="line">            &#125;,</span><br><span class="line">            emphasis: &#123;</span><br><span class="line">              focus: &#x27;series&#x27;</span><br><span class="line">            &#125;,</span><br><span class="line">            data: [820, 832, 901, 934, 1290, 1330, 1320]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;;</span><br><span class="line">      myChart.setOption(option);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const value = ref();</span><br><span class="line"></span><br><span class="line">    const onPanelChange = (value, mode) =&gt; &#123;</span><br><span class="line">      console.log(value, mode);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      value,</span><br><span class="line">      onPanelChange,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line"></span><br><span class="line">    console.log(this.$settings.host)</span><br><span class="line">    axios.get(&#x27;http://wthrcdn.etouch.cn/weather_mini?city=北京&#x27;)</span><br><span class="line">        .then((response) =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response.data.data.forecast)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    this.init_chart();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.calendar, .chart &#123;</span><br><span class="line">  width: 500px;</span><br><span class="line">  height: 500px;</span><br><span class="line">  float: left;</span><br><span class="line">  margin: 0 auto 0 100px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8B%E5%8D%8821612483-3459375.png" alt="image-20220525下午21612483"></p>
<p>改进组合API：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;show center&lt;/h1&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-button type=&quot;primary&quot;&gt;Primary&lt;/a-button&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;div class=&quot;chart&quot; ref=&quot;chart&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;chart2&quot; ref=&quot;chart2&quot;&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import &#123;onMounted, ref&#125; from &quot;vue&quot;;</span><br><span class="line">import zhCN from &#x27;ant-design-vue/es/locale/zh_CN&#x27;;</span><br><span class="line">import dayjs from &#x27;dayjs&#x27;;</span><br><span class="line">import &#x27;dayjs/locale/zh-cn&#x27;;</span><br><span class="line">import * as echarts from &#x27;echarts&#x27;;</span><br><span class="line"></span><br><span class="line">dayjs.locale(&#x27;zh-cn&#x27;);</span><br><span class="line">const locale = zhCN</span><br><span class="line"></span><br><span class="line">// (1)</span><br><span class="line">const value = ref();</span><br><span class="line">const onPanelChange = (value, mode) =&gt; &#123;</span><br><span class="line">  console.log(value, mode);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// (2)</span><br><span class="line">let init_chart = () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  var myChart = echarts.init(chart.value);</span><br><span class="line">  var option;</span><br><span class="line">  // 绘制图表</span><br><span class="line">  option = &#123;</span><br><span class="line">    tooltip: &#123;</span><br><span class="line">      trigger: &#x27;axis&#x27;,</span><br><span class="line">      axisPointer: &#123;</span><br><span class="line">        // Use axis to trigger tooltip</span><br><span class="line">        type: &#x27;shadow&#x27; // &#x27;shadow&#x27; as default; can also be &#x27;line&#x27; or &#x27;shadow&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    legend: &#123;&#125;,</span><br><span class="line">    grid: &#123;</span><br><span class="line">      left: &#x27;3%&#x27;,</span><br><span class="line">      right: &#x27;4%&#x27;,</span><br><span class="line">      bottom: &#x27;3%&#x27;,</span><br><span class="line">      containLabel: true</span><br><span class="line">    &#125;,</span><br><span class="line">    xAxis: &#123;</span><br><span class="line">      type: &#x27;value&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    yAxis: &#123;</span><br><span class="line">      type: &#x27;category&#x27;,</span><br><span class="line">      data: [&#x27;Mon&#x27;, &#x27;Tue&#x27;, &#x27;Wed&#x27;, &#x27;Thu&#x27;, &#x27;Fri&#x27;, &#x27;Sat&#x27;, &#x27;Sun&#x27;]</span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Direct&#x27;,</span><br><span class="line">        type: &#x27;bar&#x27;,</span><br><span class="line">        stack: &#x27;total&#x27;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: true</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          focus: &#x27;series&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        data: [320, 302, 301, 334, 390, 330, 320]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Mail Ad&#x27;,</span><br><span class="line">        type: &#x27;bar&#x27;,</span><br><span class="line">        stack: &#x27;total&#x27;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: true</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          focus: &#x27;series&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        data: [120, 132, 101, 134, 90, 230, 210]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Affiliate Ad&#x27;,</span><br><span class="line">        type: &#x27;bar&#x27;,</span><br><span class="line">        stack: &#x27;total&#x27;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: true</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          focus: &#x27;series&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        data: [220, 182, 191, 234, 290, 330, 310]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Video Ad&#x27;,</span><br><span class="line">        type: &#x27;bar&#x27;,</span><br><span class="line">        stack: &#x27;total&#x27;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: true</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          focus: &#x27;series&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        data: [150, 212, 201, 154, 190, 330, 410]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Search Engine&#x27;,</span><br><span class="line">        type: &#x27;bar&#x27;,</span><br><span class="line">        stack: &#x27;total&#x27;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: true</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          focus: &#x27;series&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        data: [820, 832, 901, 934, 1290, 1330, 1320]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br><span class="line">  option &amp;&amp; myChart.setOption(option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const chart = ref();</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  init_chart()</span><br><span class="line">  init_chart2()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// (3)</span><br><span class="line"></span><br><span class="line">const chart2 = ref();</span><br><span class="line"></span><br><span class="line">let init_chart2 = () =&gt; &#123;</span><br><span class="line">  console.log(chart2.value)</span><br><span class="line">  var myChart = echarts.init(chart2.value);</span><br><span class="line">  var option;</span><br><span class="line">  option = &#123;</span><br><span class="line">    tooltip: &#123;</span><br><span class="line">      trigger: &#x27;item&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    legend: &#123;</span><br><span class="line">      top: &#x27;5%&#x27;,</span><br><span class="line">      left: &#x27;center&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Access From&#x27;,</span><br><span class="line">        type: &#x27;pie&#x27;,</span><br><span class="line">        radius: [&#x27;40%&#x27;, &#x27;70%&#x27;],</span><br><span class="line">        avoidLabelOverlap: false,</span><br><span class="line">        itemStyle: &#123;</span><br><span class="line">          borderRadius: 10,</span><br><span class="line">          borderColor: &#x27;#fff&#x27;,</span><br><span class="line">          borderWidth: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: false,</span><br><span class="line">          position: &#x27;center&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          label: &#123;</span><br><span class="line">            show: true,</span><br><span class="line">            fontSize: &#x27;40&#x27;,</span><br><span class="line">            fontWeight: &#x27;bold&#x27;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        labelLine: &#123;</span><br><span class="line">          show: false</span><br><span class="line">        &#125;,</span><br><span class="line">        data: [</span><br><span class="line">          &#123;value: 1048, name: &#x27;Search Engine&#x27;&#125;,</span><br><span class="line">          &#123;value: 735, name: &#x27;Direct&#x27;&#125;,</span><br><span class="line">          &#123;value: 580, name: &#x27;Email&#x27;&#125;,</span><br><span class="line">          &#123;value: 484, name: &#x27;Union Ads&#x27;&#125;,</span><br><span class="line">          &#123;value: 300, name: &#x27;Video Ads&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  option &amp;&amp; myChart.setOption(option);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.chart, .chart2 &#123;</span><br><span class="line">  width: 500px;</span><br><span class="line">  height: 500px;</span><br><span class="line">  float: left;</span><br><span class="line">  margin: 0 auto 0 100px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><img src="assets/%E6%88%AA%E5%B1%8F2022-06-21%2020.31.34.png" alt="截屏2022-06-21 20.31.34"></p>
<p>好，到此前端项目初始化完成。</p>
<h2 id="1-3-组件初始化">1.3 组件初始化</h2>
<h3 id="登录组件初始化">登录组件初始化</h3>
<p>views/Login.vue，代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;login box&quot;&gt;</span><br><span class="line">    &lt;img src=&quot;../assets/login.jpg&quot; alt=&quot;&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;login-title&quot;&gt;</span><br><span class="line">        &lt;p class=&quot;hi&quot;&gt;Hello,Urils!&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;login_box&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;title&quot;&gt;</span><br><span class="line">          &lt;span&gt;登录&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;inp&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;username&quot; type=&quot;text&quot; placeholder=&quot;用户名&quot; class=&quot;user&quot;&gt;&lt;/a-input&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;password&quot; type=&quot;password&quot; class=&quot;pwd&quot; placeholder=&quot;密码&quot;&gt;&lt;/a-input&gt;</span><br><span class="line">          &lt;div class=&quot;rember&quot;&gt;</span><br><span class="line">            &lt;p&gt;</span><br><span class="line">              &lt;input type=&quot;checkbox&quot; class=&quot;no&quot; v-model=&quot;remember&quot;/&gt;</span><br><span class="line">              &lt;span&gt;记住密码&lt;/span&gt;</span><br><span class="line">            &lt;/p&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;button class=&quot;login_btn&quot; @click=&quot;login&quot;&gt;登录&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;Login&#x27;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      username: &#x27;&#x27;,</span><br><span class="line">      password: &#x27;&#x27;,</span><br><span class="line">      remember: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    login() &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.login .hi&#123;</span><br><span class="line">  font-size: 20px;</span><br><span class="line">  font-family: &quot;Times New Roman&quot;;</span><br><span class="line">  font-style: italic;</span><br><span class="line">&#125;</span><br><span class="line">.box &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 100%;</span><br><span class="line">  position: relative;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.box img &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  min-height: 100%;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.box .login &#123;</span><br><span class="line">  position: absolute;</span><br><span class="line">  width: 500px;</span><br><span class="line">  height: 400px;</span><br><span class="line">  left: 0;</span><br><span class="line">  margin: auto;</span><br><span class="line">  right: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  top: -338px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login .login-title &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login-title img &#123;</span><br><span class="line">  width: 190px;</span><br><span class="line">  height: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login-title p &#123;</span><br><span class="line">  font-size: 18px;</span><br><span class="line">  color: #fff;</span><br><span class="line">  letter-spacing: .29px;</span><br><span class="line">  padding-top: 10px;</span><br><span class="line">  padding-bottom: 50px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login_box &#123;</span><br><span class="line">  width: 400px;</span><br><span class="line">  height: auto;</span><br><span class="line">  background: rgba(255, 255, 255, 0.3);</span><br><span class="line">  box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .5);</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">  margin: 0 auto;</span><br><span class="line">  padding-bottom: 40px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login_box .title &#123;</span><br><span class="line">  font-size: 20px;</span><br><span class="line">  color: #9b9b9b;</span><br><span class="line">  letter-spacing: .32px;</span><br><span class="line">  border-bottom: 1px solid #e6e6e6;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-around;</span><br><span class="line">  padding: 50px 60px 0 60px;</span><br><span class="line">  margin-bottom: 20px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login_box .title span:nth-of-type(1) &#123;</span><br><span class="line">  color: #4a4a4a;</span><br><span class="line">  border-bottom: 2px solid #396fcc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp &#123;</span><br><span class="line">  width: 350px;</span><br><span class="line">  margin: 0 auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp input &#123;</span><br><span class="line">  outline: 0;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 45px;</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">  border: 1px solid #d9d9d9;</span><br><span class="line">  text-indent: 20px;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  background: #fff !important;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp input.user &#123;</span><br><span class="line">  margin-bottom: 16px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .rember &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  align-items: center;</span><br><span class="line">  position: relative;</span><br><span class="line">  margin-top: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .rember p:first-of-type &#123;</span><br><span class="line">  font-size: 12px;</span><br><span class="line">  color: #4a4a4a;</span><br><span class="line">  letter-spacing: .19px;</span><br><span class="line">  margin-left: 22px;</span><br><span class="line">  display: -ms-flexbox;</span><br><span class="line">  display: flex;</span><br><span class="line">  -ms-flex-align: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">  /*position: relative;*/</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .rember p:nth-of-type(2) &#123;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  color: #9b9b9b;</span><br><span class="line">  letter-spacing: .19px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .rember input &#123;</span><br><span class="line">  outline: 0;</span><br><span class="line">  width: 30px;</span><br><span class="line">  height: 45px;</span><br><span class="line">  border-radius: 4px;</span><br><span class="line">  border: 1px solid #d9d9d9;</span><br><span class="line">  text-indent: 20px;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  background: #fff !important;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .rember p span &#123;</span><br><span class="line">  display: inline-block;</span><br><span class="line">  font-size: 12px;</span><br><span class="line">  width: 100px;</span><br><span class="line">  /*position: absolute;*/</span><br><span class="line">  /*left: 20px;*/</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#geetest &#123;</span><br><span class="line">  margin-top: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login_btn &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 45px;</span><br><span class="line">  background: #396fcc;</span><br><span class="line">  border-radius: 5px;</span><br><span class="line">  font-size: 16px;</span><br><span class="line">  color: #fff;</span><br><span class="line">  letter-spacing: .26px;</span><br><span class="line">  margin-top: 30px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .go_login &#123;</span><br><span class="line">  text-align: center;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  color: #9b9b9b;</span><br><span class="line">  letter-spacing: .26px;</span><br><span class="line">  padding-top: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.inp .go_login span &#123;</span><br><span class="line">  color: #84cc39;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>src/router/index.js，代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ShowCenter</span> <span class="keyword">from</span> <span class="string">&#x27;../views/ShowCenter.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Login.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;ShowCenter&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ShowCenter</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Login</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8B%E5%8D%8861821365-3473903.png" alt="image-20220525下午61821365"></p>
<p>由于除了登录页面之外我们后面所有的组件都具备顶部导航栏和左侧菜单栏的效果，所以我直接将共有效果放到了一个Base.vue组件中。里面通过 ant design vue中的</p>
<p>布局组件：<a target="_blank" rel="noopener" href="https://next.antdv.com/components/layout-cn">https://next.antdv.com/components/layout-cn</a></p>
<h3 id="Base组件初始化">Base组件初始化</h3>
<p>布局和导航菜单搭建App页面效果，简单如下</p>
<p>views/Base.vue，代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout style=&quot;min-height: 100vh&quot;&gt;</span><br><span class="line">    &lt;a-layout-sider v-model:collapsed=&quot;collapsed&quot; collapsible&gt;</span><br><span class="line">      &lt;div class=&quot;logo&quot; /&gt;</span><br><span class="line">      &lt;a-menu v-model:selectedKeys=&quot;selectedKeys&quot; theme=&quot;dark&quot; mode=&quot;inline&quot;&gt;</span><br><span class="line">        &lt;a-menu-item key=&quot;1&quot;&gt;</span><br><span class="line">          &lt;pie-chart-outlined /&gt;</span><br><span class="line">          &lt;span&gt;Option 1&lt;/span&gt;</span><br><span class="line">        &lt;/a-menu-item&gt;</span><br><span class="line">        &lt;a-menu-item key=&quot;2&quot;&gt;</span><br><span class="line">          &lt;desktop-outlined /&gt;</span><br><span class="line">          &lt;span&gt;Option 2&lt;/span&gt;</span><br><span class="line">        &lt;/a-menu-item&gt;</span><br><span class="line">        &lt;a-sub-menu key=&quot;sub1&quot;&gt;</span><br><span class="line">          &lt;template #title&gt;</span><br><span class="line">            &lt;span&gt;</span><br><span class="line">              &lt;user-outlined /&gt;</span><br><span class="line">              &lt;span&gt;User&lt;/span&gt;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">          &lt;/template&gt;</span><br><span class="line">          &lt;a-menu-item key=&quot;3&quot;&gt;Tom&lt;/a-menu-item&gt;</span><br><span class="line">          &lt;a-menu-item key=&quot;4&quot;&gt;Bill&lt;/a-menu-item&gt;</span><br><span class="line">          &lt;a-menu-item key=&quot;5&quot;&gt;Alex&lt;/a-menu-item&gt;</span><br><span class="line">        &lt;/a-sub-menu&gt;</span><br><span class="line">        &lt;a-sub-menu key=&quot;sub2&quot;&gt;</span><br><span class="line">          &lt;template #title&gt;</span><br><span class="line">            &lt;span&gt;</span><br><span class="line">              &lt;team-outlined /&gt;</span><br><span class="line">              &lt;span&gt;Team&lt;/span&gt;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">          &lt;/template&gt;</span><br><span class="line">          &lt;a-menu-item key=&quot;6&quot;&gt;Team 1&lt;/a-menu-item&gt;</span><br><span class="line">          &lt;a-menu-item key=&quot;8&quot;&gt;Team 2&lt;/a-menu-item&gt;</span><br><span class="line">        &lt;/a-sub-menu&gt;</span><br><span class="line">        &lt;a-menu-item key=&quot;9&quot;&gt;</span><br><span class="line">          &lt;file-outlined /&gt;</span><br><span class="line">          &lt;span&gt;File&lt;/span&gt;</span><br><span class="line">        &lt;/a-menu-item&gt;</span><br><span class="line">      &lt;/a-menu&gt;</span><br><span class="line">    &lt;/a-layout-sider&gt;</span><br><span class="line">    &lt;a-layout&gt;</span><br><span class="line">      &lt;a-layout-header style=&quot;background: #fff; padding: 0&quot; /&gt;</span><br><span class="line">      &lt;a-layout-content style=&quot;margin: 0 16px&quot;&gt;</span><br><span class="line">        &lt;a-breadcrumb style=&quot;margin: 16px 0&quot;&gt;</span><br><span class="line">          &lt;a-breadcrumb-item&gt;User&lt;/a-breadcrumb-item&gt;</span><br><span class="line">          &lt;a-breadcrumb-item&gt;Bill&lt;/a-breadcrumb-item&gt;</span><br><span class="line">        &lt;/a-breadcrumb&gt;</span><br><span class="line">        &lt;div :style=&quot;&#123; padding: &#x27;24px&#x27;, background: &#x27;#fff&#x27;, minHeight: &#x27;360px&#x27; &#125;&quot;&gt;</span><br><span class="line">          Bill is a cat.</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/a-layout-content&gt;</span><br><span class="line">      &lt;a-layout-footer style=&quot;text-align: center&quot;&gt;</span><br><span class="line">        Ant Design ©2018 Created by Ant UED</span><br><span class="line">      &lt;/a-layout-footer&gt;</span><br><span class="line">    &lt;/a-layout&gt;</span><br><span class="line">  &lt;/a-layout&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; PieChartOutlined, DesktopOutlined, UserOutlined, TeamOutlined, FileOutlined &#125; from &#x27;@ant-design/icons-vue&#x27;;</span><br><span class="line">import &#123; defineComponent, ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    PieChartOutlined,</span><br><span class="line">    DesktopOutlined,</span><br><span class="line">    UserOutlined,</span><br><span class="line">    TeamOutlined,</span><br><span class="line">    FileOutlined,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      collapsed: ref(false),</span><br><span class="line">      selectedKeys: ref([&#x27;1&#x27;]),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">#components-layout-demo-side .logo &#123;</span><br><span class="line">  height: 32px;</span><br><span class="line">  margin: 16px;</span><br><span class="line">  background: rgba(255, 255, 255, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.site-layout .site-layout-background &#123;</span><br><span class="line">  background: #fff;</span><br><span class="line">&#125;</span><br><span class="line">[data-theme=&#x27;dark&#x27;] .site-layout .site-layout-background &#123;</span><br><span class="line">  background: #141414;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>设置路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       <span class="attr">path</span>: <span class="string">&#x27;/base&#x27;</span>,</span><br><span class="line">       <span class="attr">name</span>: <span class="string">&#x27;Base&#x27;</span>,</span><br><span class="line">       <span class="attr">component</span>: <span class="title class_">Base</span></span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8B%E5%8D%8862557493-3474359.png" alt="image-20220525下午62557493"></p>
<h3 id="Base组件修改">Base组件修改</h3>
<p>Base.vue修改菜单中的标题信息，Base.vue，代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a-layout</span> <span class="attr">style</span>=<span class="string">&quot;min-height: 100vh&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-layout-sider</span> <span class="attr">v-model:collapsed</span>=<span class="string">&quot;collapsed&quot;</span> <span class="attr">collapsible</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">style</span>=<span class="string">&quot;font-style: italic;text-align: center;font-size: 20px;color:#fff;margin: 10px 0;background-color: #333;line-height: 50px;font-family: &#x27;Times New Roman&#x27;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span> Urils<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-menu</span> <span class="attr">v-for</span>=<span class="string">&quot;menu in menu_list&quot;</span> <span class="attr">v-model:selectedKeys</span>=<span class="string">&quot;selectedKeys&quot;</span> <span class="attr">theme</span>=<span class="string">&quot;dark&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;inline&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">v-if</span>=<span class="string">&quot;menu.children.length===0&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;menu.id&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">          <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;menu.menu_url&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">desktop-outlined</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span> &#123;&#123; menu.title &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-sub-menu</span> <span class="attr">v-else</span> <span class="attr">:key</span>=<span class="string">&quot;menu.id&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">template</span> #<span class="attr">title</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">user-outlined</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; menu.title &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">v-for</span>=<span class="string">&quot;child_menu in menu.children&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;child_menu.id&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">&quot;child_menu.menu_url&quot;</span>&gt;</span>&#123;&#123; child_menu.title &#125;&#125;<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-sub-menu</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-menu</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-layout-sider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-layout</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-layout-header</span> <span class="attr">style</span>=<span class="string">&quot;background: #369; padding: 0&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-layout-content</span> <span class="attr">style</span>=<span class="string">&quot;margin: 0 16px&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-layout-content</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-layout-footer</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span>&gt;</span></span><br><span class="line">        Ant Design ©2018 Created by Ant UED</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-layout-footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a-layout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123;<span class="title class_">DesktopOutlined</span>, <span class="title class_">FileOutlined</span>, <span class="title class_">PieChartOutlined</span>, <span class="title class_">TeamOutlined</span>, <span class="title class_">UserOutlined</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@ant-design/icons-vue&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123;defineComponent, ref&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">PieChartOutlined</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">DesktopOutlined</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">UserOutlined</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">TeamOutlined</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">FileOutlined</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">collapsed</span>: <span class="title function_">ref</span>(<span class="literal">false</span>),</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">selectedKeys</span>: <span class="title function_">ref</span>([<span class="string">&#x27;1&#x27;</span>]),</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">menu_list</span>: [</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;展示中心&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/show_center&#x27;</span>, <span class="attr">children</span>: []</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;资产管理&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/host&#x27;</span>, <span class="attr">children</span>: []</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="attr">icon</span>: <span class="string">&#x27;bold&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;批量任务&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: [</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">10</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;执行任务&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/multi_exec&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">11</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;命令管理&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/template_manage&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">          ]</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">icon</span>: <span class="string">&#x27;highlight&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;代码发布&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: [</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">12</span>, <span class="attr">title</span>: <span class="string">&#x27;应用管理&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/release&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">13</span>, <span class="attr">title</span>: <span class="string">&#x27;发布申请&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/release&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">          ]</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;<span class="attr">id</span>: <span class="number">5</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;定时计划&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: []&#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">id</span>: <span class="number">6</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;配置管理&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: [</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">14</span>, <span class="attr">title</span>: <span class="string">&#x27;环境管理&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/environment&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">15</span>, <span class="attr">title</span>: <span class="string">&#x27;服务配置&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">16</span>, <span class="attr">title</span>: <span class="string">&#x27;应用配置&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">          ]</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;<span class="attr">id</span>: <span class="number">7</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;监控预警&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: []&#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">id</span>: <span class="number">8</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;报警&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: [</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">17</span>, <span class="attr">title</span>: <span class="string">&#x27;报警历史&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">18</span>, <span class="attr">title</span>: <span class="string">&#x27;报警联系人&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">19</span>, <span class="attr">title</span>: <span class="string">&#x27;报警联系组&#x27;</span>, <span class="string">&#x27;menu_url&#x27;</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">          ]</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">id</span>: <span class="number">9</span>, <span class="attr">icon</span>: <span class="string">&#x27;mail&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;用户管理&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>, <span class="attr">children</span>: [</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">20</span>, <span class="attr">title</span>: <span class="string">&#x27;账户管理&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">21</span>, <span class="attr">title</span>: <span class="string">&#x27;角色管理&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">            &#123;<span class="attr">id</span>: <span class="number">22</span>, <span class="attr">title</span>: <span class="string">&#x27;系统设置&#x27;</span>, <span class="attr">tube</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">menu_url</span>: <span class="string">&#x27;/urils/workbench&#x27;</span>&#125;</span></span><br><span class="line"><span class="language-javascript">          ]</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      ]</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#components-layout-demo-side</span> <span class="selector-class">.logo</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>: <span class="number">32px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">margin</span>: <span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.site-layout</span> <span class="selector-class">.site-layout-background</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-class">.site-layout</span> <span class="selector-class">.site-layout-background</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#141414</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220525%E4%B8%8B%E5%8D%8870712053-3476834.png" alt="image-20220525下午70712053"></p>
<p>路由router/index.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createRouter, createWebHistory&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Login.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Base</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Base&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;uric自动化运维平台&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/uric&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: <span class="string">&#x27;/&#x27;</span>, <span class="comment">// 给当前路径起一个别名</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Base&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Base</span>, <span class="comment">// 快捷键：Alt+Enter快速导包</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;账户登陆&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Login</span> <span class="comment">// 快捷键：Alt+Enter快速导包</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ShowCenter&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">ShowCenter</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>
<p>接着我们再创建一个测试路由的组件，Host.vue，代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;host&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>host页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&#x27;Host&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="子路由配置">子路由配置</h3>
<p>由于我们使用了组件嵌套，所以我们要通过路由嵌套来进行控制</p>
<p>Router/index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createRouter, createWebHistory&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Login.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Base</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Base&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ShowCenter</span> <span class="keyword">from</span> <span class="string">&#x27;../views/ShowCenter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Host</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Host&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;uric自动化运维平台&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/uric&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: <span class="string">&#x27;/&#x27;</span>, <span class="comment">// 给当前路径起一个别名</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Base&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Base</span>, <span class="comment">// 快捷键：Alt+Enter快速导包,</span></span><br><span class="line">        <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;show_center&#x27;</span>,</span><br><span class="line">                <span class="attr">alias</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 给当前路径起一个别名</span></span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;ShowCenter&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">ShowCenter</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;host&#x27;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;Host&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">Host</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;账户登陆&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Login</span> <span class="comment">// 快捷键：Alt+Enter快速导包</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220323180353942-164802983572519.png" alt="image-20220323180353942"></p>
<h1>二 后端项目初始化</h1>
<h2 id="（1）虚拟环境">（1）虚拟环境</h2>
<p>Python创建虚拟环境<br>
创建虚拟环境是为了让项目运行在一个独立的局部的Python环境中，使得不同环境的项目互不干扰。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. 安装虚拟环境的第三方包 virtualenv</span><br><span class="line">pip install virtualenv</span><br><span class="line">使用清华源安装：pip install virtualenv -i https://pypi.python.org/simple/</span><br><span class="line"></span><br><span class="line">2. 创建虚拟环境</span><br><span class="line"><span class="built_in">cd</span> 到存放虚拟环境光的地址</span><br><span class="line">virtualenv ENV 在当前目录下创建名为ENV的虚拟环境（如果第三方包virtualenv安装在python3下面，此时创建的虚拟环境就是基于python3的）</span><br><span class="line">virtualenv -p 指定python版本创建虚拟环境 参数 </span><br><span class="line">virtualenv -p /usr/local/bin/python3.6 虚拟环境名称 </span><br><span class="line">virtualenv --system-site-packages ENV 参数 --system-site-packages 指定创建虚拟环境时继承系统三方库</span><br><span class="line"></span><br><span class="line">3. 激活/退出虚拟环境</span><br><span class="line"><span class="built_in">cd</span> ~/ENV 跳转到虚拟环境的文件夹</span><br><span class="line"><span class="built_in">source</span> bin/activate 激活虚拟环境</span><br><span class="line">pip list 查看当前虚拟环境下所安装的第三方库</span><br><span class="line">deactivate 退出虚拟环境</span><br><span class="line"></span><br><span class="line">4. 删除虚拟环境</span><br><span class="line">直接删除虚拟环境所在目录即可</span><br></pre></td></tr></table></figure>
<blockquote>
<p>window系统没有bin文件夹，cd进入Scripts路径下运行：<code>activate.bat</code></p>
</blockquote>
<h2 id="（2）搭建项目">（2）搭建项目</h2>
<p>基于Pycharm创建Django项目时可以直接构建虚拟环境</p>
<p><img src="assets/image-20220610%E4%B8%8B%E5%8D%8862101239-4856464.png" alt="image-20220610下午62101239"></p>
<p>可以直接在pycharm中使用创建好的虚拟环境，安装和查看第三方库。也可以在终端中使用虚拟环境，转到pycharm中设定的<strong>虚拟环境的位置，一般在工程的根目录</strong>。这个虚拟环境和上述用命令创建的虚拟环境一样，采用上述<strong>激活/退出虚拟环境</strong>命令即可执行相应操作。</p>
<p>测试，安装requests模块</p>
<p><img src="assets/image-20220610%E4%B8%8B%E5%8D%8861820780-4856302.png" alt="image-20220610下午61820780"></p>
<p><img src="assets/image-20220610%E4%B8%8B%E5%8D%8861412150-4856054.png" alt="image-20220610下午61412150"></p>
<h2 id="（3）项目目录调整">（3）项目目录调整</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认结构</span></span><br><span class="line">└── uric_api</span><br><span class="line">    ├── manage.py</span><br><span class="line">    └── uric_api</span><br><span class="line">        ├── asgi.py</span><br><span class="line">        ├── __init__.py</span><br><span class="line">        ├── settings.py</span><br><span class="line">        ├── urls.py</span><br><span class="line">        └── wsgi.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整结构</span></span><br><span class="line"></span><br><span class="line">└── uric_api         <span class="comment"># 后端项目目录</span></span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── logs         <span class="comment"># 项目运行时/开发时日志目录</span></span><br><span class="line">    ├── manage.py    <span class="comment"># 开发阶段的启动文件</span></span><br><span class="line">    ├── scripts      <span class="comment"># 保存项目运营时的脚本文件 bash</span></span><br><span class="line">    │   └── __init__.py</span><br><span class="line">    └── uric_api     <span class="comment"># 项目主应用，开发时的代码保存</span></span><br><span class="line">        ├── apps     <span class="comment"># 开发者的代码保存目录，以模块[子应用]为目录保存（包）</span></span><br><span class="line">        │   └── __init__.py</span><br><span class="line">        ├── asgi.py</span><br><span class="line">        ├── __init__.py</span><br><span class="line">        ├── libs              <span class="comment"># 第三方类库的保存目录[第三方组件、模块]（包）</span></span><br><span class="line">        │   └── __init__.py</span><br><span class="line">        ├── settings</span><br><span class="line">        │   ├── dev.py         <span class="comment"># 项目开发时的本地配置</span></span><br><span class="line">        │   ├── __init__.py</span><br><span class="line">        │   ├── prod.py        <span class="comment"># 项目上线时的运行配置</span></span><br><span class="line">        │   └── test.py        <span class="comment"># 测试人员使用的配置(咱们不需要)</span></span><br><span class="line">        ├── settings.py</span><br><span class="line">        ├── urls.py            <span class="comment"># 总路由（包） </span></span><br><span class="line">        ├── utils          <span class="comment"># 多个模块[子应用]的公共函数类库[自己开发的组件]</span></span><br><span class="line">        │   └── __init__.py</span><br><span class="line">        └── wsgi.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：创建文件夹的时候，是创建包(含<code>__init__.py</code>文件的)还是创建单纯的文件夹，看目录里面放的是什么，如果放的是py文件相关的代码，最好创建包，如果不是，那就创建单纯的文件夹。</p>
</blockquote>
<p>切换manage.py启动项目时使用的配置文件。<a target="_blank" rel="noopener" href="http://mange.py">mange.py</a>，代码：</p>
<p><img src="assets/image-20220610%E4%B8%8B%E5%8D%8820536359-4841138.png" alt="image-20220610下午20536359"></p>
<h2 id="（4）注册DRF组件">（4）注册DRF组件</h2>
<p>下载：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework -i https://pypi.douban.com/simple</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://settings.dev.py">settings.dev.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>调整子应用保存以后，创建并注册子应用需要调整如下，</p>
<p>例如：创建home子应用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd uric_api/apps</span><br><span class="line">python ../../manage.py startapp home</span><br></pre></td></tr></table></figure>
<p>子应用的注册，<a target="_blank" rel="noopener" href="http://settings.dev.py">settings.dev.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = Path(__file__).resolve().parent.parent</span><br><span class="line">sys.path.insert(<span class="number">0</span>, <span class="built_in">str</span>(BASE_DIR / <span class="string">&#x27;apps&#x27;</span>))</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;home&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>创建了一个测试视图，提供给外界访问。<a target="_blank" rel="noopener" href="http://home.views.py">home.views.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestAPIView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self,request</span>):</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;hello&quot;</span>&#125;,)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://home.urls.py">home.urls.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;test&quot;</span>, views.TestAPIView.as_view())</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>总路由加载home子应用的路由信息，<code>uric_api.urls</code>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&quot;&quot;</span>, include(<span class="string">&quot;home.urls&quot;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220610%E4%B8%8B%E5%8D%8864210493-4857732.png" alt="image-20220610下午64210493"></p>
<h2 id="（5）日志配置">（5）日志配置</h2>
<p>参考django官方文档，网址：<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.2/topics/logging/">https://docs.djangoproject.com/zh-hans/3.2/topics/logging/</a></p>
<p>在settings/dev.py文件中追加如下配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="comment"># 使用的python内置的logging模块，那么python可能会对它进行升级，所以需要写一个版本号，目前就是1版本</span></span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="comment"># 是否去掉目前项目中其他地方中以及使用的日志功能，但是将来我们可能会引入第三方的模块，里面可能内置了日志功能，所以尽量不要关闭，肯定False</span></span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="comment"># 日志的处理格式</span></span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line">        <span class="comment"># 详细格式，往往用于记录日志到文件/其他第三方存储设备</span></span><br><span class="line">        <span class="string">&#x27;verbose&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment"># levelname等级，asctime记录时间，module表示日志发生的文件名称，lineno行号，message错误信息</span></span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;&#123;levelname&#125; &#123;asctime&#125; &#123;module&#125;:&#123;lineno:d&#125; &#123;message&#125;&#x27;</span>,</span><br><span class="line">            <span class="comment"># 日志格式中的，变量分隔符</span></span><br><span class="line">            <span class="string">&#x27;style&#x27;</span>: <span class="string">&#x27;&#123;&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;simple&#x27;</span>: &#123;  <span class="comment"># 简单格式，往往用于终端</span></span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;&#123;levelname&#125; &#123;module&#125;:&#123;lineno&#125; &#123;message&#125;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;style&#x27;</span>: <span class="string">&#x27;&#123;&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;filters&#x27;</span>: &#123; <span class="comment"># 日志的过滤设置，可以对日志进行输出时的过滤用的</span></span><br><span class="line">        <span class="comment"># 在debug=True下产生的一些日志信息，要不要记录日志，需要的话就在handlers中加上这个过滤器，不需要就不加</span></span><br><span class="line">        <span class="string">&#x27;require_debug_true&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;()&#x27;</span>: <span class="string">&#x27;django.utils.log.RequireDebugTrue&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;  <span class="comment"># 日志的处理方式</span></span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;  <span class="comment"># 终端下显示</span></span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,  <span class="comment"># 日志的最低等级</span></span><br><span class="line">            <span class="string">&#x27;filters&#x27;</span>: [<span class="string">&#x27;require_debug_true&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>, <span class="comment"># 处理日志的核心类</span></span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: &#123;  <span class="comment"># 文件中记录日志</span></span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.RotatingFileHandler&#x27;</span>,</span><br><span class="line">            <span class="comment"># 日志位置,日志文件名,日志保存目录必须手动创建</span></span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: BASE_DIR.parent / <span class="string">&quot;logs/uric.log&quot;</span>,</span><br><span class="line">            <span class="comment"># 单个日志文件的最大值,这里我们设置300M</span></span><br><span class="line">            <span class="string">&#x27;maxBytes&#x27;</span>: <span class="number">300</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">            <span class="comment"># 备份日志文件的数量,设置最大日志数量为10</span></span><br><span class="line">            <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="comment"># 日志格式:详细格式</span></span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;verbose&#x27;</span>,</span><br><span class="line">            <span class="comment"># 设置默认编码，否则打印出来汉字乱码</span></span><br><span class="line">            <span class="string">&#x27;encoding&#x27;</span>: <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 日志实例对象</span></span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;django&#x27;</span>: &#123; <span class="comment"># 固定名称，将来django内部也会有异常的处理，只会调用django下标的日志对象</span></span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,  <span class="comment"># 是否让日志信息继续冒泡给其他的日志处理系统</span></span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="string">&quot;DRF&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,  <span class="comment"># 是否让日志信息继续冒泡给其他的日志处理系统     </span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例：构建中间件，记录每次请求信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LogMiddleware</span>(<span class="title class_ inherited__">MiddlewareMixin</span>):</span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_request</span>(<span class="params">self, request</span>):</span><br><span class="line">        self.start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_response</span>(<span class="params">self, request, response</span>):</span><br><span class="line">        cost_timer = time.time() - self.start</span><br><span class="line"></span><br><span class="line">        logger = logging.getLogger(<span class="string">&quot;django&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> cost_timer &gt; <span class="number">0.5</span>:</span><br><span class="line">            logger.warning(<span class="string">f&quot;请求路径: <span class="subst">&#123;request.path&#125;</span> 耗时<span class="subst">&#123;cost_timer&#125;</span>秒&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220612%E4%B8%8B%E5%8D%8843938550-5023180.png" alt="image-20220612下午43938550"></p>
<h2 id="（6）异常处理">（6）异常处理</h2>
<p>新建utils/exceptions.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> DatabaseError</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;django&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">custom_exception_handler</span>(<span class="params">exc, context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义异常处理</span></span><br><span class="line"><span class="string">    :param exc: 异常类实例对象</span></span><br><span class="line"><span class="string">    :param context: 抛出异常的执行上下文[context，是一个字典格式的数据，里面记录了异常发生时的环境信息]</span></span><br><span class="line"><span class="string">    :return: Response 响应对象</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 先让drf内置的异常处理函数先解决掉它能识别的异常</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;drf无法处理的异常&quot;&quot;&quot;</span></span><br><span class="line">        view = context[<span class="string">&quot;view&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(exc, DatabaseError):</span><br><span class="line">            logger.error(<span class="string">&#x27;[%s] %s&#x27;</span> % (view, exc))</span><br><span class="line">            response = Response(&#123;<span class="string">&quot;errmsg&quot;</span>:<span class="string">&quot;服务器内部存储错误&quot;</span>&#125;, status=status.HTTP_507_INSUFFICIENT_STORAGE)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>settings/dev.py配置文件中添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 异常处理</span></span><br><span class="line">    <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;uric_api.utils.exceptions.custom_exception_handler&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 视图更改</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestAPIView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="keyword">from</span> django.db <span class="keyword">import</span> DatabaseError</span><br><span class="line">        <span class="keyword">raise</span> DatabaseError(<span class="string">&quot;mysql连接失败&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;hello&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="（7）连接数据库">（7）连接数据库</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database uric default charset=utf8mb4; -- utf8也会导致有些极少的中文出现乱码的问题，mysql5.5之后官方才进行处理，出来了utf8mb4，这个是真正的utf8，能够容纳所有的中文。</span><br></pre></td></tr></table></figure>
<p>为当前项目创建数据库用户[这个用户只能看到uric这个数据库]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># mysql8.0版本以上执行</span><br><span class="line"># 创建用户：create user &#x27;用户名&#x27;@&#x27;主机地址&#x27; identified by &#x27;密码&#x27;;</span><br><span class="line">create user &#x27;uricUser01&#x27;@&#x27;%&#x27; identified by &#x27;uric&#x27;;  # %表示任意主机都可以通过当前账户登录到mysql</span><br><span class="line"># 分配权限：grant 权限选项 on 数据库名.数据表 to &#x27;用户名&#x27;@&#x27;主机地址&#x27; with grant option;</span><br><span class="line">grant all privileges on uric.* to &#x27;uricUser&#x27;@&#x27;%&#x27; with grant option;</span><br><span class="line"></span><br><span class="line"># mysql8.0版本以下执行，创建数据库用户并设置数据库权限给当前新用户，并刷新内存中的权限记录</span><br><span class="line"># create user uric_user identified by &#x27;uric&#x27;;</span><br><span class="line"># grant all privileges on uric.* to &#x27;uric_user&#x27;@&#x27;%&#x27;;</span><br><span class="line"># flush privileges;</span><br></pre></td></tr></table></figure>
<p>配置数据库连接：打开settings/dev.py文件，并配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ENGINE&quot;</span>: <span class="string">&quot;django.db.backends.mysql&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HOST&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PORT&quot;</span>: <span class="number">13306</span>,</span><br><span class="line">        <span class="string">&quot;USER&quot;</span>: <span class="string">&quot;uric_user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PASSWORD&quot;</span>: <span class="string">&quot;uric&quot;</span>,</span><br><span class="line">        <span class="string">&quot;NAME&quot;</span>: <span class="string">&quot;uric&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在项目主模块的 <code>__init__.py</code>中导入pymysql</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymysql <span class="keyword">import</span> install_as_MySQLdb</span><br><span class="line">install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意是主模块的初始化文件，不是项目根目录的初始化文件！</p>
</blockquote>
<p>初始化Django默认表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>初始化Django默认表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20210819134957978.png" alt="image-20210819134957978"></p>
<h2 id="（8）跨域设置">（8）跨域设置</h2>
<h4 id="cors解决跨域请求">cors解决跨域请求</h4>
<p>我们现在为前端和后端分别设置两个不同的域名：</p>
<table>
<thead>
<tr>
<th>位置</th>
<th>域名</th>
</tr>
</thead>
<tbody>
<tr>
<td>客户端</td>
<td><code>www.uric.cn</code></td>
</tr>
<tr>
<td>服务端</td>
<td><code>api.uric.cn</code></td>
</tr>
</tbody>
</table>
<p>编辑<code>/etc/hosts</code>文件，可以设置本地域名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts</span><br></pre></td></tr></table></figure>
<p>window中在<code>C:\Windows\System32\drivers\etc</code></p>
<p>在文件中增加两条信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost</span><br><span class="line">127.0.0.1   api.uric.cn</span><br><span class="line">127.0.0.1   www.uric.cn</span><br></pre></td></tr></table></figure>
<p>现在，前端与后端分处不同的域名，我们需要为后端添加跨域访问的支持，否则前端无法使用axios无法请求后端提供的api数据，开发中，我们使用CORS来解决后端对跨域访问的支持。CORS 即 Cross Origin Resource Sharing 跨域资源共享。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在 Response(headers=&#123;<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>:<span class="string">&#x27;客户端地址或*&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CorsMiddleWare</span>(<span class="title class_ inherited__">MiddlewareMixin</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_response</span>(<span class="params">self, request, response</span>):</span><br><span class="line">        response[<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>] = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="跨域复杂请求">跨域复杂请求</h4>
<p><strong>跨域请求分两种：简单请求、复杂请求.</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">简单请求</span><br><span class="line"></span><br><span class="line">简单请求必须满足下述条件.</span><br><span class="line"></span><br><span class="line">HTTP方法为这三种方法之一：HEAD、GET、POST</span><br><span class="line"></span><br><span class="line">HTTP头消息不超出以下字段：</span><br><span class="line"></span><br><span class="line">Accept、Accept-Language、Content-Language、Last-Event-ID</span><br><span class="line"></span><br><span class="line">且Content-Type只能为下列类型中的某一个：</span><br><span class="line"></span><br><span class="line">- application/x-www-from-urlencoded</span><br><span class="line">- multipart/form-data</span><br><span class="line">- text/plain.</span><br><span class="line"></span><br><span class="line">==任何不满足上述要求的请求，都会被认为是复杂请求.</span><br></pre></td></tr></table></figure>
<p>复杂请求会先发出一个预请求——预检，OPTIONS请求.==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CorsMiddleWare</span>(<span class="title class_ inherited__">MiddlewareMixin</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">process_response</span>(<span class="params">self, request, response</span>):</span><br><span class="line">    <span class="comment"># 如下，等于&#x27;*&#x27;后，便可允许所有简单请求的跨域访问</span></span><br><span class="line">    response[<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>] = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 判断是否为复杂请求</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">      response[<span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span>] = <span class="string">&#x27;Content-Type&#x27;</span></span><br><span class="line">      response[<span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span>] = <span class="string">&#x27;PUT,PATCH,DELETE&#x27;</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h4 id="cors-headers组件">cors-headers组件</h4>
<p>文档：<a target="_blank" rel="noopener" href="https://github.com/ottoyiu/django-cors-headers/">https://github.com/ottoyiu/django-cors-headers/</a></p>
<p>安装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-cors-headers -i https://pypi.douban.com/simple/</span><br></pre></td></tr></table></figure>
<p>添加应用，<a target="_blank" rel="noopener" href="http://settings.dev.py">settings.dev.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;corsheaders&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>中间件设置【必须写在第一个位置】，<a target="_blank" rel="noopener" href="http://settings.dev.py">settings.dev.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;corsheaders.middleware.CorsMiddleware&#x27;</span>, <span class="comment">#放在中间件的最上面，就是给响应头加上了一个响应头跨域</span></span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>需要添加跨域白名单，确定一下哪些客户端可以跨域。<a target="_blank" rel="noopener" href="http://settings.dev.py">settings.dev.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CORS组的配置信息</span></span><br><span class="line">CORS_ORIGIN_WHITELIST = (</span><br><span class="line">    <span class="comment">#&#x27;www.uric.cn:8080&#x27;, # 如果这样写不行的话，就加上协议(http://www.uric.cn:8080，因为不同的corsheaders版本可能有不同的要求)</span></span><br><span class="line">    <span class="string">&#x27;http://www.uric.cn:8080&#x27;</span>,</span><br><span class="line">)</span><br><span class="line">CORS_ALLOW_CREDENTIALS = <span class="literal">False</span>  <span class="comment"># 是否允许ajax跨域请求时携带cookie，False表示不用，我们后面也用不到cookie，所以关掉它就可以了，以防有人通过cookie来搞我们的网站</span></span><br></pre></td></tr></table></figure>
<p>允许客户端通过api.uric.cn访问Django项目，<a target="_blank" rel="noopener" href="http://settings.dev.py">settings.dev.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">&quot;api.uric.cn&quot;</span>,]</span><br></pre></td></tr></table></figure>
<p>完成了上面的步骤，我们将来就可以通过后端提供数据给前端使用ajax访问了。前端使用 axios就可以访问到后端提供给的数据接口，但是如果要附带cookie信息，前端还要设置一下，这个等我们搭建客户端项目时再配置。</p>
<h2 id="（9）git设置">（9）git设置</h2>
<p>完成了上面的操作以后，服务端的初始化算基本完成了。我们现在已经写了那么多代码的话，肯定要对代码进行版本跟踪和管理，这时候，我们就要使用git通过gitee/github/gitlab进行创建代码版本。</p>
<p>码云：<a target="_blank" rel="noopener" href="http://www.gitee.com">http://www.gitee.com</a></p>
<p>创建Git仓库：</p>
<p><img src="assets/image-20210819141635938.png" alt="image-20210819141635938"></p>
<p><img src="assets/image-20210819141742504.png" alt="image-20210819141742504"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Git 全局设置:</span></span><br><span class="line">git config --global user.name <span class="string">&quot;Yuan先生&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;916852314@163.com&quot;</span></span><br><span class="line"><span class="comment"># 创建 git 仓库:</span></span><br><span class="line"><span class="built_in">mkdir</span> uric</span><br><span class="line"><span class="built_in">cd</span> uric</span><br><span class="line">git init</span><br><span class="line"><span class="built_in">touch</span> README.md</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">git remote add origin https://gitee.com/pythonyuan/uric.git</span><br><span class="line">git push -u origin master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 已有仓库</span></span><br><span class="line"><span class="built_in">cd</span> existing_git_repo</span><br><span class="line">git remote add origin https://gitee.com/pythonyuan/uric.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
<p>接下来，在终端下设置当前开发者的身份。这里，我们把客户端和服务端的代码保存到一个代码仓库中。所以直接在uric目录下创建代码仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Desktop/</span><br><span class="line"><span class="built_in">cd</span> uric/</span><br><span class="line">git init  <span class="comment"># 初始化git代码库</span></span><br><span class="line"><span class="comment"># 设置身份</span></span><br><span class="line">git config --global user.name <span class="string">&quot;Yuan先生&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;916852314@163.com&quot;</span></span><br><span class="line"><span class="comment"># 设置远程仓库</span></span><br><span class="line">git remote add origin https://gitee.com/pythonyuan/uric.git</span><br><span class="line"><span class="comment"># 接下来，我们就可以把上面服务端初始化的代码保存一个版本</span></span><br><span class="line">git  add .</span><br><span class="line">git commit -m <span class="string">&quot;api服务端初始化完成&quot;</span></span><br><span class="line"><span class="comment"># 生成本地ssh密码，链接到服务端</span></span><br><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;916852314@qq.com&quot;</span></span><br><span class="line"><span class="comment"># 查看上面生成的ssh公钥，并复制到gitee码云上面</span></span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub  <span class="comment"># ssh-rsa </span></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDG/4nDPBNat3NgYdDM/ttxDTfRrlc5sH6KDgX+YXB8Zv8/YDJT7y2MPLPFTt/WXE4bxfFxn/5/87LELSbcOFz9VGzYSeZtysnX70rbxxP59/m6X6/oLiH4D++0zu5879gbHSOU5P5V0m1qofF4DD1so6R5FbO1aavFyIOt15IpKHLg9jkSIw3x6QSY3dojlnbR41Xu5XutdA1D1F3cjUjPQzGlMtnW3S79tocrLzHk2PDrqsDydvJGqQw//M9HCQqzZDUTAgMVldP8f0Pyzop4nnfrwPGf5uwWx0Pve6k4cpnGKwS0rnOcjU0fUqnbVq6Qaye5wR8IfFgoPMDBZCy4UAwMNtbP5YTx8nBVHr6b2N7ZNRYLZQXbPwra3ic8TmgLcUNyYsvNa98VTS56pLcSNKUBnSqY70OilbKAyysrPWN9Q5a69bbh4xwJRIf+7NEqvtBKpI2Beg7nXeWs2CS9pkJ5hwLIHtAzouwjrQZshVSjqg9n4R61AOOObwIpLLc= 916852314@qq.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#  git remote remove origin</span></span><br><span class="line"><span class="comment">#  git remote add origin git@gitee.com:pythonyuan/uric.git</span></span><br></pre></td></tr></table></figure>
<p>访问个人中心的设置ssh公钥的地址：<a target="_blank" rel="noopener" href="https://gitee.com/profile/sshkeys">https://gitee.com/profile/sshkeys</a></p>
<p><img src="assets/image-20210819145033188.png" alt="image-20210819145033188"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把git版本库历史记录同步到gitee码云上面</span></span><br><span class="line">git push -u origin master  <span class="comment"># 此时就不需要提交用户名密码了</span></span><br></pre></td></tr></table></figure>
<h1>三 登录认证</h1>
<h2 id="3-1、创建users应用">3.1、创建users应用</h2>
<p>创建用户模块的子应用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd uric_api/apps</span><br><span class="line">python ../../manage.py startapp users</span><br></pre></td></tr></table></figure>
<p>在settings/dev.py文件中注册子应用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">		...</span><br><span class="line">  	<span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>子路由，<a target="_blank" rel="noopener" href="http://users.urls.py">users.urls.py</a>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>总路由注册users子路由，uric_api.urls.py，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&quot;&quot;</span>, include(<span class="string">&quot;home.urls&quot;</span>)),</span><br><span class="line">    path(<span class="string">&quot;users/&quot;</span>, include(<span class="string">&quot;users.urls&quot;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="3-2、创建自定义的用户模型类">3.2、创建自定义的用户模型类</h2>
<p>Django默认已经提供了认证系统Auth模块，我们认证的时候，会使用auth模块里面给我们提供的表。认证系统包含：</p>
<ul>
<li>用户管理</li>
<li>权限</li>
<li>用户组</li>
<li>密码哈希系统</li>
<li>用户登录或内容显示的表单和视图</li>
<li>一个可插拔的后台系统 admin</li>
</ul>
<p>我们可以在终端下通过命令创建一个管理员账号，并登陆到admin站点中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>
<p>Django默认用户的认证机制依赖Session机制，我们在项目中将引入JWT认证机制，将用户的身份凭据存放在Token中，然后对接Django的认证系统，帮助我们来实现：</p>
<ul>
<li>用户的数据模型</li>
<li>用户密码的加密与验证</li>
<li>用户的权限系统</li>
</ul>
<p>Django认证系统中提供的用户模型类及方法很方便，我们可以使用这个模型类，但是字段有些无法满足项目需求，如本项目中需要保存用户的手机号，需要给模型类添加额外的字段。</p>
<p>Django提供了<code>django.contrib.auth.models.AbstractUser</code>用户抽象模型类允许我们继承，扩展字段来使用Django认证系统的用户模型类。</p>
<p>我们可以在apps中创建Django应用users，并在配置文件中注册users应用。</p>
<p>在创建好的应用models.py中定义用户的用户模型类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">AbstractUser</span>):</span><br><span class="line">    mobile = models.CharField(max_length=<span class="number">15</span>, unique=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;手机号码&#x27;</span>)</span><br><span class="line">    <span class="comment"># upload_to 表示上传文件的存储子路由，需要在settings配置中，配置上传文件的支持</span></span><br><span class="line">    avatar = models.ImageField(upload_to=<span class="string">&#x27;avatar&#x27;</span>, verbose_name=<span class="string">&#x27;用户头像&#x27;</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&#x27;uric_user&#x27;</span></span><br><span class="line">        verbose_name = <span class="string">&#x27;用户信息&#x27;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的3个表现不用创建，留着以后使用</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Menu</span>(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    一级菜单表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">12</span>)</span><br><span class="line">    weight = models.IntegerField(default=<span class="number">0</span>)</span><br><span class="line">    icon = models.CharField(max_length=<span class="number">16</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&#x27;uric_menu&#x27;</span></span><br><span class="line">        verbose_name = <span class="string">&#x27;一级菜单表&#x27;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line">        unique_together = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;weight&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Permission</span>(models.Model):</span><br><span class="line">    url = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    menus = models.ForeignKey(<span class="string">&#x27;Menu&#x27;</span>,on_delete=models.CASCADE , null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    parent = models.ForeignKey(<span class="string">&#x27;self&#x27;</span>,on_delete=models.CASCADE ,  null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    url_name = models.CharField(max_length=<span class="number">32</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&#x27;uric_permission&#x27;</span></span><br><span class="line">        verbose_name = <span class="string">&#x27;权限表&#x27;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(models.Model):</span><br><span class="line">    name = models.CharField(max_length=<span class="number">12</span>)</span><br><span class="line">    permissions = models.ManyToManyField(to=<span class="string">&#x27;Permission&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&#x27;uric_role&#x27;</span></span><br><span class="line">        verbose_name = <span class="string">&#x27;角色表&#x27;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建用户模型对象两种方式：</p>
<p>User.objects.create_superuser()</p>
<p>Python <a target="_blank" rel="noopener" href="http://manage.py">manage.py</a> createsuperuser</p>
</blockquote>
<p>我们自定义的用户模型类还不能直接被Django的认证系统所识别，需要在配置文件中告知Django认证系统使用我们自定义的模型类。</p>
<p>在配置文件中进行设置,<code>settings.dev.py</code>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置Auth认证模块使用的用户模型为我们自己定义的用户模型</span></span><br><span class="line"><span class="comment"># 格式：“子应用目录名.模型类名”</span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">&#x27;users.User&#x27;</span></span><br></pre></td></tr></table></figure>
<p><code>AUTH_USER_MODEL</code> 参数的设置以<code>点.</code>来分隔，表示<code>应用名.模型类名</code>。</p>
<p><strong>注意：Django建议我们对于AUTH_USER_MODEL参数的设置一定要在第一次数据库迁移之前就设置好，否则后续使用可能出现未知错误。</strong></p>
<p>接下来，因为我们新建的用户模型需要同步到数据库中。所有需要数据迁移。同时当前用户模型中，我们声明了头像字段需要进行图片处理的。所以我们安装Pillow模块。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Pillow模块</span></span><br><span class="line">pip install pillow</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据迁移</span></span><br><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>如果之前曾经进行了一次数据迁移，mysql中为原来的用户表与django其他的数据进行关联。此时我们再次数据迁移，因为修改了用户表，所以会出现外键关联报错。</p>
<p><img src="assets/1626509052126.png" alt="1626509052126"></p>
<p>解决方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 删除数据库中所有的数据表[如果数据表中有重要数据，必须先导出备份]</span><br><span class="line">2. 删除当前users子应用中的migrations目录下所有以数字开头的python文件</span><br><span class="line">3. 删除源码中django.contrib.auth和django.contrib.admin中的migrations目录下所有以数字开头的python文件</span><br><span class="line">4. 重新执行数据迁移</span><br><span class="line">   python manage.py makemigrations</span><br><span class="line">   python manage.py migrate</span><br><span class="line">5. 把上面备份的数据通过终端重新恢复</span><br></pre></td></tr></table></figure>
<h2 id="3-3、simpleui的安装和使用">3.3、simpleui的安装和使用</h2>
<p>simpleui是Django的第三方扩展，比使用Django的admin站点更强大也更方便，更好看。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://simpleui.72wo.com/docs/simpleui/">https://simpleui.72wo.com/docs/simpleui/</a></p>
<p>GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/happybeta/simpleui">https://github.com/happybeta/simpleui</a></p>
<p>通过如下命令安装simpleui的最新版，它文档里面的安装方法好久没有更新了，会导致你安装不成功，所以我们使用下面的网址进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-simpleui -i https://pypi.douban.com/simple</span><br></pre></td></tr></table></figure>
<p>在配置文件中注册如下应用，<code>settings.dev</code>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;simpleui&#x27;</span>,  <span class="comment"># 必须写在django.contrib.admin之前</span></span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;corsheaders&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改使用中文界面</span></span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-Hans&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改时区</span></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="3-4、JWT">3.4、JWT</h2>
<h3 id="3-4-1、JWT介绍">3.4.1、JWT介绍</h3>
<p>在用户注册或登录后，我们想记录用户的登录状态，或者为用户创建身份认证的凭证。我们不再使用Session认证机制，而使用Json Web Token认证机制。</p>
<p>很多公司开发的一些移动端可能不支持cookie，并且我们通过cookie和session做接口登录认证的话，效率其实并不是很高，我们的接口可能提供给多个客户端，session数据保存在服务端，那么就需要每次都调用session数据进行验证，比较耗时，所以引入了token认证的概念，我们也可以通过token来完成，我们来看看jwt是怎么玩的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Json web token (JWT), 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（(RFC 7519).该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</span><br></pre></td></tr></table></figure>
<h4 id="JWT的构成">JWT的构成</h4>
<p>JWT就一段字符串，由三段信息构成的，将这三段信息文本用<code>.</code>链接一起就构成了Jwt字符串。就像这样:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>
<p>第一部分我们称它为头部（header),第二部分我们称其为载荷（payload, 类似于飞机上承载的物品)，第三部分是签证（signature).</p>
<h4 id="header">header</h4>
<p>jwt的头部承载两部分信息：</p>
<ul>
<li>声明类型，这里是jwt</li>
<li>声明加密的算法 通常直接使用 HMAC SHA256</li>
</ul>
<p>完整的头部就像下面这样的JSON：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &#x27;typ&#x27;: &#x27;JWT&#x27;,</span><br><span class="line">  &#x27;alg&#x27;: &#x27;HS256&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将头部进行base64.b64encode()编码，构成了第一部分.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><br></pre></td></tr></table></figure>
<p>python中base64加密解密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64,json</span><br><span class="line">data = &#123;</span><br><span class="line">  <span class="string">&#x27;typ&#x27;</span>: <span class="string">&#x27;JWT&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;alg&#x27;</span>: <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header = base64.b64encode(json.dumps(data).encode()).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 各个语言中都有base64加密解密的功能，所以我们jwt为了安全，需要配合第三段加密</span></span><br></pre></td></tr></table></figure>
<h4 id="payload">payload</h4>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息可以存放下面三个部分信息。</p>
<ul>
<li>标准声明</li>
<li>公共声明</li>
<li>私有声明</li>
</ul>
<p><strong>标准声明</strong> (建议但不强制使用) ：</p>
<ul>
<li>
<p><strong>iss</strong>: jwt签发者</p>
</li>
<li>
<p><strong>sub</strong>: jwt所面向的用户</p>
</li>
<li>
<p><strong>aud</strong>: 接收jwt的一方</p>
</li>
<li>
<p><strong>exp</strong>: jwt的过期时间，这个过期时间必须要大于签发时间</p>
</li>
<li>
<p><strong>nbf</strong>: 定义在什么时间之前，该jwt都是不可用的.</p>
</li>
<li>
<p><strong>iat</strong>: jwt的签发时间</p>
</li>
<li>
<p><strong>jti</strong>: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p>
<p>以上是JWT 规定的7个官方字段，供选用</p>
</li>
</ul>
<p><strong>公共声明</strong> ： 公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端直接可以查看.</p>
<p><strong>私有声明</strong> ： 私有声明是服务端和客户端所共同定义的声明，一般使用了ace算法进行对称加密和解密的，意味着该部分信息可以归类为明文信息。</p>
<p>定义一个payload，json格式的数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;sub&quot;: &quot;1234567890&quot;,</span><br><span class="line">  &quot;exp&quot;: &quot;3422335555&quot;, #时间戳形式</span><br><span class="line">  &quot;name&quot;: &quot;John Doe&quot;,</span><br><span class="line">  &quot;admin&quot;: true,</span><br><span class="line">  &quot;info&quot;: &quot;232323ssdgerere3335dssss&quot;  # ACE算法加密</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将其进行base64.b64encode() 编码，得到JWT的第二部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64,json</span><br><span class="line">data = &#123;</span><br><span class="line">  <span class="string">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="string">&quot;exp&quot;</span>: <span class="string">&quot;3422335555&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="string">&quot;admin&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">  <span class="string">&quot;info&quot;</span>: <span class="string">&quot;232323ssdgerere3335dssss&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">preload = base64.b64encode(json.dumps(data).encode()).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 各个语言中都有base64编码和解码，所以我们jwt为了安全，需要配合第三段签证来进行加密保证jwt不会被人篡改。</span></span><br></pre></td></tr></table></figure>
<h4 id="signature">signature</h4>
<p>JWT的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<ul>
<li>header (base64后的)</li>
<li>preload (base64后的)</li>
<li>secret 密钥</li>
</ul>
<p>这个部分需要base64加密后的header和base64加密后的payload使用<code>.</code>连接组成的字符串，然后通过header中声明的加密方式进行加盐<code>secret</code>组合加密，然后就构成了jwt的第三部分。</p>
<p>python，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64, json, hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 头部</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;typ&#x27;</span>: <span class="string">&#x27;JWT&#x27;</span>, <span class="string">&#x27;alg&#x27;</span>: <span class="string">&#x27;HS256&#x27;</span>&#125;</span><br><span class="line">    header = base64.b64encode(json.dumps(data).encode()).decode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 载荷</span></span><br><span class="line">    data = &#123;<span class="string">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>, <span class="string">&quot;exp&quot;</span>: <span class="string">&quot;3422335555&quot;</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;admin&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;info&quot;</span>: <span class="string">&quot;232323ssdgerere3335dssss&quot;</span>&#125;</span><br><span class="line">    preload = base64.b64encode(json.dumps(data).encode()).decode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 签证</span></span><br><span class="line">    <span class="comment"># from django.conf import settings</span></span><br><span class="line">    <span class="comment"># secret = settings.SECRET_KEY</span></span><br><span class="line">    secret = <span class="string">&#x27;django-insecure-(_+qtd5edmhm%2rdsg+qc3wi@s_k*3cbk-+k2gpg3@qx)z6r+p&#x27;</span></span><br><span class="line">    sign = <span class="string">f&quot;<span class="subst">&#123;header&#125;</span>.<span class="subst">&#123;preload&#125;</span>.<span class="subst">&#123;secret&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    hs256 = hashlib.sha256()</span><br><span class="line">    hs256.update(sign.encode())</span><br><span class="line">    signature = hs256.hexdigest()</span><br><span class="line"></span><br><span class="line">    jwt = <span class="string">f&quot;f<span class="subst">&#123;header&#125;</span>.<span class="subst">&#123;preload&#125;</span>.<span class="subst">&#123;signature&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(jwt)</span><br></pre></td></tr></table></figure>
<p>将这三部分用<code>.</code>连接成一个完整的字符串,构成了最终的jwt:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feyJ0eXAiOiAiSldUIiwgImFsZyI6ICJIUzI1NiJ9.eyJzdWIiOiAiMTIzNDU2Nzg5MCIsICJleHAiOiAiMzQyMjMzNTU1NSIsICJuYW1lIjogIkpvaG4gRG9lIiwgImFkbWluIjogdHJ1ZSwgImluZm8iOiAiMjMyMzIzc3NkZ2VyZXJlMzMzNWRzc3NzIn0=.374b156a33e579c780eb1594a5738c580a13ea0f905487dc66c15856b6110ebf</span><br></pre></td></tr></table></figure>
<p><strong>注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jwt的优点：</span><br><span class="line">1. 实现分布式的单点登陆非常方便</span><br><span class="line">2. 数据实际保存在客户端，所以我们可以分担服务端的存储压力</span><br><span class="line">3. JWT不仅可用于认证，还可用于信息交换。善用JWT有助于减少服务器请求数据库的次数，jwt的构成非常简单，字节占用很小，所以它是非常便于传输的。</span><br><span class="line"></span><br><span class="line">jwt的缺点：</span><br><span class="line">1. 数据保存在了客户端，我们服务端只认jwt，不识别客户端。</span><br><span class="line">2. jwt可以设置过期时间，但是因为数据保存在了客户端，所以对于过期时间不好调整。# secret_key轻易不要改，一改所有客户端都要重新登录</span><br></pre></td></tr></table></figure>
<p>认证流程图</p>
<p><img src="assets/1626513913826-5193877.png" alt="1626513913826"></p>
<p><strong>关于签发和核验JWT，我们可以使用Django REST framework JWT扩展来完成。</strong></p>
<p>文档网站 ; <a target="_blank" rel="noopener" href="https://jpadilla.github.io/django-rest-framework-jwt/">https://jpadilla.github.io/django-rest-framework-jwt/</a></p>
<h3 id="3-4-2、JWT安装与配置">3.4.2、JWT安装与配置</h3>
<h4 id="（1）安装">（1）安装</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-jwt -i https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>
<p>配置(github网址：<a target="_blank" rel="noopener" href="https://github.com/jpadilla/django-rest-framework-jwt">https://github.com/jpadilla/django-rest-framework-jwt</a>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 自定义异常处理</span></span><br><span class="line">    <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;uric_api.utils.exceptions.custom_exception_handler&#x27;</span>,</span><br><span class="line">    <span class="comment"># 自定义认证</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="comment"># jwt认证</span></span><br><span class="line">        <span class="string">&#x27;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#x27;</span>,</span><br><span class="line">        <span class="comment"># session认证</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.SessionAuthentication&#x27;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    <span class="comment"># jwt的有效时间</span></span><br><span class="line">    <span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>: datetime.timedelta(weeks=<span class="number">1</span>),</span><br><span class="line">    <span class="string">&#x27;JWT_ALLOW_REFRESH&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们django创建项目的时候，在settings配置文件中直接就给生成了一个serect_key，我们直接可以使用它作为我们jwt的serect_kek，其实djangorestframework-jwt默认配置中就使用的它。</p>
<h4 id="（2）获取token内置函数">（2）获取token内置函数</h4>
<p>Django REST framework JWT提供了登录获取token的视图，可以直接给这视图指定url路由即可使用。</p>
<p>在users子应用路由urls.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> obtain_jwt_token</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;login/&#x27;</span>, obtain_jwt_token),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在主路由中，引入当前子应用的路由文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">		...</span><br><span class="line">    path(<span class="string">&#x27;user/&#x27;</span>, include(<span class="string">&quot;users.urls&quot;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>接下来，我们可以通过postman来测试下功能，但是jwt是通过username和password来进行登录认证处理的，所以我们要给真实数据，jwt会去我们配置的user表中去查询用户数据的。</p>
<p>添加测试用户命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser </span><br><span class="line">用户名：yuan </span><br><span class="line">密码：123</span><br></pre></td></tr></table></figure>
<p>启动项目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver api.uric.cn:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220614%E4%B8%8B%E5%8D%8843120557-5195481.png" alt="image-20220614下午43120557"></p>
<p>得到的载荷信息，我们可以通过js内置的base64编码函数来读取里面内容。举例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> token = <span class="string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InJvb3QiLCJleHAiOjE2MjcxMTkzODQsImVtYWlsIjoiIn0.Xz_QJ5BPSOsjIB-EymwHaptgG-v1Ic8Aa0FhYhcEErE&quot;</span></span><br><span class="line"><span class="keyword">let</span> data = token.<span class="title function_">split</span>(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> user_info = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">atob</span>(data[<span class="number">1</span>]))   </span><br><span class="line"></span><br><span class="line"><span class="comment">// atob()   // base64解码</span></span><br><span class="line"><span class="comment">// btoa()   // base64编码</span></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220614%E4%B8%8B%E5%8D%8843713425-5195834.png" alt="image-20220614下午43713425"></p>
<h4 id="（3）验证token的有效性">（3）验证token的有效性</h4>
<p>配置路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> obtain_jwt_token,verify_jwt_token,refresh_jwt_token</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;login/&#x27;</span>, obtain_jwt_token),</span><br><span class="line">    path(<span class="string">&#x27;verify/&#x27;</span>, verify_jwt_token),  <span class="comment"># 这是只是校验token有效性</span></span><br><span class="line">    path(<span class="string">r&#x27;refresh_jwt_token/&#x27;</span>, refresh_jwt_token),  <span class="comment"># 校验并生成新的token</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>刷新token除了配置上面的refresh_jwt_token之外，还需要在配置文件中加上如下配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    <span class="comment"># &#x27;JWT_SECRET_KEY&#x27;: settings.SECRET_KEY,</span></span><br><span class="line">    <span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>: datetime.timedelta(seconds=<span class="number">30</span>),</span><br><span class="line">    <span class="string">&#x27;JWT_ALLOW_REFRESH&#x27;</span>: <span class="literal">True</span>,  <span class="comment"># 这个参数要改True，才能刷新token</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：必须在请求体中token键值对方式请求</p>
</blockquote>
<p>postman测试：</p>
<p>先获取token：</p>
<p><img src="assets/image-20220614%E4%B8%8B%E5%8D%8850719522-5197641.png" alt="image-20220614下午50719522"></p>
<p>验证token，有效期内通过：</p>
<p><img src="assets/image-20220614%E4%B8%8B%E5%8D%8850811708-5197695.png" alt="image-20220614下午50811708"></p>
<p>过了有效期：</p>
<p><img src="assets/image-20220614%E4%B8%8B%E5%8D%8850837025-5197718.png" alt="image-20220614下午50837025"></p>
<p>继续测试refresh_jwt_token的刷新token的功能：</p>
<p><img src="assets/image-20220614%E4%B8%8B%E5%8D%8852211646-5198533.png" alt="image-20220614下午52211646"></p>
<h2 id="3-5、登录认证客户端">3.5、登录认证客户端</h2>
<h3 id="3-5-1-本地存储token">3.5.1 本地存储token</h3>
<p><img src="assets/image-20220615%E4%B8%8A%E5%8D%8890119949-5254881.png" alt="image-20220615上午90119949"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;login box&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;../assets/login.jpg&quot; alt=&quot;&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;login-title&quot;&gt;</span><br><span class="line">                &lt;p class=&quot;hi&quot;&gt;Hello,Uric!&lt;/p&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;login_box&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;title&quot;&gt;</span><br><span class="line">                    &lt;span&gt;登录&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;inp&quot;&gt;</span><br><span class="line">                    &lt;a-input v-model:value=&quot;username&quot; type=&quot;text&quot; placeholder=&quot;用户名&quot; class=&quot;user&quot;&gt;&lt;/a-input&gt;</span><br><span class="line">                    &lt;a-input v-model:value=&quot;password&quot; type=&quot;password&quot; class=&quot;pwd&quot; placeholder=&quot;密码&quot;&gt;&lt;/a-input&gt;</span><br><span class="line">                    &lt;div class=&quot;rember&quot;&gt;</span><br><span class="line">                        &lt;p&gt;</span><br><span class="line">                            &lt;a-checkbox v-model:checked=&quot;remember&quot;&gt;记住密码&lt;/a-checkbox&gt;</span><br><span class="line">                        &lt;/p&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;button class=&quot;login_btn&quot; @click=&quot;login&quot;&gt;登录&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">                &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import axios from &quot;axios&quot;</span><br><span class="line"></span><br><span class="line">    export default &#123;</span><br><span class="line">        name: &#x27;Login&#x27;,</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                username: &#x27;&#x27;,</span><br><span class="line">                password: &#x27;&#x27;,</span><br><span class="line">                remember: false</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        methods: &#123;</span><br><span class="line"></span><br><span class="line">            login() &#123;</span><br><span class="line">               </span><br><span class="line">                axios.post(this.$settings.host + `/users/login/`, &#123;</span><br><span class="line">                    username: this.username,</span><br><span class="line">                    password: this.password,</span><br><span class="line">                &#125;).then((response) =&gt; &#123;</span><br><span class="line">                    // locatStorage或者sessionStorage中存储token</span><br><span class="line">                    // 先清空原有的token</span><br><span class="line">                    localStorage.removeItem(&quot;token&quot;);</span><br><span class="line">                    sessionStorage.removeItem(&quot;token&quot;);</span><br><span class="line"></span><br><span class="line">                    if (this.remember) &#123;</span><br><span class="line">                        // 记住登录</span><br><span class="line">                        localStorage.token = response.data.token;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        sessionStorage.token = response.data.token;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // 跳转到首页</span><br><span class="line">                    let self = this;</span><br><span class="line">                    this.$success(&#123;</span><br><span class="line">                        title: &#x27;uric系统提示&#x27;,</span><br><span class="line">                        content: `登录成功！`,</span><br><span class="line">                        onOk() &#123;</span><br><span class="line">                            self.$router.push(&quot;/uric&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                    // 下一个页面，首页加载时验证token有效性</span><br><span class="line">                &#125;).catch(error =&gt; &#123;</span><br><span class="line">                    this.$message.error(&#x27;用户名或者密码有误，请重新输入！&#x27;);</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .login .hi &#123;</span><br><span class="line">        font-size: 20px;</span><br><span class="line">        font-family: &quot;Times New Roman&quot;;</span><br><span class="line">        font-style: italic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .box &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 100%;</span><br><span class="line">        position: relative;</span><br><span class="line">        overflow: hidden;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .box img &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        min-height: 100%;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .box .login &#123;</span><br><span class="line">        position: absolute;</span><br><span class="line">        width: 500px;</span><br><span class="line">        height: 400px;</span><br><span class="line">        left: 0;</span><br><span class="line">        margin: auto;</span><br><span class="line">        right: 0;</span><br><span class="line">        bottom: 0;</span><br><span class="line">        top: -338px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login .login-title &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        text-align: center;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login-title img &#123;</span><br><span class="line">        width: 190px;</span><br><span class="line">        height: auto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login-title p &#123;</span><br><span class="line">        font-size: 18px;</span><br><span class="line">        color: #fff;</span><br><span class="line">        letter-spacing: .29px;</span><br><span class="line">        padding-top: 10px;</span><br><span class="line">        padding-bottom: 50px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_box &#123;</span><br><span class="line">        width: 400px;</span><br><span class="line">        height: auto;</span><br><span class="line">        background: rgba(255, 255, 255, 0.3);</span><br><span class="line">        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .5);</span><br><span class="line">        border-radius: 4px;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        padding-bottom: 40px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_box .title &#123;</span><br><span class="line">        font-size: 20px;</span><br><span class="line">        color: #9b9b9b;</span><br><span class="line">        letter-spacing: .32px;</span><br><span class="line">        border-bottom: 1px solid #e6e6e6;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: space-around;</span><br><span class="line">        padding: 50px 60px 0 60px;</span><br><span class="line">        margin-bottom: 20px;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_box .title span:nth-of-type(1) &#123;</span><br><span class="line">        color: #4a4a4a;</span><br><span class="line">        border-bottom: 2px solid #396fcc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp &#123;</span><br><span class="line">        width: 350px;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp input &#123;</span><br><span class="line">        outline: 0;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 45px;</span><br><span class="line">        border-radius: 4px;</span><br><span class="line">        border: 1px solid #d9d9d9;</span><br><span class="line">        text-indent: 20px;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        background: #fff !important;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp input.user &#123;</span><br><span class="line">        margin-bottom: 16px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: space-between;</span><br><span class="line">        align-items: center;</span><br><span class="line">        position: relative;</span><br><span class="line">        margin-top: 10px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember p:first-of-type &#123;</span><br><span class="line">        font-size: 12px;</span><br><span class="line">        color: #4a4a4a;</span><br><span class="line">        letter-spacing: .19px;</span><br><span class="line">        margin-left: 22px;</span><br><span class="line">        display: -ms-flexbox;</span><br><span class="line">        display: flex;</span><br><span class="line">        -ms-flex-align: center;</span><br><span class="line">        align-items: center;</span><br><span class="line">        /*position: relative;*/</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember p:nth-of-type(2) &#123;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        color: #9b9b9b;</span><br><span class="line">        letter-spacing: .19px;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember input &#123;</span><br><span class="line">        outline: 0;</span><br><span class="line">        width: 30px;</span><br><span class="line">        height: 45px;</span><br><span class="line">        border-radius: 4px;</span><br><span class="line">        border: 1px solid #d9d9d9;</span><br><span class="line">        text-indent: 20px;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        background: #fff !important;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember p span &#123;</span><br><span class="line">        display: inline-block;</span><br><span class="line">        font-size: 12px;</span><br><span class="line">        width: 100px;</span><br><span class="line">        /*position: absolute;*/</span><br><span class="line">        /*left: 20px;*/</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #geetest &#123;</span><br><span class="line">        margin-top: 20px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_btn &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 45px;</span><br><span class="line">        background: #396fcc;</span><br><span class="line">        border-radius: 5px;</span><br><span class="line">        font-size: 16px;</span><br><span class="line">        color: #fff;</span><br><span class="line">        letter-spacing: .26px;</span><br><span class="line">        margin-top: 30px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .go_login &#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        color: #9b9b9b;</span><br><span class="line">        letter-spacing: .26px;</span><br><span class="line">        padding-top: 20px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .go_login span &#123;</span><br><span class="line">        color: #84cc39;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-2-基于vuex对本地数据持久化存储">3.5.2 基于vuex对本地数据持久化存储</h3>
<p>Vuex 是一个专门为 Vue.js 应用程序开发的状态管理模式，它采用集中式存储管理应用的所有组件状态，并以相应的规则保证状态以一种可预测的方式发生变化。可以理解为：将多个组件共享的变量全部存储在一个对象里面，然后将这个对象放在顶层的 Vue 实例中，让其他组件可以使用，它最大的特点是响应式。</p>
<p>一般情况下，我们会在 Vuex 中存放一些需要在多个界面中进行共享的信息。比如用户的登录状态、用户名称、头像、地理位置信息、商品的收藏、购物车中的物品等，这些状态信息，我们可以放在统一的地方，对它进行保存和管理。</p>
<p>安装依赖包:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install vuex</span><br><span class="line">import createPersistedState from <span class="string">&#x27;vuex-persistedstate&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在src路径下创建store文件夹下创建index.js文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createStore&#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> createPersistedState <span class="keyword">from</span> <span class="string">&#x27;vuex-persistedstate&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">token</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">remember</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [<span class="title function_">createPersistedState</span>(&#123; <span class="comment">// setState,getState自动触发,防止刷新vuex清空，所以存到本地</span></span><br><span class="line">        <span class="attr">key</span>: <span class="string">&#x27;vuex&#x27;</span>,</span><br><span class="line">        <span class="title function_">setState</span>(<span class="params">key, state</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (state.<span class="property">remember</span>) &#123;</span><br><span class="line">                <span class="variable language_">localStorage</span>[key] = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sessionStorage[key] = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">getState</span>(<span class="params">key, state</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">localStorage</span>[key]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>[key])</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(sessionStorage[key])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)],</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">        <span class="title function_">get_user_info</span>(<span class="params">state, getters</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> data = state.<span class="property">token</span>.<span class="title function_">split</span>(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">atob</span>(data[<span class="number">1</span>]))</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">token</span>(<span class="params">state, getters</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state.<span class="property">token</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">remember</span>(<span class="params">state, getters</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state.<span class="property">remember</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;  <span class="comment">// 类似methods</span></span><br><span class="line">        <span class="title function_">setToken</span>(<span class="params">state, token</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置本地保存token</span></span><br><span class="line">            state.<span class="property">token</span> = token</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">setRemember</span>(<span class="params">state, remember</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置记住登陆状态</span></span><br><span class="line">            <span class="comment">// localStorage.removeItem(&#x27;vuex&#x27;);</span></span><br><span class="line">            <span class="comment">// sessionStorage.removeItem(&#x27;vuex&#x27;);</span></span><br><span class="line">            state.<span class="property">remember</span> = remember</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在main.js中加入代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line">app.<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">use</span>(<span class="title class_">Antd</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>Login.vue代码更新为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;login box&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;../assets/login.jpg&quot; alt=&quot;&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;login-title&quot;&gt;</span><br><span class="line">                &lt;p class=&quot;hi&quot;&gt;Hello,Urils!&lt;/p&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;login_box&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;title&quot;&gt;</span><br><span class="line">                    &lt;span&gt;登录&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;inp&quot;&gt;</span><br><span class="line">                    &lt;a-input v-model:value=&quot;username&quot; type=&quot;text&quot; placeholder=&quot;用户名&quot; class=&quot;user&quot;&gt;&lt;/a-input&gt;</span><br><span class="line">                    &lt;a-input v-model:value=&quot;password&quot; type=&quot;password&quot; class=&quot;pwd&quot; placeholder=&quot;密码&quot;&gt;&lt;/a-input&gt;</span><br><span class="line">                    &lt;div class=&quot;rember&quot;&gt;</span><br><span class="line">                        &lt;p&gt;</span><br><span class="line">                            &lt;a-checkbox v-model:checked=&quot;remember&quot;&gt;记住密码&lt;/a-checkbox&gt;</span><br><span class="line">                        &lt;/p&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;button class=&quot;login_btn&quot; @click=&quot;login&quot;&gt;登录&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">                &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import axios from &quot;axios&quot;</span><br><span class="line"></span><br><span class="line">    export default &#123;</span><br><span class="line">        name: &#x27;Login&#x27;,</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                username: &#x27;yuan&#x27;,</span><br><span class="line">                password: &#x27;123&#x27;,</span><br><span class="line">                remember: true // 记录登陆状态</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        watch: &#123; // 监听数据是否发生变化</span><br><span class="line">            remember() &#123;</span><br><span class="line">                this.$store.commit(&#x27;setRemember&#x27;, this.remember);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        created() &#123;</span><br><span class="line">            // 默认用户没有记录登陆状态</span><br><span class="line">            this.remember = this.$store.state.remember;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            login() &#123;</span><br><span class="line">                axios.post(`$&#123;this.$settings.host&#125;/users/login/`, &#123;</span><br><span class="line">                    username: this.username,</span><br><span class="line">                    password: this.password</span><br><span class="line">                &#125;).then(response =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                    // vuex存储token</span><br><span class="line">                    this.$store.commit(&#x27;setToken&#x27;, response.data.token);</span><br><span class="line"></span><br><span class="line">                    let self = this;</span><br><span class="line">                    this.$success(&#123;</span><br><span class="line">                        title: &#x27;Uric系统提示&#x27;,</span><br><span class="line">                        content: &#x27;登陆成功！欢迎回来！&#x27;,</span><br><span class="line">                        onOk() &#123;</span><br><span class="line">                            // 在这里，不能直接使用this，因为此处的this被重新赋值了，不再是原来的外界的vue对象了，而是一个antd-vue提供的对话框对象了</span><br><span class="line">                            self.$router.push(&#x27;/&#x27;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;).catch((res) =&gt; &#123;</span><br><span class="line">                    // 登陆失败！</span><br><span class="line">                    this.$message.error(&#x27;用户名或者密码有误，请重新输入！&#x27;);</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .login .hi &#123;</span><br><span class="line">        font-size: 20px;</span><br><span class="line">        font-family: &quot;Times New Roman&quot;;</span><br><span class="line">        font-style: italic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .box &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 100%;</span><br><span class="line">        position: relative;</span><br><span class="line">        overflow: hidden;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .box img &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        min-height: 100%;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .box .login &#123;</span><br><span class="line">        position: absolute;</span><br><span class="line">        width: 500px;</span><br><span class="line">        height: 400px;</span><br><span class="line">        left: 0;</span><br><span class="line">        margin: auto;</span><br><span class="line">        right: 0;</span><br><span class="line">        bottom: 0;</span><br><span class="line">        top: -338px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login .login-title &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        text-align: center;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login-title img &#123;</span><br><span class="line">        width: 190px;</span><br><span class="line">        height: auto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login-title p &#123;</span><br><span class="line">        font-size: 18px;</span><br><span class="line">        color: #fff;</span><br><span class="line">        letter-spacing: .29px;</span><br><span class="line">        padding-top: 10px;</span><br><span class="line">        padding-bottom: 50px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_box &#123;</span><br><span class="line">        width: 400px;</span><br><span class="line">        height: auto;</span><br><span class="line">        background: rgba(255, 255, 255, 0.3);</span><br><span class="line">        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .5);</span><br><span class="line">        border-radius: 4px;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        padding-bottom: 40px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_box .title &#123;</span><br><span class="line">        font-size: 20px;</span><br><span class="line">        color: #9b9b9b;</span><br><span class="line">        letter-spacing: .32px;</span><br><span class="line">        border-bottom: 1px solid #e6e6e6;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: space-around;</span><br><span class="line">        padding: 50px 60px 0 60px;</span><br><span class="line">        margin-bottom: 20px;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_box .title span:nth-of-type(1) &#123;</span><br><span class="line">        color: #4a4a4a;</span><br><span class="line">        border-bottom: 2px solid #396fcc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp &#123;</span><br><span class="line">        width: 350px;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp input &#123;</span><br><span class="line">        outline: 0;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 45px;</span><br><span class="line">        border-radius: 4px;</span><br><span class="line">        border: 1px solid #d9d9d9;</span><br><span class="line">        text-indent: 20px;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        background: #fff !important;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp input.user &#123;</span><br><span class="line">        margin-bottom: 16px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: space-between;</span><br><span class="line">        align-items: center;</span><br><span class="line">        position: relative;</span><br><span class="line">        margin-top: 10px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember p:first-of-type &#123;</span><br><span class="line">        font-size: 12px;</span><br><span class="line">        color: #4a4a4a;</span><br><span class="line">        letter-spacing: .19px;</span><br><span class="line">        margin-left: 22px;</span><br><span class="line">        display: -ms-flexbox;</span><br><span class="line">        display: flex;</span><br><span class="line">        -ms-flex-align: center;</span><br><span class="line">        align-items: center;</span><br><span class="line">        /*position: relative;*/</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember p:nth-of-type(2) &#123;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        color: #9b9b9b;</span><br><span class="line">        letter-spacing: .19px;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember input &#123;</span><br><span class="line">        outline: 0;</span><br><span class="line">        width: 30px;</span><br><span class="line">        height: 45px;</span><br><span class="line">        border-radius: 4px;</span><br><span class="line">        border: 1px solid #d9d9d9;</span><br><span class="line">        text-indent: 20px;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        background: #fff !important;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .rember p span &#123;</span><br><span class="line">        display: inline-block;</span><br><span class="line">        font-size: 12px;</span><br><span class="line">        width: 100px;</span><br><span class="line">        /*position: absolute;*/</span><br><span class="line">        /*left: 20px;*/</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #geetest &#123;</span><br><span class="line">        margin-top: 20px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .login_btn &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 45px;</span><br><span class="line">        background: #396fcc;</span><br><span class="line">        border-radius: 5px;</span><br><span class="line">        font-size: 16px;</span><br><span class="line">        color: #fff;</span><br><span class="line">        letter-spacing: .26px;</span><br><span class="line">        margin-top: 30px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .go_login &#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        color: #9b9b9b;</span><br><span class="line">        letter-spacing: .26px;</span><br><span class="line">        padding-top: 20px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .inp .go_login span &#123;</span><br><span class="line">        color: #84cc39;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220615%E4%B8%8B%E5%8D%88121233037-5266354.png" alt="image-20220615下午121233037"></p>
<h3 id="3-5-3、后端token验证">3.5.3、后端token验证</h3>
<p>配置文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 自定义异常处理</span></span><br><span class="line">    <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="string">&#x27;uric_api.utils.exceptions.custom_exception_handler&#x27;</span>,</span><br><span class="line">    <span class="comment"># 自定义认证</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="comment"># jwt认证</span></span><br><span class="line">        <span class="string">&#x27;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_PERMISSION_CLASSES&#x27;: (&#x27;rest_framework.permissions.IsAuthenticated&#x27;,)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>视图更新为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    permission_classes = [IsAuthenticated, ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, reqeust</span>):</span><br><span class="line">        data = [</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">                       <span class="string">&#x27;category_name&#x27;</span>: <span class="string">&#x27;数据库服务器&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;izbp13e05jqwodd605vm3gz&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;ip_addr&#x27;</span>: <span class="string">&#x27;47.58.131.12&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;port&#x27;</span>: <span class="number">22</span>,</span><br><span class="line">                       <span class="string">&#x27;remark&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">                       <span class="string">&#x27;category_name&#x27;</span>: <span class="string">&#x27;数据库服务器&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;iZbp1a3jw4l12ho53ivhkkZ&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;ip_addr&#x27;</span>: <span class="string">&#x27;12.18.125.22&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;port&#x27;</span>: <span class="number">22</span>,</span><br><span class="line">                       <span class="string">&#x27;remark&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">                       <span class="string">&#x27;category_name&#x27;</span>: <span class="string">&#x27;缓存服务器&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;iZbp1b1xqfqw257gs563k2iZ&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;ip_addr&#x27;</span>: <span class="string">&#x27;12.19.135.130&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;port&#x27;</span>: <span class="number">22</span>,</span><br><span class="line">                       <span class="string">&#x27;remark&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="string">&#x27;id&#x27;</span>: <span class="number">4</span>,</span><br><span class="line">                       <span class="string">&#x27;category_name&#x27;</span>: <span class="string">&#x27;缓存服务器&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;iZbp1b1jw4l01ho53muhkkZ&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;ip_addr&#x27;</span>: <span class="string">&#x27;47.98.101.89&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;port&#x27;</span>: <span class="number">22</span>,</span><br><span class="line">                       <span class="string">&#x27;remark&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               ],</span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220617%E4%B8%8B%E5%8D%8833536492-5451338.png" alt="image-20220617下午33536492"></p>
<p><img src="assets/image-20220617%E4%B8%8B%E5%8D%8833601994-5451363.png" alt="image-20220617下午33601994"></p>
<h3 id="3-5-4、路由守卫">3.5.4、路由守卫</h3>
<p><code>Host.vue</code>发送ajax请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h3&gt;主机管理&lt;/h3&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Host&quot;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    axios.get(this.$settings.host + &quot;/host&quot;, &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        &quot;Authorization&quot;: &quot;jwt &quot; + this.$store.getters.token</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).then((res) =&gt; &#123;</span><br><span class="line">      console.log(&quot;res:&quot;, res)</span><br><span class="line"></span><br><span class="line">    &#125;).catch((err) =&gt; &#123;</span><br><span class="line">      console.log(&quot;err:&quot;, err)</span><br><span class="line">      this.$router.push(&quot;/login&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>有些页面需要验证才能访问，可以通过路由守卫完成</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createRouter, createWebHistory&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Login.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Base</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Base&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ShowCenter</span> <span class="keyword">from</span> <span class="string">&#x27;../views/ShowCenter&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Host</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Host&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&quot;../store&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/uric&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: <span class="string">&#x27;/&#x27;</span>, <span class="comment">// 给当前路径起一个别名</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Base&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Base</span>, <span class="comment">// 快捷键：Alt+Enter快速导包,</span></span><br><span class="line">        <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">meta</span>: &#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="string">&#x27;展示中心&#x27;</span>,</span><br><span class="line">                    <span class="attr">authenticate</span>: <span class="literal">false</span>,</span><br><span class="line">                &#125;,</span><br><span class="line"></span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;show_center&#x27;</span>,</span><br><span class="line">                <span class="attr">alias</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 给当前路径起一个别名</span></span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;ShowCenter&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">ShowCenter</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">meta</span>: &#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="string">&#x27;主机管理&#x27;</span>,</span><br><span class="line">                    <span class="attr">authenticate</span>: <span class="literal">true</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;host&#x27;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;Host&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">Host</span></span><br><span class="line">            &#125;,</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;账户登陆&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Login</span> <span class="comment">// 快捷键：Alt+Enter快速导包</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">    routes</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由守卫，主要是编写一些在页面跳转过程中， 需要自动执行的代码。例如：修改页面头部标题，验证权限。</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&quot;页面跳转&quot;</span>);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = to.<span class="property">meta</span>.<span class="property">title</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;token:::&quot;</span>, store.<span class="property">getters</span>.<span class="property">token</span>);</span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">meta</span>.<span class="property">authenticate</span> &amp;&amp; (store.<span class="property">getters</span>.<span class="property">token</span> === <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 如果访问需要登录的页面，但是没有token则默认跳转到login登陆页面</span></span><br><span class="line">        <span class="title function_">next</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-5-5、注销">3.5.5、注销</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout style=&quot;min-height: 100vh&quot;&gt;</span><br><span class="line">    &lt;a-layout-sider v-model:collapsed=&quot;collapsed&quot; collapsible&gt;</span><br><span class="line">      &lt;div class=&quot;logo&quot;</span><br><span class="line">           style=&quot;font-style: italic;text-align: center;font-size: 20px;color:#fff;margin: 10px 0;line-height: 50px;font-family: &#x27;Times New Roman&#x27;&quot;&gt;</span><br><span class="line">        &lt;span&gt;&lt;a-switch v-model:checked=&quot;checked&quot;/&gt; DevOps&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;logo&quot;/&gt;</span><br><span class="line">      &lt;a-menu v-for=&quot;menu in menu_list&quot; v-model:selectedKeys=&quot;selectedKeys&quot; theme=&quot;dark&quot; mode=&quot;inline&quot;&gt;</span><br><span class="line">        &lt;a-menu-item v-if=&quot;menu.children.length===0&quot; :key=&quot;menu.id&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;router-link :to=&quot;menu.menu_url&quot;&gt;</span><br><span class="line">            &lt;desktop-outlined/&gt;</span><br><span class="line">            &lt;span&gt; &#123;&#123; menu.title &#125;&#125;&lt;/span&gt;</span><br><span class="line">          &lt;/router-link&gt;</span><br><span class="line">        &lt;/a-menu-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-sub-menu v-else :key=&quot;menu.id&quot;&gt;</span><br><span class="line">          &lt;template #title&gt;</span><br><span class="line">            &lt;span&gt;</span><br><span class="line">              &lt;user-outlined/&gt;</span><br><span class="line">              &lt;span&gt;&#123;&#123; menu.title &#125;&#125;&lt;/span&gt;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">          &lt;/template&gt;</span><br><span class="line">          &lt;a-menu-item v-for=&quot;child_menu in menu.children&quot; :key=&quot;child_menu.id&quot;&gt;</span><br><span class="line">            &lt;router-link :to=&quot;child_menu.menu_url&quot;&gt;&#123;&#123; child_menu.title &#125;&#125;&lt;/router-link&gt;</span><br><span class="line">          &lt;/a-menu-item&gt;</span><br><span class="line">        &lt;/a-sub-menu&gt;</span><br><span class="line">      &lt;/a-menu&gt;</span><br><span class="line">    &lt;/a-layout-sider&gt;</span><br><span class="line">    &lt;a-layout&gt;</span><br><span class="line">      &lt;a-layout-header style=&quot;background: #fff; padding: 20px&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;a-row type=&quot;flex&quot; justify=&quot;start&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;a-col :span=&quot;6&quot;&gt;</span><br><span class="line">            &lt;a-breadcrumb&gt;</span><br><span class="line">              &lt;a-breadcrumb-item href=&quot;&quot;&gt;</span><br><span class="line">                &lt;home-outlined/&gt;</span><br><span class="line">              &lt;/a-breadcrumb-item&gt;</span><br><span class="line">              &lt;a-breadcrumb-item href=&quot;&quot;&gt;</span><br><span class="line">                &lt;user-outlined/&gt;</span><br><span class="line">                &lt;span&gt;Application List&lt;/span&gt;</span><br><span class="line">              &lt;/a-breadcrumb-item&gt;</span><br><span class="line">              &lt;a-breadcrumb-item&gt;Application&lt;/a-breadcrumb-item&gt;</span><br><span class="line">            &lt;/a-breadcrumb&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">          &lt;a-col :span=&quot;1&quot; :offset=&quot;17&quot;&gt;</span><br><span class="line">            &lt;a-breadcrumb&gt;</span><br><span class="line">              &lt;a-button @click=&quot;logout&quot; type=&quot;primary&quot; class=&quot;logout&quot;&gt;</span><br><span class="line">                注销</span><br><span class="line">              &lt;/a-button&gt;</span><br><span class="line">            &lt;/a-breadcrumb&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/a-row&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/a-layout-header&gt;</span><br><span class="line"></span><br><span class="line">      &lt;a-layout-content style=&quot;margin: 0 16px&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/a-layout-content&gt;</span><br><span class="line">      &lt;a-layout-footer style=&quot;text-align: center&quot;&gt;</span><br><span class="line">        Ant Design ©2018 Created by Ant UED</span><br><span class="line">      &lt;/a-layout-footer&gt;</span><br><span class="line">    &lt;/a-layout&gt;</span><br><span class="line">  &lt;/a-layout&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import &#123;</span><br><span class="line">  DesktopOutlined,</span><br><span class="line">  FileOutlined,</span><br><span class="line">  PieChartOutlined,</span><br><span class="line">  TeamOutlined,</span><br><span class="line">  UserOutlined,</span><br><span class="line">  HomeOutlined</span><br><span class="line">&#125; from &#x27;@ant-design/icons-vue&#x27;;</span><br><span class="line">import &#123;defineComponent, ref&#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const checked = ref(true);</span><br><span class="line">    return &#123;</span><br><span class="line">      checked,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    PieChartOutlined,</span><br><span class="line">    DesktopOutlined,</span><br><span class="line">    UserOutlined,</span><br><span class="line">    TeamOutlined,</span><br><span class="line">    FileOutlined,</span><br><span class="line">    HomeOutlined,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      collapsed: ref(false),</span><br><span class="line">      selectedKeys: ref([&#x27;1&#x27;]),</span><br><span class="line">      menu_list: [</span><br><span class="line">        &#123;</span><br><span class="line">          id: 1, icon: &#x27;mail&#x27;, title: &#x27;展示中心&#x27;, tube: &#x27;&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/show_center&#x27;, children: []</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          id: 2, icon: &#x27;mail&#x27;, title: &#x27;资产管理&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/host&#x27;, children: []</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;id&quot;: 3, icon: &#x27;bold&#x27;, title: &#x27;批量任务&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;, children: [</span><br><span class="line">            &#123;id: 10, icon: &#x27;mail&#x27;, title: &#x27;执行任务&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/multi_exec&#x27;&#125;,</span><br><span class="line">            &#123;id: 11, icon: &#x27;mail&#x27;, title: &#x27;命令管理&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/template_manage&#x27;&#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          id: 4, icon: &#x27;highlight&#x27;, title: &#x27;代码发布&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;, children: [</span><br><span class="line">            &#123;id: 12, title: &#x27;应用管理&#x27;, menu_url: &#x27;/uric/release&#x27;&#125;,</span><br><span class="line">            &#123;id: 13, title: &#x27;发布申请&#x27;, menu_url: &#x27;/uric/release&#x27;&#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;id: 5, icon: &#x27;mail&#x27;, title: &#x27;定时计划&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;, children: []&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          id: 6, icon: &#x27;mail&#x27;, title: &#x27;配置管理&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;, children: [</span><br><span class="line">            &#123;id: 14, title: &#x27;环境管理&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/environment&#x27;&#125;,</span><br><span class="line">            &#123;id: 15, title: &#x27;服务配置&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;&#125;,</span><br><span class="line">            &#123;id: 16, title: &#x27;应用配置&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;&#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;id: 7, icon: &#x27;mail&#x27;, title: &#x27;监控预警&#x27;, tube: &#x27;&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;, children: []&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          id: 8, icon: &#x27;mail&#x27;, title: &#x27;报警&#x27;, tube: &#x27;&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;, children: [</span><br><span class="line">            &#123;id: 17, title: &#x27;报警历史&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;&#125;,</span><br><span class="line">            &#123;id: 18, title: &#x27;报警联系人&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;&#125;,</span><br><span class="line">            &#123;id: 19, title: &#x27;报警联系组&#x27;, &#x27;menu_url&#x27;: &#x27;/uric/workbench&#x27;&#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          id: 9, icon: &#x27;mail&#x27;, title: &#x27;用户管理&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;, children: [</span><br><span class="line">            &#123;id: 20, title: &#x27;账户管理&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;&#125;,</span><br><span class="line">            &#123;id: 21, title: &#x27;角色管理&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;&#125;,</span><br><span class="line">            &#123;id: 22, title: &#x27;系统设置&#x27;, tube: &#x27;&#x27;, menu_url: &#x27;/uric/workbench&#x27;&#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    logout() &#123;</span><br><span class="line">      let self = this;</span><br><span class="line">      this.$confirm(&#123;</span><br><span class="line">        title: &#x27;Uric系统提示&#x27;,</span><br><span class="line">        content: &#x27;您确认要注销登陆吗？&#x27;,</span><br><span class="line">        onOk() &#123;</span><br><span class="line">          self.$store.commit(&#x27;setToken&#x27;, &#x27;&#x27;)</span><br><span class="line">          self.$router.push(&#x27;/login&#x27;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">#components-layout-demo-side .logo &#123;</span><br><span class="line">  height: 32px;</span><br><span class="line">  margin: 16px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.site-layout .site-layout-background &#123;</span><br><span class="line">  background: #fff;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[data-theme=&#x27;dark&#x27;] .site-layout .site-layout-background &#123;</span><br><span class="line">  background: #141414;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.logout &#123;</span><br><span class="line">  line-height: 1.5715;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220622165429932-5888071.png" alt="image-20220622165429932"></p>
<h1>四 主机管理</h1>
<h2 id="4-1、主机基本功能">4.1、主机基本功能</h2>
<h3 id="4-1-1、前端页面初始化">4.1.1、前端页面初始化</h3>
<p><img src="assets/image-20220623184312459-5980993.png" alt="image-20220623184312459"></p>
<p>Host.vue代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-row&gt;</span><br><span class="line">    &lt;a-col :span=&quot;6&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;add_host&quot; style=&quot;margin: 15px;&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-button @click=&quot;showHostModal&quot; type=&quot;primary&quot;&gt;</span><br><span class="line">          新建</span><br><span class="line">        &lt;/a-button&gt;</span><br><span class="line">        &lt;a-button type=&quot;primary&quot; style=&quot;margin-left: 20px;&quot;&gt;</span><br><span class="line">          批量导入</span><br><span class="line">        &lt;/a-button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/a-row&gt;</span><br><span class="line">  &lt;a-table bordered :dataSource=&quot;hostList.data&quot; :columns=&quot;hostFormColumns&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;action&#x27;&quot;&gt;</span><br><span class="line">        &lt;a-popconfirm</span><br><span class="line">            v-if=&quot;hostList.data.length&quot;</span><br><span class="line">            title=&quot;Sure to delete?&quot;</span><br><span class="line">            @confirm=&quot;deleteHost(record)&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;a&gt;Delete&lt;/a&gt;</span><br><span class="line">        &lt;/a-popconfirm&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;a-modal v-model:visible=&quot;hostFormVisible&quot; title=&quot;添加主机&quot; @ok=&quot;onHostFormSubmit&quot; @cancel=&quot;resetForm()&quot; :width=&quot;800&quot;&gt;</span><br><span class="line">      &lt;a-form</span><br><span class="line">          ref=&quot;formRef&quot;</span><br><span class="line">          name=&quot;custom-validation&quot;</span><br><span class="line">          :model=&quot;hostForm.form&quot;</span><br><span class="line">          :rules=&quot;hostForm.rules&quot;</span><br><span class="line">          v-bind=&quot;layout&quot;</span><br><span class="line">          @finish=&quot;handleFinish&quot;</span><br><span class="line">          @validate=&quot;handleValidate&quot;</span><br><span class="line">          @finishFailed=&quot;handleFinishFailed&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;a-form-item label=&quot;主机类别&quot; prop=&quot;zone&quot; name=&quot;category&quot;&gt;</span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;12&quot;&gt;</span><br><span class="line">              &lt;a-select</span><br><span class="line">                  ref=&quot;select&quot;</span><br><span class="line">                  v-model:value=&quot;hostForm.form.category&quot;</span><br><span class="line">                  @change=&quot;handleCategorySelectChange&quot;</span><br><span class="line"></span><br><span class="line">              &gt;</span><br><span class="line">                &lt;a-select-option :value=&quot;category.id&quot; v-for=&quot;category in categoryList.data&quot; :key=&quot;category.id&quot;&gt;</span><br><span class="line">                  &#123;&#123; category.name &#125;&#125;</span><br><span class="line">                &lt;/a-select-option&gt;</span><br><span class="line">              &lt;/a-select&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;主机名称&quot; name=&quot;name&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;hostForm.form.name&quot; type=&quot;text&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;连接地址&quot; name=&quot;username&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;用户名&quot; addon-before=&quot;ssh&quot; v-model:value=&quot;hostForm.form.username&quot; type=&quot;text&quot;</span><br><span class="line">                       autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;ip地址&quot; addon-before=&quot;@&quot; v-model:value=&quot;hostForm.form.ip_addr&quot; type=&quot;text&quot;</span><br><span class="line">                       autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;端口号&quot; addon-before=&quot;-p&quot; v-model:value=&quot;hostForm.form.port&quot; type=&quot;text&quot;</span><br><span class="line">                       autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;连接密码&quot; name=&quot;password&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;hostForm.form.password&quot; type=&quot;password&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;备注信息&quot; name=&quot;remark&quot;&gt;</span><br><span class="line">          &lt;a-textarea placeholder=&quot;请输入主机备注信息&quot; v-model:value=&quot;hostForm.form.remark&quot; type=&quot;text&quot;</span><br><span class="line">                      :auto-size=&quot;&#123; minRows: 3, maxRows: 5 &#125;&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;a-form-item :wrapper-col=&quot;&#123; span: 14, offset: 4 &#125;&quot;&gt;</span><br><span class="line">          &lt;a-button @click=&quot;resetForm&quot;&gt;Reset&lt;/a-button&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">      &lt;/a-form&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/a-modal&gt;</span><br><span class="line">    &lt;a-modal</span><br><span class="line">        :width=&quot;600&quot;</span><br><span class="line">        title=&quot;新建主机类别&quot;</span><br><span class="line">        :visible=&quot;HostCategoryFromVisible&quot;</span><br><span class="line">        @cancel=&quot;hostCategoryFormCancel&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;template #footer&gt;</span><br><span class="line">        &lt;a-button key=&quot;back&quot; @click=&quot;hostCategoryFormCancel&quot;&gt;取消&lt;/a-button&gt;</span><br><span class="line">        &lt;a-button key=&quot;submit&quot; type=&quot;primary&quot; :loading=&quot;loading&quot; @click=&quot;onHostCategoryFromSubmit&quot;&gt;提交&lt;/a-button&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;a-form-model ref=&quot;hostCategoryRuleForm&quot; v-model:value=&quot;hostCategoryForm.form&quot; :rules=&quot;hostCategoryForm.rules&quot;</span><br><span class="line">                    :label-col=&quot;hostCategoryForm.labelCol&quot; :wrapper-col=&quot;hostCategoryForm.wrapperCol&quot;&gt;</span><br><span class="line">        &lt;a-form-model-item ref=&quot;name&quot; label=&quot;类别名称&quot; prop=&quot;name&quot;&gt;</span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;24&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;请输入主机类别名称&quot; v-model:value=&quot;hostCategoryForm.form.name&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line">        &lt;/a-form-model-item&gt;</span><br><span class="line">      &lt;/a-form-model&gt;</span><br><span class="line">    &lt;/a-modal&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;defineComponent, ref, reactive&#125; from &#x27;vue&#x27;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import settings from &quot;@/settings&quot;;</span><br><span class="line">import store from &quot;@/store&quot;;</span><br><span class="line">import &#123;message&#125; from &#x27;ant-design-vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    const handleChange = value =&gt; &#123;</span><br><span class="line">      console.log(`selected $&#123;value&#125;`);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleCategorySelectChange = (value) =&gt; &#123;</span><br><span class="line">      // 切换主机类别的回调处理</span><br><span class="line">      console.log(value)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const formRef = ref();</span><br><span class="line">    const HostCategoryFromVisible = ref(false);</span><br><span class="line">    const hostList = reactive(&#123;</span><br><span class="line">      data: [</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 1,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;izbp13e05jqwodd605vm3gz&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;47.58.131.12&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 2,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;iZbp1a3jw4l12ho53ivhkkZ&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;12.18.125.22&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 3,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;iZbp1b1xqfqw257gs563k2iZ&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;12.19.135.130&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 4,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;iZbp1b1jw4l01ho53muhkkZ&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;47.98.101.89&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line">    const categoryList = reactive(&#123;</span><br><span class="line">      data: [</span><br><span class="line">        &#123;&#x27;id&#x27;: 1, &#x27;name&#x27;: &#x27;数据库服务&#x27;&#125;,</span><br><span class="line">        &#123;&#x27;id&#x27;: 2, &#x27;name&#x27;: &#x27;缓存服务&#x27;&#125;,</span><br><span class="line">        &#123;&#x27;id&#x27;: 3, &#x27;name&#x27;: &#x27;web服务&#x27;&#125;,</span><br><span class="line">        &#123;&#x27;id&#x27;: 4, &#x27;name&#x27;: &#x27;静态文件存储服务&#x27;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    const hostForm = reactive(&#123;</span><br><span class="line">      labelCol: &#123;span: 6&#125;,</span><br><span class="line">      wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">      other: &#x27;&#x27;,</span><br><span class="line">      form: &#123;</span><br><span class="line">        name: &#x27;&#x27;,</span><br><span class="line">        category: &quot;&quot;,</span><br><span class="line">        ip_addr: &#x27;&#x27;,</span><br><span class="line">        username: &#x27;&#x27;,</span><br><span class="line">        port: &#x27;&#x27;,</span><br><span class="line">        remark: &#x27;&#x27;,</span><br><span class="line">        password: &#x27;&#x27;</span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line">        name: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入主机名称&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        password: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入连接密码&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        category: [</span><br><span class="line">          &#123;required: true, message: &#x27;请选择类别&#x27;, trigger: &#x27;change&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        username: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入用户名&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        ip_addr: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入连接地址&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;max: 15, message: &#x27;长度最大15位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        port: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入端口号&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;max: 5, message: &#x27;长度最大5位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    let validateName = async (_rule, value) =&gt; &#123;</span><br><span class="line">      if (value === &#x27;&#x27;) &#123;</span><br><span class="line">        return Promise.reject(&#x27;请输入类别名称&#x27;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return Promise.resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    const hostCategoryForm = reactive(&#123;</span><br><span class="line">      labelCol: &#123;span: 6&#125;,</span><br><span class="line">      wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">      other: &#x27;&#x27;,</span><br><span class="line">      form: &#123;</span><br><span class="line">        name: &#x27;&#x27;</span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line">        name: [&#123;</span><br><span class="line">          required: true,</span><br><span class="line">          message: &#x27;请输入类别名称&#x27;,</span><br><span class="line">          validator: validateName,</span><br><span class="line">          trigger: &#x27;blur&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    const layout = &#123;</span><br><span class="line">      labelCol: &#123;</span><br><span class="line">        span: 4,</span><br><span class="line">      &#125;,</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        span: 14,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleFinish = values =&gt; &#123;</span><br><span class="line">      console.log(values, hostForm);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleFinishFailed = errors =&gt; &#123;</span><br><span class="line">      console.log(errors);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const resetForm = () =&gt; &#123;</span><br><span class="line">      formRef.value.resetFields();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleValidate = (...args) =&gt; &#123;</span><br><span class="line">      console.log(args);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const hostFormVisible = ref(false);</span><br><span class="line"></span><br><span class="line">    const showHostModal = () =&gt; &#123;</span><br><span class="line">      hostFormVisible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const showHostCategoryFormModal = () =&gt; &#123;</span><br><span class="line">      // 显示添加主机类别的表单窗口</span><br><span class="line">      HostCategoryFromVisible.value = true</span><br><span class="line">    &#125;</span><br><span class="line">    const hostCategoryFormCancel = () =&gt; &#123;</span><br><span class="line">      // 添加主机类别的表单取消</span><br><span class="line">      hostCategoryForm.form.name = &quot;&quot;; // 清空表单内容</span><br><span class="line">      HostCategoryFromVisible.value = false // 关闭对话框</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const onHostCategoryFromSubmit = () =&gt; &#123;</span><br><span class="line">      // 添加主机类别的表单提交处理</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const onHostFormSubmit = () =&gt; &#123;</span><br><span class="line">      // 添加主机的表单提交处理</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const get_host_list = () =&gt; &#123;</span><br><span class="line">      // 获取主机类别列表</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    const get_category_list = () =&gt; &#123;</span><br><span class="line">      // 获取主机类别列表</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const deleteHost = record =&gt; &#123;</span><br><span class="line">      // 删除主机接口</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_host_list()</span><br><span class="line">    get_category_list()</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      selectHostCategory: ref(&#x27;yuan&#x27;),</span><br><span class="line">      hostForm,</span><br><span class="line">      formRef,</span><br><span class="line">      layout,</span><br><span class="line">      HostCategoryFromVisible,</span><br><span class="line">      handleCategorySelectChange,</span><br><span class="line">      handleFinishFailed,</span><br><span class="line">      handleFinish,</span><br><span class="line">      resetForm,</span><br><span class="line">      handleValidate,</span><br><span class="line">      hostFormVisible,</span><br><span class="line">      showHostModal,</span><br><span class="line">      onHostFormSubmit,</span><br><span class="line">      deleteHost,</span><br><span class="line">      showHostCategoryFormModal,</span><br><span class="line">      hostCategoryForm,</span><br><span class="line">      hostCategoryFormCancel,</span><br><span class="line">      onHostCategoryFromSubmit,</span><br><span class="line">      hostFormColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;类别&#x27;,</span><br><span class="line">          dataIndex: &#x27;category_name&#x27;,</span><br><span class="line">          key: &#x27;category_name&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;主机名称&#x27;,</span><br><span class="line">          dataIndex: &#x27;name&#x27;,</span><br><span class="line">          key: &#x27;name&#x27;,</span><br><span class="line">          sorter: true,</span><br><span class="line">          width: 230</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;连接地址&#x27;,</span><br><span class="line">          dataIndex: &#x27;ip_addr&#x27;,</span><br><span class="line">          key: &#x27;ip_addr&#x27;,</span><br><span class="line">          ellipsis: true,</span><br><span class="line">          sorter: true,</span><br><span class="line">          width: 150</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;端口&#x27;,</span><br><span class="line">          dataIndex: &#x27;port&#x27;,</span><br><span class="line">          key: &#x27;port&#x27;,</span><br><span class="line">          ellipsis: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;备注信息&#x27;,</span><br><span class="line">          dataIndex: &#x27;remark&#x27;,</span><br><span class="line">          key: &#x27;remark&#x27;,</span><br><span class="line">          ellipsis: true</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;操作&#x27;,</span><br><span class="line">          key: &#x27;action&#x27;,</span><br><span class="line">          width: 200,</span><br><span class="line">          dataIndex: &quot;action&quot;,</span><br><span class="line">          scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      hostList,</span><br><span class="line">      categoryList,</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-1-2、主机类别与主机接口">4.1.2、主机类别与主机接口</h3>
<h4 id="（1）创建app">（1）创建app</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd uric_api/apps/</span><br><span class="line">python ../../manage.py startapp host</span><br></pre></td></tr></table></figure>
<h4 id="（2）注册">（2）注册</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;host&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="（3）构建路由">（3）构建路由</h4>
<p>总路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;host/&#x27;</span>, include(<span class="string">&#x27;host.urls&#x27;</span>)),</span><br></pre></td></tr></table></figure>
<p>在host应用中创建urls.py文件，写如下内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="keyword">from</span> host <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">  	</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="（4）模型models">（4）模型models</h4>
<p><code>urci_api/utils/models.py</code>  基础模型类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;公共模型&quot;&quot;&quot;</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">500</span>,default=<span class="string">&quot;&quot;</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;名称/标题&#x27;</span>)</span><br><span class="line">    is_show = models.BooleanField(default=<span class="literal">True</span>, verbose_name=<span class="string">&quot;是否显示&quot;</span>)</span><br><span class="line">    orders = models.IntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">&quot;排序&quot;</span>)</span><br><span class="line">    is_deleted = models.BooleanField(default=<span class="literal">False</span>, verbose_name=<span class="string">&quot;是否删除&quot;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">&quot;添加时间&quot;</span>)</span><br><span class="line">    updated_time = models.DateTimeField(auto_now=<span class="literal">True</span>, verbose_name=<span class="string">&quot;修改时间&quot;</span>)</span><br><span class="line">    description = models.TextField(null=<span class="literal">True</span>, blank=<span class="literal">True</span>, default=<span class="string">&quot;&quot;</span>, verbose_name=<span class="string">&quot;描述信息&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="comment"># 数据库迁移时，设置了bstract = True的model类不会生成数据库表</span></span><br><span class="line">        abstract = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>
<p><code>host/models.py</code>的主机相关的模型代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">from</span> uric_api.utils.models <span class="keyword">import</span> BaseModel, models</span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostCategory</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机类别&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;host_category&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;主机类别&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name  <span class="comment"># 取消提示文字中关于英文复数+s的情况</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Host</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># 真正在数据库中的字段实际上叫 category_id，而category则代表了关联的哪个分类模型对象</span></span><br><span class="line">    category = models.ForeignKey(<span class="string">&#x27;HostCategory&#x27;</span>, on_delete=models.DO_NOTHING, verbose_name=<span class="string">&#x27;主机类别&#x27;</span>, related_name=<span class="string">&#x27;hc&#x27;</span>,</span><br><span class="line">                                 null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    ip_addr = models.CharField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>, max_length=<span class="number">500</span>, verbose_name=<span class="string">&#x27;连接地址&#x27;</span>)</span><br><span class="line">    port = models.IntegerField(verbose_name=<span class="string">&#x27;端口&#x27;</span>)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">&#x27;登录用户&#x27;</span>)</span><br><span class="line">    users = models.ManyToManyField(User)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;host&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;主机信息&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name + <span class="string">&#x27;:&#x27;</span> + self.ip_addr</span><br></pre></td></tr></table></figure>
<h4 id="（5）序列化器">（5）序列化器</h4>
<p><code>host.serializers</code>代码：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostCategoryModelSeiralizer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机分类的序列化器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = models.HostCategory</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostModelSerializers</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机信息的序列化器&quot;&quot;&quot;</span></span><br><span class="line">    category_name = serializers.CharField(source=<span class="string">&#x27;category.name&#x27;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    password = serializers.CharField(max_length=<span class="number">32</span>, write_only=<span class="literal">True</span>, label=<span class="string">&quot;登录密码&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = models.Host</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;category_name&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ip_addr&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">self, attrs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;当用户添加、编辑主机信息会自动执行这个方法&quot;&quot;&quot;</span></span><br><span class="line">        ip_addr = attrs.get(<span class="string">&#x27;ip_addr&#x27;</span>)</span><br><span class="line">        port = attrs.get(<span class="string">&#x27;port&#x27;</span>)</span><br><span class="line">        username = attrs.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = attrs.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo 验证主机信息是否正确</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加host记录，如果第一次添加host记录，那么需要我们生成全局的公钥和私钥</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, validated_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;接受通过验证以后的数据字典:&#x27;</span>,validated_data)</span><br><span class="line">        ip_addr = validated_data.get(<span class="string">&#x27;ip_addr&#x27;</span>)</span><br><span class="line">        port = validated_data.get(<span class="string">&#x27;port&#x27;</span>)</span><br><span class="line">        username = validated_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = validated_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo 生成公私钥和管理主机的公私钥</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 剔除密码字段，保存host记录</span></span><br><span class="line">        password = validated_data.pop(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        instance = models.Host.objects.create(</span><br><span class="line">            **validated_data</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>
<p>（6）视图函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListAPIView,CreateAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> HostCategory,Host</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> HostCategoryModelSeiralizer,HostModelSerializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostCategoryListAPIView</span>(ListAPIView, CreateAPIView):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机类别&quot;&quot;&quot;</span></span><br><span class="line">    queryset = HostCategory.objects.<span class="built_in">filter</span>(is_show=<span class="literal">True</span>, is_deleted=<span class="literal">False</span>).order_by(<span class="string">&quot;orders&quot;</span>,<span class="string">&quot;-id&quot;</span>).<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = HostCategoryModelSeiralizer</span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostModelViewSet</span>(<span class="title class_ inherited__">ModelViewSet</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机信息&quot;&quot;&quot;</span></span><br><span class="line">    queryset = Host.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = HostModelSerializers</span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br></pre></td></tr></table></figure>
<p>路由，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include, re_path</span><br><span class="line"><span class="keyword">from</span> host <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, views.HostModelViewSet.as_view(&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span>&#125;)),</span><br><span class="line">    re_path(<span class="string">&#x27;(?P&lt;pk&gt;\d+)&#x27;</span>, views.HostModelViewSet.as_view(&#123;<span class="string">&#x27;delete&#x27;</span>: <span class="string">&#x27;destroy&#x27;</span>&#125;)),</span><br><span class="line">    path(<span class="string">&#x27;category&#x27;</span>, views.HostCategoryListAPIView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>测试主机类别接口：</p>
<p><img src="assets/image-20220622203649289-5901411.png" alt="image-20220622203649289"></p>
<p><img src="assets/image-20220622203838704-5901519.png" alt="image-20220622203838704"></p>
<p>测试主机接口：</p>
<p><img src="assets/image-20220623125408732-5960049.png" alt="image-20220623125408732"></p>
<p><img src="assets/image-20220623125445062-5960086.png" alt="image-20220623125445062"></p>
<h3 id="4-1-3、前端对接后端接口">4.1.3、前端对接后端接口</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-row&gt;</span><br><span class="line">    &lt;a-col :span=&quot;6&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;add_host&quot; style=&quot;margin: 15px;&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-button @click=&quot;showHostModal&quot; type=&quot;primary&quot;&gt;</span><br><span class="line">          新建</span><br><span class="line">        &lt;/a-button&gt;</span><br><span class="line">        &lt;a-button type=&quot;primary&quot; style=&quot;margin-left: 20px;&quot;&gt;</span><br><span class="line">          批量导入</span><br><span class="line">        &lt;/a-button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/a-row&gt;</span><br><span class="line">  &lt;a-table :dataSource=&quot;hostList.data&quot; :columns=&quot;hostFormColumns&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;action&#x27;&quot;&gt;</span><br><span class="line">        &lt;a-popconfirm</span><br><span class="line">            v-if=&quot;hostList.data.length&quot;</span><br><span class="line">            title=&quot;Sure to delete?&quot;</span><br><span class="line">            @confirm=&quot;deleteHost(record)&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;a&gt;Delete&lt;/a&gt;</span><br><span class="line">        &lt;/a-popconfirm&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;a-modal v-model:visible=&quot;hostFormVisible&quot; title=&quot;添加主机&quot; @ok=&quot;onHostFormSubmit&quot; @cancel=&quot;resetForm()&quot; :width=&quot;800&quot;&gt;</span><br><span class="line">      &lt;a-form</span><br><span class="line">          ref=&quot;formRef&quot;</span><br><span class="line">          name=&quot;custom-validation&quot;</span><br><span class="line">          :model=&quot;hostForm.form&quot;</span><br><span class="line">          :rules=&quot;hostForm.rules&quot;</span><br><span class="line">          v-bind=&quot;layout&quot;</span><br><span class="line">          @finish=&quot;handleFinish&quot;</span><br><span class="line">          @validate=&quot;handleValidate&quot;</span><br><span class="line">          @finishFailed=&quot;handleFinishFailed&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;a-form-item label=&quot;主机类别&quot; prop=&quot;zone&quot; name=&quot;category&quot;&gt;</span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;12&quot;&gt;</span><br><span class="line">              &lt;a-select</span><br><span class="line">                  ref=&quot;select&quot;</span><br><span class="line">                  v-model:value=&quot;hostForm.form.category&quot;</span><br><span class="line">                  @change=&quot;handleCategorySelectChange&quot;</span><br><span class="line"></span><br><span class="line">              &gt;</span><br><span class="line">                &lt;a-select-option :value=&quot;category.id&quot; v-for=&quot;category in categoryList.data&quot; :key=&quot;category.id&quot;&gt;</span><br><span class="line">                  &#123;&#123; category.name &#125;&#125;</span><br><span class="line">                &lt;/a-select-option&gt;</span><br><span class="line">              &lt;/a-select&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;主机名称&quot; name=&quot;name&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;hostForm.form.name&quot; type=&quot;text&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;连接地址&quot; name=&quot;username&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;用户名&quot; addon-before=&quot;ssh&quot; v-model:value=&quot;hostForm.form.username&quot; type=&quot;text&quot;</span><br><span class="line">                       autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;ip地址&quot; addon-before=&quot;@&quot; v-model:value=&quot;hostForm.form.ip_addr&quot; type=&quot;text&quot;</span><br><span class="line">                       autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;端口号&quot; addon-before=&quot;-p&quot; v-model:value=&quot;hostForm.form.port&quot; type=&quot;text&quot;</span><br><span class="line">                       autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;连接密码&quot; name=&quot;password&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;hostForm.form.password&quot; type=&quot;password&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;备注信息&quot; name=&quot;remark&quot;&gt;</span><br><span class="line">          &lt;a-textarea placeholder=&quot;请输入主机备注信息&quot; v-model:value=&quot;hostForm.form.remark&quot; type=&quot;text&quot;</span><br><span class="line">                      :auto-size=&quot;&#123; minRows: 3, maxRows: 5 &#125;&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;a-form-item :wrapper-col=&quot;&#123; span: 14, offset: 4 &#125;&quot;&gt;</span><br><span class="line">          &lt;a-button @click=&quot;resetForm&quot;&gt;Reset&lt;/a-button&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">      &lt;/a-form&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/a-modal&gt;</span><br><span class="line">    &lt;a-modal</span><br><span class="line">        :width=&quot;600&quot;</span><br><span class="line">        title=&quot;新建主机类别&quot;</span><br><span class="line">        :visible=&quot;HostCategoryFromVisible&quot;</span><br><span class="line">        @cancel=&quot;hostCategoryFormCancel&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;template #footer&gt;</span><br><span class="line">        &lt;a-button key=&quot;back&quot; @click=&quot;hostCategoryFormCancel&quot;&gt;取消&lt;/a-button&gt;</span><br><span class="line">        &lt;a-button key=&quot;submit&quot; type=&quot;primary&quot; :loading=&quot;loading&quot; @click=&quot;onHostCategoryFromSubmit&quot;&gt;提交&lt;/a-button&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;a-form-model ref=&quot;hostCategoryRuleForm&quot; v-model:value=&quot;hostCategoryForm.form&quot; :rules=&quot;hostCategoryForm.rules&quot;</span><br><span class="line">                    :label-col=&quot;hostCategoryForm.labelCol&quot; :wrapper-col=&quot;hostCategoryForm.wrapperCol&quot;&gt;</span><br><span class="line">        &lt;a-form-model-item ref=&quot;name&quot; label=&quot;类别名称&quot; prop=&quot;name&quot;&gt;</span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;24&quot;&gt;</span><br><span class="line">              &lt;a-input placeholder=&quot;请输入主机类别名称&quot; v-model:value=&quot;hostCategoryForm.form.name&quot;/&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line">        &lt;/a-form-model-item&gt;</span><br><span class="line">      &lt;/a-form-model&gt;</span><br><span class="line">    &lt;/a-modal&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;defineComponent, ref, reactive&#125; from &#x27;vue&#x27;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import settings from &quot;@/settings&quot;;</span><br><span class="line">import store from &quot;@/store&quot;;</span><br><span class="line">import &#123;message&#125; from &#x27;ant-design-vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    const handleChange = value =&gt; &#123;</span><br><span class="line">      console.log(`selected $&#123;value&#125;`);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleCategorySelectChange = (value) =&gt; &#123;</span><br><span class="line">      // 切换主机类别的回调处理</span><br><span class="line">      console.log(value)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const formRef = ref();</span><br><span class="line">    const HostCategoryFromVisible = ref(false);</span><br><span class="line">    const hostList = reactive(&#123;</span><br><span class="line">      data: [</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 1,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;izbp13e05jqwodd605vm3gz&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;47.58.131.12&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 2,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;数据库服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;iZbp1a3jw4l12ho53ivhkkZ&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;12.18.125.22&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 3,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;iZbp1b1xqfqw257gs563k2iZ&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;12.19.135.130&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &#x27;id&#x27;: 4,</span><br><span class="line">          &#x27;category_name&#x27;: &#x27;缓存服务器&#x27;,</span><br><span class="line">          &#x27;name&#x27;: &#x27;iZbp1b1jw4l01ho53muhkkZ&#x27;,</span><br><span class="line">          &#x27;ip_addr&#x27;: &#x27;47.98.101.89&#x27;,</span><br><span class="line">          &#x27;port&#x27;: 22,</span><br><span class="line">          &#x27;remark&#x27;: &#x27;&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line">    const categoryList = reactive(&#123;</span><br><span class="line">      data: [</span><br><span class="line">        &#123;&#x27;id&#x27;: 1, &#x27;name&#x27;: &#x27;数据库服务&#x27;&#125;,</span><br><span class="line">        &#123;&#x27;id&#x27;: 2, &#x27;name&#x27;: &#x27;缓存服务&#x27;&#125;,</span><br><span class="line">        &#123;&#x27;id&#x27;: 3, &#x27;name&#x27;: &#x27;web服务&#x27;&#125;,</span><br><span class="line">        &#123;&#x27;id&#x27;: 4, &#x27;name&#x27;: &#x27;静态文件存储服务&#x27;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    const hostForm = reactive(&#123;</span><br><span class="line">      labelCol: &#123;span: 6&#125;,</span><br><span class="line">      wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">      other: &#x27;&#x27;,</span><br><span class="line">      form: &#123;</span><br><span class="line">        name: &#x27;&#x27;,</span><br><span class="line">        category: &quot;&quot;,</span><br><span class="line">        ip_addr: &#x27;&#x27;,</span><br><span class="line">        username: &#x27;&#x27;,</span><br><span class="line">        port: &#x27;&#x27;,</span><br><span class="line">        remark: &#x27;&#x27;,</span><br><span class="line">        password: &#x27;&#x27;</span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line">        name: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入主机名称&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        password: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入连接密码&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        category: [</span><br><span class="line">          &#123;required: true, message: &#x27;请选择类别&#x27;, trigger: &#x27;change&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        username: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入用户名&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        ip_addr: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入连接地址&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;max: 15, message: &#x27;长度最大15位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        port: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入端口号&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;max: 5, message: &#x27;长度最大5位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    let validateName = async (_rule, value) =&gt; &#123;</span><br><span class="line">      if (value === &#x27;&#x27;) &#123;</span><br><span class="line">        return Promise.reject(&#x27;请输入类别名称&#x27;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return Promise.resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    const hostCategoryForm = reactive(&#123;</span><br><span class="line">      labelCol: &#123;span: 6&#125;,</span><br><span class="line">      wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">      other: &#x27;&#x27;,</span><br><span class="line">      form: &#123;</span><br><span class="line">        name: &#x27;&#x27;</span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line">        name: [&#123;</span><br><span class="line">          required: true,</span><br><span class="line">          message: &#x27;请输入类别名称&#x27;,</span><br><span class="line">          validator: validateName,</span><br><span class="line">          trigger: &#x27;blur&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    const layout = &#123;</span><br><span class="line">      labelCol: &#123;</span><br><span class="line">        span: 4,</span><br><span class="line">      &#125;,</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        span: 14,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleFinish = values =&gt; &#123;</span><br><span class="line">      console.log(values, hostForm);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleFinishFailed = errors =&gt; &#123;</span><br><span class="line">      console.log(errors);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const resetForm = () =&gt; &#123;</span><br><span class="line">      formRef.value.resetFields();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleValidate = (...args) =&gt; &#123;</span><br><span class="line">      console.log(args);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const hostFormVisible = ref(false);</span><br><span class="line"></span><br><span class="line">    const showHostModal = () =&gt; &#123;</span><br><span class="line">      hostFormVisible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const onHostFormSubmit = () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">      // 将数据提交到后台进行保存，但是先进行连接校验，验证没有问题，再保存</span><br><span class="line"></span><br><span class="line">      const formData = new FormData();</span><br><span class="line">      for (let attr in hostForm.form) &#123;</span><br><span class="line">        formData.append(attr, hostForm.form[attr])</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      axios.post(`$&#123;settings.host&#125;/host/`, formData, &#123;</span><br><span class="line">            headers: &#123;</span><br><span class="line">              Authorization: store.getters.token,</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      ).then((response) =&gt; &#123;</span><br><span class="line">        console.log(&quot;response&gt;&gt;&gt;&quot;, response)</span><br><span class="line">        hostList.data.unshift(response.data)</span><br><span class="line"></span><br><span class="line">        // 清空</span><br><span class="line">        resetForm()</span><br><span class="line">        hostFormVisible.value = false; // 关闭对话框</span><br><span class="line">        message.success(&#x27;成功添加主机信息！&#x27;)</span><br><span class="line"></span><br><span class="line">      &#125;).catch((response) =&gt; &#123;</span><br><span class="line">        message.error(response.data)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const deleteHost = record =&gt; &#123;</span><br><span class="line">      console.log(record);</span><br><span class="line">      axios.delete(`$&#123;settings.host&#125;/host/$&#123;record.id&#125;`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        let index = hostList.data.indexOf(record)</span><br><span class="line">        hostList.data.splice(index, 1);</span><br><span class="line"></span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        message.error(&#x27;删除主机失败！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    const showHostCategoryFormModal = () =&gt; &#123;</span><br><span class="line">      // 显示添加主机类别的表单窗口</span><br><span class="line">      HostCategoryFromVisible.value = true</span><br><span class="line">    &#125;</span><br><span class="line">    const hostCategoryFormCancel = () =&gt; &#123;</span><br><span class="line">      // 添加主机类别的表单取消</span><br><span class="line">      hostCategoryForm.form.name = &quot;&quot;; // 清空表单内容</span><br><span class="line">      HostCategoryFromVisible.value = false // 关闭对话框</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const onHostCategoryFromSubmit = () =&gt; &#123;</span><br><span class="line">      // 添加主机类别的表单提交处理</span><br><span class="line">      // 将数据提交到后台进行保存，但是先进行连接校验，验证没有问题，再保存</span><br><span class="line">      axios.post(`$&#123;settings.host&#125;/host/category`, hostCategoryForm.form, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        message.success(&#123;</span><br><span class="line">          content: &quot;创建主机类别成功!&quot;,</span><br><span class="line">          duration: 1,</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response)</span><br><span class="line">          categoryList.data.unshift(response.data)</span><br><span class="line">          hostCategoryFormCancel()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const get_host_list = () =&gt; &#123;</span><br><span class="line">      // 获取主机类别列表</span><br><span class="line"></span><br><span class="line">      axios.get(`$&#123;settings.host&#125;/host`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        hostList.data = response.data</span><br><span class="line"></span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        message.error(&#x27;无法获取主机类别列表信息！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    const get_category_list = () =&gt; &#123;</span><br><span class="line">      // 获取主机类别列表</span><br><span class="line">      axios.get(`$&#123;settings.host&#125;/host/category`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        categoryList.data = response.data</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        message.error(&#x27;无法获取主机类别列表信息！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取主机列表</span><br><span class="line">    get_host_list()</span><br><span class="line">    get_category_list()</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      selectHostCategory: ref(&#x27;yuan&#x27;),</span><br><span class="line">      hostForm,</span><br><span class="line">      formRef,</span><br><span class="line">      layout,</span><br><span class="line">      HostCategoryFromVisible,</span><br><span class="line">      handleCategorySelectChange,</span><br><span class="line">      handleFinishFailed,</span><br><span class="line">      handleFinish,</span><br><span class="line">      resetForm,</span><br><span class="line">      handleValidate,</span><br><span class="line">      hostFormVisible,</span><br><span class="line">      showHostModal,</span><br><span class="line">      onHostFormSubmit,</span><br><span class="line">      deleteHost,</span><br><span class="line">      showHostCategoryFormModal,</span><br><span class="line">      hostCategoryForm,</span><br><span class="line">      hostCategoryFormCancel,</span><br><span class="line">      onHostCategoryFromSubmit,</span><br><span class="line">      hostFormColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;类别&#x27;,</span><br><span class="line">          dataIndex: &#x27;category_name&#x27;,</span><br><span class="line">          key: &#x27;category_name&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;主机名称&#x27;,</span><br><span class="line">          dataIndex: &#x27;name&#x27;,</span><br><span class="line">          key: &#x27;name&#x27;,</span><br><span class="line">          sorter: true,</span><br><span class="line">          width: 230</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;连接地址&#x27;,</span><br><span class="line">          dataIndex: &#x27;ip_addr&#x27;,</span><br><span class="line">          key: &#x27;ip_addr&#x27;,</span><br><span class="line">          ellipsis: true,</span><br><span class="line">          sorter: true,</span><br><span class="line">          width: 150</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;端口&#x27;,</span><br><span class="line">          dataIndex: &#x27;port&#x27;,</span><br><span class="line">          key: &#x27;port&#x27;,</span><br><span class="line">          ellipsis: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;备注信息&#x27;,</span><br><span class="line">          dataIndex: &#x27;remark&#x27;,</span><br><span class="line">          key: &#x27;remark&#x27;,</span><br><span class="line">          ellipsis: true</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;操作&#x27;,</span><br><span class="line">          key: &#x27;action&#x27;,</span><br><span class="line">          width: 200,</span><br><span class="line">          dataIndex: &quot;action&quot;,</span><br><span class="line">          scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      hostList,</span><br><span class="line">      categoryList,</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220623184711719-5981232.png" alt="image-20220623184711719"></p>
<p><img src="assets/image-20220623184853799-5981335.png" alt="image-20220623184853799"></p>
<h3 id="4-1-4、ssh与paramiko模块">4.1.4、ssh与paramiko模块</h3>
<h4 id="（1）ssh命令">（1）ssh命令</h4>
<p>ssh命令是openssh套件中的客户端连接工具，可以给予ssh加密协议实现安全的远程登录服务器，实现对服务器的远程管理。</p>
<p>简单说，SSH是一种网络协议，用于计算机之间的加密登录。如果一个用户从本地计算机，使用SSH协议登录另一台远程计算机，我们就可以认为，这种登录是安全的，即使被中途截获，密码也不会泄露。最早的时候，互联网通信都是明文通信，一旦被截获，内容就暴露无疑。1995年，芬兰学者Tatu Ylonen设计了SSH协议，将登录信息全部加密，成为互联网安全的一个基本解决方案，迅速在全世界获得推广，目前已经成为Linux系统的标准配置。</p>
<p>SSH(远程连接工具)连接原理：ssh服务是一个守护进程(demon)，系统后台监听客户端的连接，ssh服务端的进程名为sshd,负责实时监听客户端的请求(IP 22端口)，包括公共秘钥等交换等信息。</p>
<p>ssh服务端由2部分组成： openssh(提供ssh服务) openssl(提供加密的程序)</p>
<blockquote>
<ol>
<li>检查主机上有没有安装SSH服务，使用命令：ssh 若提示命令未找到，则需要安装ssh服务；步骤如下：输入sudo apt-get update命令以实现更新Ubuntu系统–&gt;输入sudo apt-get install openssh-server命令以安装ssh 若输出ssh命令的使用说明，则代表已经安装了。</li>
<li>检查主机上有没有启动SSH服务，使用命令：service –status-all | grep ssh 若服务已经启动的话，可以看到[+] ssh 若服务还没启动的话，可以看到[-] ssh</li>
<li>启动ssh服务，使用命令sudo service sshd start</li>
</ol>
</blockquote>
<p>SSH远程登录之口令登录</p>
<blockquote>
<p><code>ssh 用户名@IP地址 -p 端口号 </code></p>
<p>SSH的默认端口是22</p>
</blockquote>
<p><img src="assets/image-20220413161739973-16498378612653.png" alt="image-20220413161739973"></p>
<p><img src="assets/image-20220413162104970-16498380659204.png" alt="image-20220413162104970"></p>
<h4 id="（2）paramiko模块">（2）paramiko模块</h4>
<p>Paramiko是SSHv2协议的Python（2.7，3.4+）实现，同时提供了客户端和服务器功能。尽管Paramiko利用Python C扩展进行了低级加密（<a target="_blank" rel="noopener" href="https://cryptography.io/">Cryptography</a>），但它本身是围绕SSH网络概念的纯Python接口，通过paramiko我们可以完成远程主机连接，指令执行、上传下载文件等操作。下面学习具体用法</p>
<p>官方网址： <a target="_blank" rel="noopener" href="http://www.paramiko.org/">http://www.paramiko.org/</a></p>
<p>详细api接口文档：<a target="_blank" rel="noopener" href="http://docs.paramiko.org/en/stable/">http://docs.paramiko.org/en/stable/</a></p>
<blockquote>
<ul>
<li>SSHClient的作用类似于Linux的ssh命令，是对SSH会话的封装，该类封装了传输(Transport)，通道(Channel)及SFTPClient建立的方法(open_sftp)，通常用于执行远程命令。</li>
<li>SFTPClient的作用类似与Linux的sftp命令，是对SFTP客户端的封装，用以实现远程文件操作，如文件上传、下载、修改文件权限等操作。</li>
</ul>
</blockquote>
<p>ssh连接并执行指令，我们使用paramiko，paramiko依赖于pycrypto模块，所以我们先安装pycrypto</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pycrypto</span><br><span class="line">pip install paramiko</span><br></pre></td></tr></table></figure>
<p>Paramiko中的几个概念：</p>
<ul>
<li>Client：ssh客户端短连接模式</li>
<li>Transport：可以建立ssh会话长连接模式
<ul>
<li>Channel：是一种类Socket，一种安全的SSH传输通道;</li>
<li>Transport：是一种加密的会话，使用时会同步创建了一个加密的Tunnels(通道)，这个Tunnels叫做Channel;需要open_session来完成长连接对话。</li>
<li>Session：是client与Server保持连接的对象，用connect()/start_client()/start_server()开始会话。</li>
</ul>
</li>
</ul>
<p>示例1： client模式，直接执行指令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> AuthenticationException</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 通过parammiko创建一个ssh短连接客户端实例对象</span></span><br><span class="line">    ssh = paramiko.SSHClient()</span><br><span class="line">    <span class="comment"># 自动在本机第一次连接远程服务器时，记录主机指纹</span></span><br><span class="line">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 直接密码远程连接的方式</span></span><br><span class="line">        ssh.connect(hostname=<span class="string">&#x27;&#x27;</span>, port=<span class="number">22</span>, username=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;&#x27;</span>, timeout=<span class="number">10</span>)</span><br><span class="line">        <span class="comment"># 注意，如果你测试某个服务器的连接时，如果你本地已经配置了这个远程服务器的免密登录(公私钥模式)，那么就不能测试出密码是否正确了，因为首先会通过公私钥模式登录，不会使用你的密码的。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 使用秘钥免密登录的方式</span></span><br><span class="line">        <span class="comment"># pkey = PkeyModel.objects.get(name=&#x27;&#x27;).private</span></span><br><span class="line">        <span class="comment"># pkey = RSAKey.from_private_key(StringIO(pkey))</span></span><br><span class="line">        <span class="comment"># ssh.connect(hostname=&#x27;47.98.130.212&#x27;, port=22, username=&#x27;root&#x27;, pkey=pkey, timeout=10)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 连接成功以后，就可以发送操作指令</span></span><br><span class="line">        <span class="comment"># stdin 输入[本机发送给远程主机的信息]</span></span><br><span class="line">        <span class="comment"># stdout 输出[远程主机返回给本机的信息]</span></span><br><span class="line">        <span class="comment"># stderr 错误</span></span><br><span class="line">        stdin, stdout, stderr = ssh.exec_command(<span class="string">&#x27;ls -la&#x27;</span>)</span><br><span class="line">        <span class="comment"># 读取stdout对象中返回的内容，返回结果bytes类型数据</span></span><br><span class="line">        result = stdout.read()</span><br><span class="line">        <span class="built_in">print</span>( result.decode() )</span><br><span class="line">        <span class="comment"># 关闭连接</span></span><br><span class="line">        ssh.close()</span><br><span class="line">    <span class="keyword">except</span> AuthenticationException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e.message)</span><br><span class="line">        <span class="built_in">print</span>(traceback.format_exc())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;连接参数有误，请检查连接信息是否正确！~&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>示例2： transport模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> AuthenticationException</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 通过parammiko创建一个ssh短连接客户端实例对象</span></span><br><span class="line">    ssh = paramiko.SSHClient()</span><br><span class="line">    <span class="comment"># 自动在本机第一次连接远程服务器时，记录主机指纹</span></span><br><span class="line">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 直接密码远程连接的方式</span></span><br><span class="line">        ssh.connect(hostname=<span class="string">&#x27;47.98.130.212&#x27;</span>, port=<span class="number">22</span>, username=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;123&#x27;</span>, timeout=<span class="number">10</span>)</span><br><span class="line">        <span class="comment"># 注意，如果你测试某个服务器的连接时，如果你本地已经配置了这个远程服务器的免密登录(公私钥模式)，那么就不能测试出密码是否正确了，因为首先会通过公私钥模式登录，不会使用你的密码的。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 使用秘钥免密登录的方式</span></span><br><span class="line">        <span class="comment"># pkey = PkeyModel.objects.get(name=&#x27;xxxxxxx&#x27;).private</span></span><br><span class="line">        <span class="comment"># pkey = RSAKey.from_private_key(StringIO(pkey))</span></span><br><span class="line">        <span class="comment"># ssh.connect(hostname=&#x27;47.98.130.212&#x27;, port=22, username=&#x27;root&#x27;, pkey=pkey, timeout=10)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 保存本次ssh的连接的回话状态</span></span><br><span class="line">            cli = ssh.get_transport().open_session()</span><br><span class="line">            <span class="comment"># 设置回话超时时间</span></span><br><span class="line">            cli.settimeout(<span class="number">120</span>)</span><br><span class="line">            command = <span class="built_in">input</span>(<span class="string">&quot;请输入您要发送的指令：&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> command == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># 发送指令</span></span><br><span class="line">            cli.exec_command(command)</span><br><span class="line">            <span class="comment"># 接受操作指令以后，远程主机返回的结果</span></span><br><span class="line">            stdout = cli.makefile(<span class="string">&quot;rb&quot;</span>, -<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># 读取结果并转换编码</span></span><br><span class="line">            content = stdout.read().decode()</span><br><span class="line">            <span class="built_in">print</span>(content)</span><br><span class="line">            <span class="comment"># 关闭连接</span></span><br><span class="line">            ssh.close()</span><br><span class="line">    <span class="keyword">except</span> AuthenticationException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e.message)</span><br><span class="line">        <span class="built_in">print</span>(traceback.format_exc())</span><br></pre></td></tr></table></figure>
<p>远程执行命令<br>
该命令的输入与输出流为标准输入(stdin)、输出(stdout)、错误(stderr)的Python文件对像</p>
<p>命令执行完毕后，通道将关闭，不能再使用。如果您想执行另一个命令，您必须打开一个新频道。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec_command(command, bufsize=-<span class="number">1</span>, timeout=<span class="literal">None</span>, get_pty=<span class="literal">False</span>, environment=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<blockquote>
<p>command(str类型)，执行的命令串；<br>
bufsize(int类型)，文件缓冲区大小，默认为-1(不限制)<br>
get_pty( term=‘vt100’ , width=80 , height=24 , width_pixels=0 , height_pixels=0 )</p>
</blockquote>
<p>在远程服务器上生成新的交互式shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke_shell(term=<span class="string">&#x27;vt100&#x27;</span>, width=<span class="number">80</span>, height=<span class="number">24</span>, width_pixels=<span class="number">0</span>, height_pixels=<span class="number">0</span>, environment=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p>在此频道上请求交互式 shell 会话。如果服务器允许，则通道将直接连接到 shell 的 stdin、stdout 和 stderr。</p>
<p>通常您会在此之前调用get_pyt，在这种情况下，shell 将通过 pty 进行操作，并且通道将连接到 pty 的 stdin 和 stdout。</p>
<p>当shell退出时，通道将被关闭并且不能被重用。如果您想打开另一个 shell，您必须打开一个新频道。</p>
<p>例如：在SSH server端创建一个交互式的shell，且可以按自己的需求配置伪终端，可以在invoke_shell()函数中添加参数配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chan = ssh.invoke_shell()</span><br><span class="line"></span><br><span class="line">chan.send(cmd) <span class="comment">#利用send函数发送cmd到SSH server，添加做回车来执行shell命令（cmd中需要有\n命令才能执行）。注意不同的情况，如果执行完telnet命令后，telnet的换行符是\r\n</span></span><br><span class="line"> chan.recv(bufsize)  <span class="comment">#通过recv函数获取回显</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>一般回显数据较多，需要通过while循环读取回显数据</p>
</blockquote>
<h4 id="（3）基于ssh的主机验证功能">（3）基于ssh的主机验证功能</h4>
<p>创建<code>utils.ssh.py</code>文件，集成ssh相关功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> paramiko.client <span class="keyword">import</span> SSHClient, AutoAddPolicy</span><br><span class="line"><span class="keyword">from</span> paramiko.rsakey <span class="keyword">import</span> RSAKey</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> AuthenticationException, SSHException</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> NoValidConnectionsError</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSHParamiko</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, hostname, port=<span class="number">22</span>, username=<span class="string">&#x27;root&#x27;</span>, pkey=<span class="literal">None</span>, password=<span class="literal">None</span>, connect_timeout=<span class="number">2</span></span>):</span><br><span class="line">        <span class="keyword">if</span> pkey <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> password <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> SSHException(<span class="string">&#x27;私钥或者密码必须选择传入一个&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.client = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.params = &#123;</span><br><span class="line">            <span class="string">&#x27;hostname&#x27;</span>: hostname,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>: port,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: password,</span><br><span class="line">            <span class="string">&#x27;pkey&#x27;</span>: RSAKey.from_private_key(StringIO(pkey)) <span class="keyword">if</span> <span class="built_in">isinstance</span>(pkey, <span class="built_in">str</span>) <span class="keyword">else</span> pkey,</span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span>: connect_timeout,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检测连接并获取连接</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_validated</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;self.client=<span class="subst">&#123;self.client&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> self.client <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 告知当前执行上下文，self.client已经实例化</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;已经建立连接了！！！&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;正在ping通<span class="subst">&#123;self.client&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.client:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 创建客户端连接对象</span></span><br><span class="line">                self.client = SSHClient()</span><br><span class="line">                <span class="comment"># 在本机第一次连接远程主机时记录指纹信息</span></span><br><span class="line">                self.client.set_missing_host_key_policy(AutoAddPolicy)</span><br><span class="line">                <span class="comment"># 建立连接</span></span><br><span class="line">                self.client.connect(**self.params)</span><br><span class="line">            <span class="keyword">except</span> (TimeoutError, NoValidConnectionsError, AuthenticationException) <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>host.serializers.py</code>中添加验证功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.ssh <span class="keyword">import</span> SSHParamiko</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostCategoryModelSeiralizer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机分类的序列化器&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = models.HostCategory</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostModelSerializers</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机信息的序列化器&quot;&quot;&quot;</span></span><br><span class="line">    password = serializers.CharField(max_length=<span class="number">32</span>, write_only=<span class="literal">True</span>, label=<span class="string">&quot;登录密码&quot;</span>)</span><br><span class="line">    category_name = serializers.CharField(source=<span class="string">&quot;category.name&quot;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = models.Host</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&quot;category_name&quot;</span>, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ip_addr&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">self, attrs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;当用户添加、编辑主机信息会自动执行这个方法&quot;&quot;&quot;</span></span><br><span class="line">        ip_addr = attrs.get(<span class="string">&#x27;ip_addr&#x27;</span>)</span><br><span class="line">        port = attrs.get(<span class="string">&#x27;port&#x27;</span>)</span><br><span class="line">        username = attrs.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = attrs.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo 基于ssh验证主机信息是否正确</span></span><br><span class="line">        cli = SSHParamiko(ip_addr, port, username, password=<span class="built_in">str</span>(password))</span><br><span class="line">        <span class="keyword">if</span> cli.is_validated():  <span class="comment"># 测试该链接是否能够使用</span></span><br><span class="line">            <span class="keyword">return</span> attrs</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;主机认证失败，用户或密码错误！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加host记录，如果第一次添加host记录，那么需要我们生成全局的公钥和私钥</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, validated_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;接受通过验证以后的数据字典:&#x27;</span>, validated_data)</span><br><span class="line">        ip_addr = validated_data.get(<span class="string">&#x27;ip_addr&#x27;</span>)</span><br><span class="line">        port = validated_data.get(<span class="string">&#x27;port&#x27;</span>)</span><br><span class="line">        username = validated_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = validated_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo 生成公私钥和管理主机的公私钥</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 剔除密码字段，保存host记录</span></span><br><span class="line">        password = validated_data.pop(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        instance = models.Host.objects.create(</span><br><span class="line">            **validated_data</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4-2、批量导入主机数据">4.2、批量导入主机数据</h2>
<h3 id="4-2-1、客户端发送excel文件">4.2.1、客户端发送excel文件</h3>
<p>Host.vue</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-row&gt;</span><br><span class="line">    &lt;a-col :span=&quot;6&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;add_host&quot; style=&quot;margin: 15px;&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-button @click=&quot;showHostModal&quot; type=&quot;primary&quot;&gt;</span><br><span class="line">          新建</span><br><span class="line">        &lt;/a-button&gt;</span><br><span class="line">        &lt;a-button type=&quot;primary&quot; @click=&quot;showExcelModal&quot; style=&quot;margin-left: 20px;&quot;&gt;</span><br><span class="line">          批量导入</span><br><span class="line">        &lt;/a-button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/a-row&gt;</span><br><span class="line">  &lt;a-table :dataSource=&quot;hostList.data&quot; :columns=&quot;hostFormColumns&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123; column, text, record &#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;action&#x27;&quot;&gt;</span><br><span class="line">        &lt;a-popconfirm</span><br><span class="line">            v-if=&quot;hostList.data.length&quot;</span><br><span class="line">            title=&quot;Sure to delete?&quot;</span><br><span class="line">            @confirm=&quot;deleteHost(record)&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;a&gt;Delete&lt;/a&gt;</span><br><span class="line">        &lt;/a-popconfirm&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;a-modal v-model:visible=&quot;hostFormVisible&quot; title=&quot;添加主机&quot; @ok=&quot;onHostFormSubmit&quot; @cancel=&quot;resetForm()&quot; :width=&quot;800&quot;&gt;</span><br><span class="line">    &lt;a-form</span><br><span class="line">        ref=&quot;formRef&quot;</span><br><span class="line">        name=&quot;custom-validation&quot;</span><br><span class="line">        :model=&quot;hostForm.form&quot;</span><br><span class="line">        :rules=&quot;hostForm.rules&quot;</span><br><span class="line">        v-bind=&quot;layout&quot;</span><br><span class="line">        @finish=&quot;handleFinish&quot;</span><br><span class="line">        @validate=&quot;handleValidate&quot;</span><br><span class="line">        @finishFailed=&quot;handleFinishFailed&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;a-form-item label=&quot;主机类别&quot; prop=&quot;zone&quot; name=&quot;category&quot;&gt;</span><br><span class="line">        &lt;a-row&gt;</span><br><span class="line">          &lt;a-col :span=&quot;12&quot;&gt;</span><br><span class="line">            &lt;a-select</span><br><span class="line">                ref=&quot;select&quot;</span><br><span class="line">                v-model:value=&quot;hostForm.form.category&quot;</span><br><span class="line">                @change=&quot;handleCategorySelectChange&quot;</span><br><span class="line"></span><br><span class="line">            &gt;</span><br><span class="line">              &lt;a-select-option :value=&quot;category.id&quot; v-for=&quot;category in categoryList.data&quot; :key=&quot;category.id&quot;&gt;</span><br><span class="line">                &#123;&#123; category.name &#125;&#125;</span><br><span class="line">              &lt;/a-select-option&gt;</span><br><span class="line">            &lt;/a-select&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/a-row&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;a-form-item has-feedback label=&quot;主机名称&quot; name=&quot;name&quot;&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;hostForm.form.name&quot; type=&quot;text&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &lt;a-form-item has-feedback label=&quot;连接地址&quot; name=&quot;username&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-row&gt;</span><br><span class="line">          &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">            &lt;a-input placeholder=&quot;用户名&quot; addon-before=&quot;ssh&quot; v-model:value=&quot;hostForm.form.username&quot; type=&quot;text&quot;</span><br><span class="line">                     autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line">          &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">            &lt;a-input placeholder=&quot;ip地址&quot; addon-before=&quot;@&quot; v-model:value=&quot;hostForm.form.ip_addr&quot; type=&quot;text&quot;</span><br><span class="line">                     autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line">          &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">            &lt;a-input placeholder=&quot;端口号&quot; addon-before=&quot;-p&quot; v-model:value=&quot;hostForm.form.port&quot; type=&quot;text&quot;</span><br><span class="line">                     autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line">        &lt;/a-row&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;a-form-item has-feedback label=&quot;连接密码&quot; name=&quot;password&quot;&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;hostForm.form.password&quot; type=&quot;password&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;a-form-item has-feedback label=&quot;备注信息&quot; name=&quot;remark&quot;&gt;</span><br><span class="line">        &lt;a-textarea placeholder=&quot;请输入主机备注信息&quot; v-model:value=&quot;hostForm.form.remark&quot; type=&quot;text&quot;</span><br><span class="line">                    :auto-size=&quot;&#123; minRows: 3, maxRows: 5 &#125;&quot; autocomplete=&quot;off&quot;/&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &lt;a-form-item :wrapper-col=&quot;&#123; span: 14, offset: 4 &#125;&quot;&gt;</span><br><span class="line">        &lt;a-button @click=&quot;resetForm&quot;&gt;Reset&lt;/a-button&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">    &lt;/a-form&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;/a-modal&gt;</span><br><span class="line">  &lt;a-modal</span><br><span class="line">      :width=&quot;600&quot;</span><br><span class="line">      title=&quot;新建主机类别&quot;</span><br><span class="line">      :visible=&quot;HostCategoryFromVisible&quot;</span><br><span class="line">      @cancel=&quot;hostCategoryFormCancel&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;template #footer&gt;</span><br><span class="line">      &lt;a-button key=&quot;back&quot; @click=&quot;hostCategoryFormCancel&quot;&gt;取消&lt;/a-button&gt;</span><br><span class="line">      &lt;a-button key=&quot;submit&quot; type=&quot;primary&quot; :loading=&quot;loading&quot; @click=&quot;onHostCategoryFromSubmit&quot;&gt;提交&lt;/a-button&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">    &lt;a-form-model ref=&quot;hostCategoryRuleForm&quot; v-model:value=&quot;hostCategoryForm.form&quot; :rules=&quot;hostCategoryForm.rules&quot;</span><br><span class="line">                  :label-col=&quot;hostCategoryForm.labelCol&quot; :wrapper-col=&quot;hostCategoryForm.wrapperCol&quot;&gt;</span><br><span class="line">      &lt;a-form-model-item ref=&quot;name&quot; label=&quot;类别名称&quot; prop=&quot;name&quot;&gt;</span><br><span class="line">        &lt;a-row&gt;</span><br><span class="line">          &lt;a-col :span=&quot;24&quot;&gt;</span><br><span class="line">            &lt;a-input placeholder=&quot;请输入主机类别名称&quot; v-model:value=&quot;hostCategoryForm.form.name&quot;/&gt;</span><br><span class="line">          &lt;/a-col&gt;</span><br><span class="line">        &lt;/a-row&gt;</span><br><span class="line">      &lt;/a-form-model-item&gt;</span><br><span class="line">    &lt;/a-form-model&gt;</span><br><span class="line">  &lt;/a-modal&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 批量导入主机 --&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;a-modal v-model:visible=&quot;excelVisible&quot; title=&quot;导入excel批量创建主机&quot; @ok=&quot;onExcelSubmit&quot; @cancel=&quot;excelFormCancel&quot;</span><br><span class="line">             :width=&quot;800&quot;&gt;</span><br><span class="line">      &lt;a-alert type=&quot;info&quot; message=&quot;导入或输入的密码仅作首次验证使用，并不会存储密码。&quot; banner closable/&gt;</span><br><span class="line">      &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        &lt;a-form-item has-feedback label=&quot;模板下载&quot; help=&quot;请下载使用该模板填充数据后导入&quot;&gt;</span><br><span class="line">          &lt;a download=&quot;主机导入模板.xls&quot;&gt;主机导入模板.xls&lt;/a&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        &lt;a-form-item label=&quot;默认密码&quot;</span><br><span class="line">                     help=&quot;如果Excel中密码为空则使用该密码&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;default_password&quot; placeholder=&quot;请输入默认主机密码&quot; type=&quot;password&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;导入数据&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;clearfix&quot;&gt;</span><br><span class="line">          &lt;a-upload</span><br><span class="line">              :file-list=&quot;fileList&quot;</span><br><span class="line">              name=&quot;file&quot;</span><br><span class="line">              :before-upload=&quot;beforeUpload&quot;</span><br><span class="line">          &gt;</span><br><span class="line">            &lt;a-button&gt;</span><br><span class="line">              &lt;upload-outlined&gt;&lt;/upload-outlined&gt;</span><br><span class="line">              Click to Upload</span><br><span class="line">            &lt;/a-button&gt;</span><br><span class="line">          &lt;/a-upload&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/a-modal&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;defineComponent, ref, reactive&#125; from &#x27;vue&#x27;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import settings from &quot;@/settings&quot;;</span><br><span class="line">import store from &quot;@/store&quot;;</span><br><span class="line">import &#123;message&#125; from &#x27;ant-design-vue&#x27;;</span><br><span class="line">import &#123;UploadOutlined&#125; from &#x27;@ant-design/icons-vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    UploadOutlined,</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    const handleCategorySelectChange = (value) =&gt; &#123;</span><br><span class="line">      // 切换主机类别的回调处理</span><br><span class="line">      console.log(value)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const formRef = ref();</span><br><span class="line">    const HostCategoryFromVisible = ref(false);</span><br><span class="line">    const default_password = ref(&quot;&quot;);</span><br><span class="line">    const hostList = reactive(&#123;</span><br><span class="line">      data: []</span><br><span class="line">    &#125;)</span><br><span class="line">    const categoryList = reactive(&#123;</span><br><span class="line">      data: []</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    const hostForm = reactive(&#123;</span><br><span class="line">      labelCol: &#123;span: 6&#125;,</span><br><span class="line">      wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">      other: &#x27;&#x27;,</span><br><span class="line">      form: &#123;</span><br><span class="line">        name: &#x27;&#x27;,</span><br><span class="line">        category: &quot;&quot;,</span><br><span class="line">        ip_addr: &#x27;&#x27;,</span><br><span class="line">        username: &#x27;&#x27;,</span><br><span class="line">        port: &#x27;&#x27;,</span><br><span class="line">        remark: &#x27;&#x27;,</span><br><span class="line">        password: &#x27;&#x27;</span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line">        name: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入主机名称&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        password: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入连接密码&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 30, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        category: [</span><br><span class="line">          &#123;required: true, message: &#x27;请选择类别&#x27;, trigger: &#x27;change&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        username: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入用户名&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;min: 3, max: 30, message: &#x27;长度在3-10位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        ip_addr: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入连接地址&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;max: 30, message: &#x27;长度最大15位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ],</span><br><span class="line">        port: [</span><br><span class="line">          &#123;required: true, message: &#x27;请输入端口号&#x27;, trigger: &#x27;blur&#x27;&#125;,</span><br><span class="line">          &#123;max: 5, message: &#x27;长度最大5位&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    let validateName = async (_rule, value) =&gt; &#123;</span><br><span class="line">      if (value === &#x27;&#x27;) &#123;</span><br><span class="line">        return Promise.reject(&#x27;请输入类别名称&#x27;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return Promise.resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    const hostCategoryForm = reactive(&#123;</span><br><span class="line">      labelCol: &#123;span: 6&#125;,</span><br><span class="line">      wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">      other: &#x27;&#x27;,</span><br><span class="line">      form: &#123;</span><br><span class="line">        name: &#x27;&#x27;</span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line">        name: [&#123;</span><br><span class="line">          required: true,</span><br><span class="line">          message: &#x27;请输入类别名称&#x27;,</span><br><span class="line">          validator: validateName,</span><br><span class="line">          trigger: &#x27;blur&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">          &#123;min: 3, max: 10, message: &#x27;长度在3-10位之间&#x27;, trigger: &#x27;blur&#x27;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    const layout = &#123;</span><br><span class="line">      labelCol: &#123;</span><br><span class="line">        span: 4,</span><br><span class="line">      &#125;,</span><br><span class="line">      wrapperCol: &#123;</span><br><span class="line">        span: 14,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleFinish = values =&gt; &#123;</span><br><span class="line">      console.log(values, hostForm);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleFinishFailed = errors =&gt; &#123;</span><br><span class="line">      console.log(errors);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const resetForm = () =&gt; &#123;</span><br><span class="line">      formRef.value.resetFields();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleValidate = (...args) =&gt; &#123;</span><br><span class="line">      console.log(args);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const hostFormVisible = ref(false);</span><br><span class="line">    const excelVisible = ref(false);</span><br><span class="line"></span><br><span class="line">    const showHostModal = () =&gt; &#123;</span><br><span class="line">      hostFormVisible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const onHostFormSubmit = () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">      // 将数据提交到后台进行保存，但是先进行连接校验，验证没有问题，再保存</span><br><span class="line"></span><br><span class="line">      const formData = new FormData();</span><br><span class="line">      for (let attr in hostForm.form) &#123;</span><br><span class="line">        formData.append(attr, hostForm.form[attr])</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      axios.post(`$&#123;settings.host&#125;/host/`, formData, &#123;</span><br><span class="line">            headers: &#123;</span><br><span class="line">              Authorization: store.getters.token,</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      ).then((response) =&gt; &#123;</span><br><span class="line">        console.log(&quot;response&gt;&gt;&gt;&quot;, response)</span><br><span class="line">        hostList.data.unshift(response.data)</span><br><span class="line"></span><br><span class="line">        // 清空</span><br><span class="line">        resetForm()</span><br><span class="line">        hostFormVisible.value = false; // 关闭对话框</span><br><span class="line">        message.success(&#x27;成功添加主机信息！&#x27;)</span><br><span class="line"></span><br><span class="line">      &#125;).catch((err) =&gt; &#123;</span><br><span class="line">        message.error(&#x27;添加主机失败&#x27;)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const deleteHost = record =&gt; &#123;</span><br><span class="line">      console.log(record);</span><br><span class="line">      axios.delete(`$&#123;settings.host&#125;/host/$&#123;record.id&#125;`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        let index = hostList.data.indexOf(record)</span><br><span class="line">        hostList.data.splice(index, 1);</span><br><span class="line"></span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        message.error(&#x27;删除主机失败！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    const showHostCategoryFormModal = () =&gt; &#123;</span><br><span class="line">      // 显示添加主机类别的表单窗口</span><br><span class="line">      HostCategoryFromVisible.value = true</span><br><span class="line">    &#125;</span><br><span class="line">    const hostCategoryFormCancel = () =&gt; &#123;</span><br><span class="line">      // 添加主机类别的表单取消</span><br><span class="line">      hostCategoryForm.form.name = &quot;&quot;; // 清空表单内容</span><br><span class="line">      HostCategoryFromVisible.value = false // 关闭对话框</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const excelFormCancel = () =&gt; &#123;</span><br><span class="line">      excelVisible.value = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const onHostCategoryFromSubmit = () =&gt; &#123;</span><br><span class="line">      // 添加主机类别的表单提交处理</span><br><span class="line">      // 将数据提交到后台进行保存，但是先进行连接校验，验证没有问题，再保存</span><br><span class="line">      axios.post(`$&#123;settings.host&#125;/host/category`, hostCategoryForm.form, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        message.success(&#123;</span><br><span class="line">          content: &quot;创建主机类别成功!&quot;,</span><br><span class="line">          duration: 1,</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">          console.log(&quot;response:::&quot;, response)</span><br><span class="line">          categoryList.data.unshift(response.data)</span><br><span class="line">          hostCategoryFormCancel()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const get_host_list = () =&gt; &#123;</span><br><span class="line">      // 获取主机类别列表</span><br><span class="line"></span><br><span class="line">      axios.get(`$&#123;settings.host&#125;/host`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        hostList.data = response.data</span><br><span class="line"></span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        message.error(&#x27;无法获取主机类别列表信息！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    const get_category_list = () =&gt; &#123;</span><br><span class="line">      // 获取主机类别列表</span><br><span class="line">      axios.get(`$&#123;settings.host&#125;/host/category`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        categoryList.data = response.data</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        message.error(&#x27;无法获取主机类别列表信息！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取主机列表</span><br><span class="line">    get_host_list()</span><br><span class="line">    get_category_list()</span><br><span class="line"></span><br><span class="line">    // 上传excel文件</span><br><span class="line">    const showExcelModal = () =&gt; &#123;</span><br><span class="line">      // 显示批量上传主机的窗口</span><br><span class="line">      excelVisible.value = true</span><br><span class="line">    &#125;</span><br><span class="line">    const handleChange = info =&gt; &#123;</span><br><span class="line">      if (info.file.status !== &#x27;uploading&#x27;) &#123;</span><br><span class="line">        console.log(info.file, info.fileList);</span><br><span class="line">      &#125;</span><br><span class="line">      if (info.file.status === &#x27;done&#x27;) &#123;</span><br><span class="line">        message.success(`$&#123;info.file.name&#125; file uploaded successfully`);</span><br><span class="line">      &#125; else if (info.file.status === &#x27;error&#x27;) &#123;</span><br><span class="line">        message.error(`$&#123;info.file.name&#125; file upload failed.`);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const fileList = ref([]);</span><br><span class="line">    const beforeUpload = (file) =&gt; &#123;</span><br><span class="line">      // 当用户选择上传文件以后，需要手动把当前文件添加到待上传文件列表this.excel_fileList中</span><br><span class="line">      fileList.value = [...fileList.value, file];</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    const onExcelSubmit = () =&gt; &#123;</span><br><span class="line">      // 将数据提交到后台进行保存，但是先进行连接校验，验证没有问题，再保存</span><br><span class="line">      const formData = new FormData();</span><br><span class="line">      console.log(&quot;fileList.value:&quot;, fileList.value)</span><br><span class="line">      fileList.value.forEach(file =&gt; &#123;</span><br><span class="line">        console.log(&quot;&gt;&gt;&gt;&quot;, file)</span><br><span class="line">        formData.append(&#x27;host_excel&#x27;, file);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      axios.post(`$&#123;settings.host&#125;/host/excel_host`, formData, &#123;</span><br><span class="line">            headers: &#123;</span><br><span class="line">              Authorization: store.getters.token,</span><br><span class="line">              &#x27;Content-Type&#x27;: &#x27;multipart/form-data&#x27;, // 上传文件必须设置请求头中的提交内容格式：multipart/form-data</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      ).then((response) =&gt; &#123;</span><br><span class="line">        console.log(&quot;response:::&quot;, response)</span><br><span class="line">        console.log(&quot;hostList:::&quot;, hostList)</span><br><span class="line">        excelFormCancel()// 关闭对话框</span><br><span class="line">        fileList.value = []</span><br><span class="line">        hostList.data.push(...response.data.data)</span><br><span class="line">        message.success(&#x27;批量创建主机成功!！&#x27;)</span><br><span class="line"></span><br><span class="line">      &#125;).catch((response) =&gt; &#123;</span><br><span class="line">        message.error(response.data.message)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      beforeUpload,</span><br><span class="line">      onExcelSubmit,</span><br><span class="line">      selectHostCategory: ref(&#x27;yuan&#x27;),</span><br><span class="line">      hostForm,</span><br><span class="line">      formRef,</span><br><span class="line">      layout,</span><br><span class="line">      HostCategoryFromVisible,</span><br><span class="line">      handleCategorySelectChange,</span><br><span class="line">      handleFinishFailed,</span><br><span class="line">      handleFinish,</span><br><span class="line">      resetForm,</span><br><span class="line">      handleValidate,</span><br><span class="line">      hostFormVisible,</span><br><span class="line">      excelVisible,</span><br><span class="line">      showHostModal,</span><br><span class="line">      onHostFormSubmit,</span><br><span class="line">      deleteHost,</span><br><span class="line">      showHostCategoryFormModal,</span><br><span class="line">      hostCategoryForm,</span><br><span class="line">      hostCategoryFormCancel,</span><br><span class="line">      excelFormCancel,</span><br><span class="line">      onHostCategoryFromSubmit,</span><br><span class="line">      showExcelModal,</span><br><span class="line">      default_password,</span><br><span class="line">      fileList,</span><br><span class="line">      headers: &#123;</span><br><span class="line">        authorization: &#x27;authorization-text&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      handleChange,</span><br><span class="line">      hostFormColumns: [</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;类别&#x27;,</span><br><span class="line">          dataIndex: &#x27;category_name&#x27;,</span><br><span class="line">          key: &#x27;category_name&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;主机名称&#x27;,</span><br><span class="line">          dataIndex: &#x27;name&#x27;,</span><br><span class="line">          key: &#x27;name&#x27;,</span><br><span class="line">          sorter: true,</span><br><span class="line">          width: 230</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;连接地址&#x27;,</span><br><span class="line">          dataIndex: &#x27;ip_addr&#x27;,</span><br><span class="line">          key: &#x27;ip_addr&#x27;,</span><br><span class="line">          ellipsis: true,</span><br><span class="line">          sorter: true,</span><br><span class="line">          width: 150</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;端口&#x27;,</span><br><span class="line">          dataIndex: &#x27;port&#x27;,</span><br><span class="line">          key: &#x27;port&#x27;,</span><br><span class="line">          ellipsis: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;备注信息&#x27;,</span><br><span class="line">          dataIndex: &#x27;remark&#x27;,</span><br><span class="line">          key: &#x27;remark&#x27;,</span><br><span class="line">          ellipsis: true</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          title: &#x27;操作&#x27;,</span><br><span class="line">          key: &#x27;action&#x27;,</span><br><span class="line">          width: 200,</span><br><span class="line">          dataIndex: &quot;action&quot;,</span><br><span class="line">          scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      hostList,</span><br><span class="line">      categoryList,</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220624192147465-6069708-6069777.png" alt="image-20220624192147465"></p>
<h3 id="4-2-2、基于excel批量创建主机">4.2.2、基于excel批量创建主机</h3>
<p><code>host.urls.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;excel_host&#x27;</span>, views.ExcelHostView.as_view()),</span><br></pre></td></tr></table></figure>
<p><code>host.views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> openpyxl <span class="keyword">import</span> load_workbook</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_host_excel_data</span>(<span class="params">io_data, default_password=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从excel中读取主机列表信息</span></span><br><span class="line"><span class="string">    io_data: 主机列表的字节流</span></span><br><span class="line"><span class="string">    default_password: 主机的默认登录密码</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载某一个excel文件</span></span><br><span class="line">    wb = load_workbook(io_data)</span><br><span class="line">    <span class="comment"># 获取worksheet对象的两种方式</span></span><br><span class="line">    worksheet = wb.worksheets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># c1 = worksheet.cell(2, 1)  # 第二行第一列</span></span><br><span class="line">    <span class="comment"># print(&quot;c1 data:::&quot;, c1.value)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询出数据库现有的所有分类数据[ID，name]</span></span><br><span class="line">    <span class="comment"># 由于拿到的是分类名称，所以我们要找到对应名称的分类id，才能去数据库里面存储</span></span><br><span class="line">    category_list = HostCategory.objects.values_list(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主机列表</span></span><br><span class="line">    host_info_list = []</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> worksheet.iter_rows(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> row[<span class="number">0</span>].value: <span class="keyword">continue</span></span><br><span class="line">        one_row_dict = &#123;&#125;  <span class="comment"># 单个主机信息字典</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> category_data <span class="keyword">in</span> category_list:</span><br><span class="line">            <span class="comment"># print(category_data[1],type(category_data[1]),category,type(category))</span></span><br><span class="line">            <span class="keyword">if</span> category_data[<span class="number">1</span>].strip() == row[<span class="number">0</span>].value:</span><br><span class="line">                one_row_dict[<span class="string">&#x27;category&#x27;</span>] = category_data[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        one_row_dict[<span class="string">&quot;name&quot;</span>] = row[<span class="number">1</span>].value  <span class="comment"># 主机别名</span></span><br><span class="line">        one_row_dict[<span class="string">&#x27;ip_addr&#x27;</span>] = row[<span class="number">2</span>].value  <span class="comment"># 主机地址</span></span><br><span class="line">        one_row_dict[<span class="string">&#x27;port&#x27;</span>] = row[<span class="number">3</span>].value  <span class="comment"># 主机端口号</span></span><br><span class="line">        one_row_dict[<span class="string">&#x27;username&#x27;</span>] = row[<span class="number">4</span>].value  <span class="comment"># 登录账户名</span></span><br><span class="line"></span><br><span class="line">        excel_pwd = row[<span class="number">5</span>].value</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwd = <span class="built_in">str</span>(excel_pwd)  <span class="comment"># 这样强转容易报错，最好捕获一下异常，并记录单元格位置，给用户保存信息时，可以提示用户哪个单元格的数据有问题</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            pwd = default_password</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pwd.strip():</span><br><span class="line">            pwd = default_password</span><br><span class="line"></span><br><span class="line">        one_row_dict[<span class="string">&#x27;password&#x27;</span>] = pwd</span><br><span class="line">        one_row_dict[<span class="string">&#x27;description&#x27;</span>] = row[<span class="number">6</span>].value</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;one_row_dict&quot;</span>, one_row_dict)</span><br><span class="line"></span><br><span class="line">        host_info_list.append(one_row_dict)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验主机数据</span></span><br><span class="line">    <span class="comment"># 将做好的主机信息字典数据通过我们添加主机时的序列化器进行校验</span></span><br><span class="line">    res_data = &#123;&#125;  <span class="comment"># 存放上传成功之后需要返回的主机数据和某些错误信息数据</span></span><br><span class="line">    serializers_host_res_data = []</span><br><span class="line">    res_error_data = []</span><br><span class="line">    <span class="keyword">for</span> k, host_data <span class="keyword">in</span> <span class="built_in">enumerate</span>(host_info_list):</span><br><span class="line">        <span class="comment"># 反序列化校验每一个主机信息</span></span><br><span class="line">        serailizer = HostModelSerializers(data=host_data)</span><br><span class="line">        <span class="keyword">if</span> serailizer.is_valid():</span><br><span class="line">            new_host_obj = serailizer.save()</span><br><span class="line">            serializers_host_res_data.append(new_host_obj)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 报错，并且错误信息中应该体验错误的数据位置</span></span><br><span class="line">            res_error_data.append(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">f&#x27;该<span class="subst">&#123;k + <span class="number">1</span>&#125;</span>行数据有误,其他没有问题的数据，已经添加成功了，请求失败数据改完之后，重新上传这个错误数据，成功的数据不需要上传了&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 再次调用序列化器进行数据的序列化，返回给客户端</span></span><br><span class="line">    serializer = HostModelSerializers(instance=serializers_host_res_data, many=<span class="literal">True</span>)</span><br><span class="line">    res_data[<span class="string">&#x27;data&#x27;</span>] = serializer.data</span><br><span class="line">    res_data[<span class="string">&#x27;error&#x27;</span>] = res_error_data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExcelHostView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;批量导入主机列表&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 接受客户端上传的数据</span></span><br><span class="line">        host_excel = request.FILES.get(<span class="string">&quot;host_excel&quot;</span>)</span><br><span class="line">        default_password = request.data.get(<span class="string">&quot;default_password&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;host_excel:::&quot;</span>, host_excel, <span class="built_in">type</span>(host_excel))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;default_password:::&quot;</span>, default_password, <span class="built_in">type</span>(default_password))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # 把上传文件全部写入到字节流，就不需要保存到服务端硬盘了。</span></span><br><span class="line">        io_data = BytesIO()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> host_excel:</span><br><span class="line">            io_data.write(line)</span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        data = read_host_excel_data(io_data, default_password)</span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4-3、consoles功能">4.3、consoles功能</h2>
<h3 id="4-3-1、免密登陆">4.3.1、免密登陆</h3>
<p>前面我们已经完成了主机列表展示和添加了，我们实现添加主机时，新添加主机需要填写连接主机的用户名和密码，我们接下来就需要通过密码来进行主机连接验证，如果用户名和密码没有问题，那么添加到主机列表中，以后对这个主机的操作都能够完成免密操作，所以我们有两件事情要做：</p>
<p>1、在添加主机信息时连接一次远程主机</p>
<p>2、配置公私钥进行免密登录</p>
<p><img src="assets/image-20210116154703129-6570800-6570802.png" alt="image-20210116154703129"></p>
<p><code>host.models.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">from</span> uric_api.utils.models <span class="keyword">import</span> BaseModel, models</span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.ssh <span class="keyword">import</span> SSHParamiko</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostCategory</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机类别&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;host_category&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;主机类别&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name  <span class="comment"># 取消提示文字中关于英文复数+s的情况</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Host</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># 真正在数据库中的字段实际上叫 category_id，而category则代表了关联的哪个分类模型对象</span></span><br><span class="line">    category = models.ForeignKey(<span class="string">&#x27;HostCategory&#x27;</span>, on_delete=models.DO_NOTHING, verbose_name=<span class="string">&#x27;主机类别&#x27;</span>, related_name=<span class="string">&#x27;hc&#x27;</span>,</span><br><span class="line">                                 null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    ip_addr = models.CharField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>, max_length=<span class="number">500</span>, verbose_name=<span class="string">&#x27;连接地址&#x27;</span>)</span><br><span class="line">    port = models.IntegerField(verbose_name=<span class="string">&#x27;端口&#x27;</span>)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">&#x27;登录用户&#x27;</span>)</span><br><span class="line">    users = models.ManyToManyField(User)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;host&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;主机信息&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name + <span class="string">&#x27;:&#x27;</span> + self.ip_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局密钥和共钥，所有用户都使用这个一对</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PkeyModel</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name = models.CharField(max_length=<span class="number">500</span>, unique=<span class="literal">True</span>)  <span class="comment"># 名称</span></span><br><span class="line">    private = models.TextField(verbose_name=<span class="string">&quot;私钥&quot;</span>)</span><br><span class="line">    public = models.TextField(verbose_name=<span class="string">&quot;公钥&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;Pkey <span class="subst">&#123;self.name&#125;</span>&gt;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>数据库迁移。</p>
<p>对PkeyModel的操作，我们简单封装2个方法用于存储和读取公私钥，方便后续操作</p>
<p>创建<code>uric/utils/key.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"><span class="keyword">from</span> host.models <span class="keyword">import</span> PkeyModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PkeyManager</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    keys = (<span class="string">&#x27;public_key&#x27;</span>, <span class="string">&#x27;private_key&#x27;</span>,)</span><br><span class="line">    <span class="comment"># 由于我们可能经常会执行这个get操作，所以我们使用了django的缓存机制，对方法的结果进行缓存，</span></span><br><span class="line">    <span class="comment"># 第二次调用 get()方法 时，并没有真正执行方法，而是直接返回缓存的结果，</span></span><br><span class="line">    <span class="comment"># 参数maxsize为最多缓存的次数，如果为None，则无限制，设置为2n时，性能最佳</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @lru_cache(<span class="params">maxsize=<span class="number">64</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">cls, name</span>):</span><br><span class="line">        info = PkeyModel.objects.<span class="built_in">filter</span>(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">f&#x27;没有这个 <span class="subst">&#123;name!r&#125;</span> 秘钥对&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 以元组格式，返回公私钥</span></span><br><span class="line">        <span class="keyword">return</span> (info.private, info.public)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">cls, name, private_key, public_key, description=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存公私钥&quot;&quot;&quot;</span></span><br><span class="line">        PkeyModel.objects.update_or_create(name=name, defaults=&#123;</span><br><span class="line">            <span class="string">&#x27;private&#x27;</span>: private_key,</span><br><span class="line">            <span class="string">&#x27;public&#x27;</span>: public_key,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span>: description</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<p><code>utils.ssh</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> paramiko.client <span class="keyword">import</span> SSHClient, AutoAddPolicy</span><br><span class="line"><span class="keyword">from</span> paramiko.rsakey <span class="keyword">import</span> RSAKey</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> AuthenticationException, SSHException</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> NoValidConnectionsError</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSHParamiko</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, hostname, port=<span class="number">22</span>, username=<span class="string">&#x27;root&#x27;</span>, pkey=<span class="literal">None</span>, password=<span class="literal">None</span>, connect_timeout=<span class="number">3</span></span>):</span><br><span class="line">        <span class="keyword">if</span> pkey <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> password <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> SSHException(<span class="string">&#x27;私钥或者密码必须选择传入一个&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.client = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.params = &#123;</span><br><span class="line">            <span class="string">&#x27;hostname&#x27;</span>: hostname,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>: port,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: password,</span><br><span class="line">            <span class="string">&#x27;pkey&#x27;</span>: RSAKey.from_private_key(StringIO(pkey)) <span class="keyword">if</span> <span class="built_in">isinstance</span>(pkey, <span class="built_in">str</span>) <span class="keyword">else</span> pkey,</span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span>: connect_timeout,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检测连接并获取连接</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_connected_client</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.client <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 告知当前执行上下文，self.client已经实例化</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;已经建立连接了！！！&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.client:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 创建客户端连接对象</span></span><br><span class="line">                self.client = SSHClient()</span><br><span class="line">                <span class="comment"># 在本机第一次连接远程主机时记录指纹信息</span></span><br><span class="line">                self.client.set_missing_host_key_policy(AutoAddPolicy)</span><br><span class="line">                <span class="comment"># 建立连接: 口令密码或者密钥</span></span><br><span class="line">                self.client.connect(**self.params)</span><br><span class="line">            <span class="keyword">except</span> (TimeoutError, NoValidConnectionsError, AuthenticationException) <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.client</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_key</span>():</span><br><span class="line">        <span class="comment"># 生成公私钥键值对</span></span><br><span class="line">        iodata = StringIO()</span><br><span class="line">        key = RSAKey.generate(<span class="number">2048</span>)  <span class="comment"># 生成长度为2024的秘钥对</span></span><br><span class="line">        key.write_private_key(iodata)</span><br><span class="line">        <span class="comment"># 返回值是一个元祖，两个成员分别是私钥和公钥</span></span><br><span class="line">        <span class="keyword">return</span> iodata.getvalue(), <span class="string">&#x27;ssh-rsa &#x27;</span> + key.get_base64()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将公钥上传到对应主机</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_key</span>(<span class="params">self, public_key</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;self.client:::&quot;</span>, self.client)</span><br><span class="line">        <span class="comment"># 700 是文档拥有可读可写可执行，同一组用户或者其他用户都不具有操作权限</span></span><br><span class="line">        <span class="comment"># 600 是文件拥有者可读可写，不可执行，同一组用户或者其他用户都不具有操作权限</span></span><br><span class="line">        cmd = <span class="string">f&#x27;mkdir -p -m 700 ~/.ssh &amp;&amp; \</span></span><br><span class="line"><span class="string">            echo <span class="subst">&#123;public_key!r&#125;</span> &gt;&gt; ~/.ssh/authorized_keys &amp;&amp; \</span></span><br><span class="line"><span class="string">            chmod 600 ~/.ssh/authorized_keys&#x27;</span></span><br><span class="line">        code, out = self.execute_cmd(cmd)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;out&quot;</span>, out)</span><br><span class="line">        <span class="keyword">if</span> code != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f&#x27;添加公钥失败: <span class="subst">&#123;out&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_cmd</span>(<span class="params">self, cmd, timeout=<span class="number">1800</span>, environment=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 设置执行指令过程，一旦遇到错误/异常，则直接退出操作，不再继续执行。</span></span><br><span class="line">        cmd = <span class="string">&#x27;set -e\n&#x27;</span> + cmd</span><br><span class="line">        channel = self.client.get_transport().open_session()</span><br><span class="line">        channel.settimeout(timeout)</span><br><span class="line">        channel.set_combine_stderr(<span class="literal">True</span>)  <span class="comment"># 正确和错误输出都在一个管道对象里面输出出来</span></span><br><span class="line">        channel.exec_command(cmd)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            out_data = channel.makefile(<span class="string">&quot;rb&quot;</span>, -<span class="number">1</span>).read().decode()</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            out_data = channel.makefile(<span class="string">&quot;rb&quot;</span>, -<span class="number">1</span>).read().decode(<span class="string">&quot;GBK&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> channel.recv_exit_status(), out_data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>序列化器：<code>host.serializers</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.ssh <span class="keyword">import</span> SSHParamiko</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.key <span class="keyword">import</span> PkeyManager</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostCategoryModelSeiralizer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机分类的序列化器&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = models.HostCategory</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HostModelSerializers</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主机信息的序列化器&quot;&quot;&quot;</span></span><br><span class="line">    password = serializers.CharField(max_length=<span class="number">32</span>, write_only=<span class="literal">True</span>, label=<span class="string">&quot;登录密码&quot;</span>)</span><br><span class="line">    category_name = serializers.CharField(source=<span class="string">&quot;category.name&quot;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = models.Host</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&quot;category_name&quot;</span>, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ip_addr&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_public_key</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># todo 生成公私钥和管理主机的公私钥</span></span><br><span class="line">        <span class="comment"># 生成公私钥和管理主机的公私钥</span></span><br><span class="line">        <span class="comment"># 创建公私钥之前，我们先看看之前是否已经创建过公私钥了</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 尝试从数据库中提取公私钥</span></span><br><span class="line">            private_key, public_key = PkeyManager.get(settings.DEFAULT_KEY_NAME)</span><br><span class="line">        <span class="keyword">except</span> KeyError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 没有公私钥存储到数据库中，则生成公私钥</span></span><br><span class="line">            private_key, public_key = self.ssh.gen_key()</span><br><span class="line">            <span class="comment"># 将公钥和私钥保存到数据库中</span></span><br><span class="line">            PkeyManager.<span class="built_in">set</span>(settings.DEFAULT_KEY_NAME, private_key, public_key, <span class="string">&#x27;ssh全局秘钥对&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> public_key</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">self, attrs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;当用户添加、编辑主机信息会自动执行这个方法&quot;&quot;&quot;</span></span><br><span class="line">        ip_addr = attrs.get(<span class="string">&#x27;ip_addr&#x27;</span>)</span><br><span class="line">        port = attrs.get(<span class="string">&#x27;port&#x27;</span>)</span><br><span class="line">        username = attrs.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = attrs.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo 基于ssh验证主机信息是否正确</span></span><br><span class="line">        self.ssh = SSHParamiko(ip_addr, port, username, password=<span class="built_in">str</span>(password))</span><br><span class="line">        self.client = self.ssh.get_connected_client()</span><br><span class="line">        <span class="keyword">if</span> self.client:  <span class="comment"># 测试该链接是否能够使用</span></span><br><span class="line">            public_key = self.get_public_key()</span><br><span class="line">            <span class="comment"># 上传公钥到服务器中</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;public_key&quot;</span>, public_key)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.ssh.upload_key(public_key)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;添加远程主机失败，请检查输入的主机信息!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> attrs</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;主机认证信息错误！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加host记录，如果第一次添加host记录，那么需要我们生成全局的公钥和私钥</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, validated_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;接受通过验证以后的数据字典:&#x27;</span>, validated_data)</span><br><span class="line">        ip_addr = validated_data.get(<span class="string">&#x27;ip_addr&#x27;</span>)</span><br><span class="line">        port = validated_data.get(<span class="string">&#x27;port&#x27;</span>)</span><br><span class="line">        username = validated_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = validated_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 剔除密码字段，保存host记录</span></span><br><span class="line">        password = validated_data.pop(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        instance = models.Host.objects.create(</span><br><span class="line">            **validated_data</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>settings.dev配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_KEY_NAME = <span class="string">&quot;global&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>from django.conf import settings</li>
</ol>
</blockquote>
<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@47.112.179.213</span><br><span class="line">vim ~/.ssh/authorized_keys </span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220701142255065-6656576.png" alt="image-20220701142255065"></p>
<p>远程服务器的authorized_keys 目前为空。</p>
<p>此时Pkeymodel没有记录，添加主机成功后Pkeymodel中生成记录，远程服务器的authorized_keys中也有了记录。</p>
<p>接下来测试是否可以免密登陆</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">from</span> paramiko.ssh_exception <span class="keyword">import</span> AuthenticationException</span><br><span class="line"><span class="keyword">from</span> paramiko.rsakey <span class="keyword">import</span> RSAKey</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 通过parammiko创建一个ssh短连接客户端实例对象</span></span><br><span class="line">    ssh = paramiko.SSHClient()</span><br><span class="line">    <span class="comment"># 自动在本机第一次连接远程服务器时，记录主机指纹</span></span><br><span class="line">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 直接密码远程连接的方式</span></span><br><span class="line">        <span class="comment"># ssh.connect(hostname=&#x27;47.112.179.213&#x27;, port=22, username=&#x27;root&#x27;, password=&#x27;Bazinga$yuan&#x27;, timeout=10)</span></span><br><span class="line">        <span class="comment"># 注意，如果你测试某个服务器的连接时，如果你本地已经配置了这个远程服务器的免密登录(公私钥模式)，那么就不能测试出密码是否正确了，因为首先会通过公私钥模式登录，不会使用你的密码的。</span></span><br><span class="line">        <span class="comment"># 2. 使用秘钥免密登录的方式</span></span><br><span class="line">        <span class="comment"># pkey = PkeyModel.objects.get(name=&#x27;&#x27;).private</span></span><br><span class="line">        private_key = <span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">        pkey = RSAKey.from_private_key(StringIO(private_key))</span><br><span class="line">        ssh.connect(hostname=<span class="string">&#x27;47.112.179.213&#x27;</span>, port=<span class="number">22</span>, username=<span class="string">&#x27;root&#x27;</span>, pkey=pkey, timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 连接成功以后，就可以发送操作指令</span></span><br><span class="line">        <span class="comment"># stdin 输入[本机发送给远程主机的信息]</span></span><br><span class="line">        <span class="comment"># stdout 输出[远程主机返回给本机的信息]</span></span><br><span class="line">        <span class="comment"># stderr 错误</span></span><br><span class="line">        stdin, stdout, stderr = ssh.exec_command(<span class="string">&#x27;ls -la&#x27;</span>)</span><br><span class="line">        <span class="comment"># 读取stdout对象中返回的内容，返回结果bytes类型数据</span></span><br><span class="line">        result = stdout.read()</span><br><span class="line">        <span class="built_in">print</span>(result.decode())</span><br><span class="line">        <span class="comment"># 关闭连接</span></span><br><span class="line">        ssh.close()</span><br><span class="line">    <span class="keyword">except</span> AuthenticationException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e.message)</span><br><span class="line">        <span class="built_in">print</span>(traceback.format_exc())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;连接参数有误，请检查连接信息是否正确！~&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-3-2、websocket与django-channels">4.3.2、websocket与django-channels</h3>
<h4 id="（1）websocket协议">（1）websocket协议</h4>
<p>http请求的特点：</p>
<blockquote>
<p>基于TCP</p>
<p>基于请求响应</p>
<p>短链接</p>
<p>无状态保存</p>
</blockquote>
<p><code>WebSocket</code>是一种在单个<code>TCP</code>连接上进行全双工通讯的协议。<code>WebSocket</code>允许服务端主动向客户端推送数据。在<code>WebSocket</code>协议中，客户端浏览器和服务器只需要完成一次握手就可以创建持久性的连接，并在浏览器和服务器之间进行双向的数据传输。</p>
<p><img src="assets/ws-6725179.png" alt="ws"></p>
<p>在一个HTTP访问周期里，如果要执行一个长时间任务，为了避免浏览器等待，后台必须使用异步动作。与此同时也要满足实时需求，用户提交了任务后可以随时去访问任务详情页面，在这里用户能够实时地看到任务的执行进度。</p>
<p>针对异步任务处理，我们使用了Celery把任务放到后台执行。Celery 是一个基于python开发的分布式异步消息任务队列，通过它可以轻松的实现任务的异步处理，Celery在处理一个任务的时候，会把这个任务的进度记录在数据库中。</p>
<p>实现任务的后台执行后，下一步就要解决实时地更新进度信息到网页的问题。从上一步可以知道，数据库中已经存在了任务的进度信息，网页直接访问数据库就可以拿到数据。但是数据库中的进度信息更新的速率不固定，如果使用间隔时间比较短的ajax轮询来访问数据库，会产生很多无用请求，造成资源浪费。综合考虑，我们决定使用WebSocket来实现推送任务进度信息的功能。网站是使用Django搭建的，原生的MTV(模型-模板-视图)设计模式只支持Http请求。幸好Django开发团队在过去的几年里也看到实时网络应用的蓬勃发展，发布了Channels，以插件的形式为Django带来了实时能力。下面两张图展示了原生Django与集成Channels的Django。</p>
<p><img src="assets/modb_20210205_6df9aa28-677b-11eb-bca4-5254001c05fe.png" alt="img"></p>
<p>原生Django</p>
<p>Django本身不支持WebSocket，但可以通过集成Channels框架来实现WebSocket</p>
<p>Channels是针对Django项目的一个增强框架，可以使Django不仅支持HTTP协议，还能支持WebSocket，MQTT等多种协议，同时Channels还整合了Django的auth以及session系统方便进行用户管理及认证。</p>
<p><img src="assets/modb_20210205_6e157488-677b-11eb-bca4-5254001c05fe.png" alt="img"></p>
<p>集成Channels的Django</p>
<p>对比两张图可以看出，Channels为Django带来了一些新特性，最明显的就是添加了对WebSocket的支持。Channels最重要的部分也可以看做是任务队列，消息被生产者推到通道，然后传递给监听通道的消费者之一。它与传统的任务队列的主要的区别在于Channels通过网络工作，使生产者和消费者透明地运行在多台机器上，这个网络层就叫做channel layer。Channels推荐使用redis作为它的channel layer backend，但也可以使用其它类型的工具，例如rabbitmq、内存或者IPC。关于Channels的一些基本概念，推荐阅读官方文档。</p>
<p>WebSocket的请求头中重要的字段：</p>
<blockquote>
<p>Connection和Upgrade：表示客户端发起的WebSocket请求</p>
<p>Sec-WebSocket-Version：客户端所使用的WebSocket协议版本号，服务端会确认是否支持该版本号</p>
<p>Sec-WebSocket-Key：一个Base64编码值，由浏览器随机生成，用于升级request WebSocket的响应头中重要的字段</p>
</blockquote>
<p>HTTP/1.1 101 Switching Protocols：切换协议，WebSocket协议通过HTTP协议来建立运输层的TCP连接</p>
<blockquote>
<p>Connection和Upgrade：表示服务端发起的WebSocket响应<br>
Sec-WebSocket-Accept：表示服务器接受了客户端的请求，由Sec-WebSocket-Key计算得来</p>
</blockquote>
<p>WebSocket协议的优点：</p>
<blockquote>
<p>支持双向通信，实时性更强<br>
数据格式比较轻量，性能开销小，通信高效<br>
支持扩展，用户可以扩展协议或者实现自定义的子协议(比如支持自定义压缩算法等)</p>
</blockquote>
<p>WebSocket协议的缺点：</p>
<blockquote>
<p>少部分浏览器不支持，浏览器支持的程度与方式有区别<br>
长连接对后端处理业务的代码稳定性要求更高，后端推送功能相对复杂<br>
成熟的HTTP生态下有大量的组件可以复用，WebSocket较少</p>
</blockquote>
<p>WebSocket的应用场景：</p>
<blockquote>
<p>即时聊天通信，网站消息通知<br>
在线协同编辑，如腾讯文档<br>
多玩家在线游戏，视频弹幕，股票基金实施报价</p>
</blockquote>
<h4 id="（2）channels语法">（2）channels语法</h4>
<p><img src="assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpbndvdw==,size_16,color_FFFFFF,t_70-20211121090203572.png" alt="img"></p>
<p>继承<code>WebSocketConsumer</code>的连接。</p>
<p>AuthMiddlewareStack：用于WebSocket认证，继承了Cookie Middleware，SessionMiddleware，SessionMiddleware。django的channels封装了django的auth模块，使用这个配置我们就可以在consumer中通过下边的代码获取到用户的信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">    self.user = self.scope[<span class="string">&quot;user&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>self.scope类似于django中的request，包含了请求的type、path、header、cookie、session、user等等有用的信息</p>
<h4 id="（3）websocket案例">（3）websocket案例</h4>
<p>配置和使用</p>
<blockquote>
<p>channels==2.1.3</p>
<p>channels-redis==2.3.0</p>
<p>注意版本号</p>
</blockquote>
<p>启动 Redis 服务默认使用 6379 端口，Django 将使用该端口连接 Redis 服务。</p>
<p>更新项目配置文件 <a target="_blank" rel="noopener" href="http://settings.py">settings.py</a> 中的 INSTALLED_APPS 项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;app01.apps.App01Config&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;channels&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ASGI_APPLICATION = <span class="string">&quot;chat.routing.application&quot;</span></span><br><span class="line"><span class="comment"># WebSocket</span></span><br><span class="line">CHANNEL_LAYERS = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;channels_redis.core.RedisChannelLayer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONFIG&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;hosts&quot;</span>: [(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>wsgi.py</code> 同级目录新增文件 <code>routing.py</code>,其作用类型与 <code>urls.py</code> ,用于分发<code>webscoket</code>请求:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> channels.auth <span class="keyword">import</span> AuthMiddlewareStack</span><br><span class="line"><span class="keyword">from</span> channels.routing <span class="keyword">import</span> ProtocolTypeRouter, URLRouter</span><br><span class="line"><span class="keyword">from</span> table.consumers <span class="keyword">import</span> TableConsumer</span><br><span class="line"></span><br><span class="line">application = ProtocolTypeRouter(&#123;</span><br><span class="line">    <span class="comment"># Empty for now (http-&gt;django views is added by default)</span></span><br><span class="line">    <span class="string">&#x27;websocket&#x27;</span>: AuthMiddlewareStack(</span><br><span class="line">        URLRouter([</span><br><span class="line">            path(<span class="string">&#x27;ws/table/&lt;slug:table_id&gt;/&#x27;</span>, TableConsumer),</span><br><span class="line">        ])</span><br><span class="line">    ),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>routing.py</code>路由文件跟<code>django</code>的<code>url.py</code>功能类似，语法也一样，意思就是访问<code>ws/table/</code>都交给TableConsumer处理。</p>
</blockquote>
<p>新增 app 名为 <code>table</code>,在 <code>table</code> 目录下新增 <code>consumers.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncJsonWebsocketConsumer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoomConsumer</span>(<span class="title class_ inherited__">AsyncJsonWebsocketConsumer</span>):</span><br><span class="line">    room_id = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        self.room_id = <span class="string">&#x27;room_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.scope[<span class="string">&#x27;url_route&#x27;</span>][<span class="string">&#x27;kwargs&#x27;</span>][<span class="string">&#x27;room_id&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;room_id&quot;</span>, self.room_id)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;self.channel_name&quot;</span>, self.channel_name)</span><br><span class="line">        <span class="comment"># # Join room group</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;将<span class="subst">&#123;self.channel_name&#125;</span>客户端对象添加到组group<span class="subst">&#123;self.room_id&#125;</span>中&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_add(self.room_id, self.channel_name)</span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self, close_code</span>):</span><br><span class="line">        <span class="comment"># # Leave room group</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_discard(self.room_id, self.channel_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Receive message from WebSocket</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">receive_json</span>(<span class="params">self, content, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;::::&quot;</span>, content, <span class="built_in">type</span>(content))</span><br><span class="line">        <span class="comment"># # Send message to room group</span></span><br><span class="line">        self.from_client = <span class="built_in">str</span>(self.scope[<span class="string">&quot;client&quot;</span>])</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(self.room_id,</span><br><span class="line">                                            &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;message&#x27;</span>, <span class="string">&#x27;msg&#x27;</span>: content, <span class="string">&quot;from_client&quot;</span>: self.from_client&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Receive message from room group</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">self, event</span>):</span><br><span class="line">        message = event[<span class="string">&#x27;msg&#x27;</span>]</span><br><span class="line">        <span class="comment"># print(&quot;self.scope&quot;, self.scope)</span></span><br><span class="line">        <span class="comment"># Send message to WebSocket</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;:::&quot;</span>, event[<span class="string">&quot;from_client&quot;</span>] + <span class="string">&quot;:&quot;</span> + message)</span><br><span class="line">        <span class="keyword">await</span> self.send_json(event[<span class="string">&quot;from_client&quot;</span>] + <span class="string">&quot;&gt;&gt;&gt;&quot;</span> + message)</span><br></pre></td></tr></table></figure>
<p><code>TableConsumer</code>类中的函数依次用于处理连接、断开连接、接收消息和处理对应类型的消息，其中<code>channel_layer.group_send(self.table, &#123;'type': 'message', 'message': content&#125;)</code>方法，<code>self.table</code> 参数为当前组的组id， <code>&#123;'type': 'message', 'message': content&#125;</code> 部分分为两部分，<code>type</code> 用于指定该消息的类型，根据消息类型调用不同的函数去处理消息，而 <code>message</code> 内为消息主体。</p>
<p>在 <code>table</code> 目录下的 <code>views.py</code> 中新增函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table</span>(<span class="params">request, table_id</span>):</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;table.html&#x27;</span>, &#123;</span><br><span class="line">        <span class="string">&#x27;room_name_json&#x27;</span>: table_id</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, re_path</span><br><span class="line"><span class="keyword">from</span> table.views <span class="keyword">import</span> table</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    re_path(<span class="string">&#x27;table/(\d+)&#x27;</span>, table),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>前端实现WebSocket：</p>
<p>WebSocket对象一个支持四个消息：onopen，onmessage，oncluse和onerror，我们这里用了两个onmessage和onclose</p>
<blockquote>
<p>onopen： 当浏览器和websocket服务端连接成功后会触发onopen消息</p>
<p>onerror： 如果连接失败，或者发送、接收数据失败，或者数据处理出错都会触发onerror消息</p>
<p>onmessage： 当浏览器接收到websocket服务器发送过来的数据时，就会触发onmessage消息，参数e包含了服务端发送过来的数据</p>
<p>onclose： 当浏览器接收到websocket服务器发送过来的关闭连接请求时，会触发onclose消息载请注明出处。</p>
</blockquote>
<p>在 <code>table</code> 的 <code>templates\table</code> 目录下新增 <code>table.html</code>:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- chat/templates/chat/room.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Chat Room<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;chat-log&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;100&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;20&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;chat-message-input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">size</span>=<span class="string">&quot;100&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;chat-message-submit&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Send&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> roomName = &#123;&#123; room_name_json &#125;&#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> chatSocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://&#x27;</span> + <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">host</span> + <span class="string">&#x27;/ws/table/&#x27;</span> + roomName + <span class="string">&#x27;/&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    chatSocket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chat-log&#x27;</span>).<span class="property">value</span> += (<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data).<span class="title function_">slice</span>(<span class="number">1</span>,-<span class="number">1</span>) + <span class="string">&#x27;\n&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    chatSocket.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Chat socket closed unexpectedly&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chat-message-input&#x27;</span>).<span class="title function_">focus</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chat-message-input&#x27;</span>).<span class="property">onkeyup</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (e.<span class="property">keyCode</span> === <span class="number">13</span>) &#123;  <span class="comment">// enter, return</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chat-message-submit&#x27;</span>).<span class="title function_">click</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chat-message-submit&#x27;</span>).<span class="property">onclick</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> messageInputDom = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chat-message-input&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> message = messageInputDom.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        chatSocket.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        messageInputDom.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-3-3、consoles功能">4.3.3、consoles功能</h3>
<h4 id="（1）前端实现">（1）前端实现</h4>
<p>前端的终端效果我们使用xterm.js来完成。</p>
<p>Xterm.js的安装和使用：vue中使用xterm，要在客户端项目根目录下进行安装，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install xterm </span><br></pre></td></tr></table></figure>
<p>xterm.js初始化</p>
<p>在main.js文件中加上如下内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;xterm/css/xterm.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;xterm/lib/xterm&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在Host.vue中，主机列表后面的console对应的地址，实现参数跳转。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> &lt;template v-if=&quot;column.dataIndex === &#x27;consoles&#x27;&quot;&gt;</span><br><span class="line">        &lt;router-link :to=&quot;`/uric/console/$&#123;record.id&#125;`&quot;&gt;Console&lt;/router-link&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<p>设置路由router：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Console</span> <span class="keyword">from</span> <span class="string">&#x27;../views/Console&#x27;</span> </span><br><span class="line">&#123;</span><br><span class="line">                <span class="attr">meta</span>: &#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="string">&#x27;Console&#x27;</span>,</span><br><span class="line">                    <span class="attr">authenticate</span>: <span class="literal">true</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;console/:host_id&#x27;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;Console&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="title class_">Console</span></span><br><span class="line">            &#125;,</span><br></pre></td></tr></table></figure>
<p>创建<code>Console.vue</code>组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;console&quot;&gt;</span><br><span class="line">    &lt;div id=&quot;terminal&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;Terminal&#125; from &#x27;xterm&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Console&quot;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.show_terminal()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    show_terminal() &#123;</span><br><span class="line">      // 初始化terminal窗口</span><br><span class="line">      let term = new Terminal(&#123;</span><br><span class="line">        rendererType: &quot;canvas&quot;, //渲染类型</span><br><span class="line">        // rows: 40, //行数</span><br><span class="line">        convertEol: true, // 启用时，光标将设置为下一行的开头</span><br><span class="line">        scrollback: 100,   // 终端中的回滚量</span><br><span class="line">        disableStdin: false, //是否应禁用输入。</span><br><span class="line">        cursorStyle: &#x27;underline&#x27;, //光标样式</span><br><span class="line">        cursorBlink: true, //光标闪烁</span><br><span class="line">        theme: &#123;</span><br><span class="line">          foreground: &#x27;#ffffff&#x27;, //字体</span><br><span class="line">          background: &#x27;#060101&#x27;, //背景色</span><br><span class="line">          cursor: &#x27;help&#x27;,//设置光标</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      // 建立websocket</span><br><span class="line">      let ws = new WebSocket(`ws://api.uric.cn:8000/ws/ssh/$&#123;this.$route.params.id&#125;/`);</span><br><span class="line">      let cmd = &#x27;&#x27;;  // 拼接用户输入的命令</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      // 监听接收来自服务端响应的数据</span><br><span class="line">      ws.onmessage = function (event) &#123;</span><br><span class="line">        if (!cmd) &#123;</span><br><span class="line">          //所要执行的操作</span><br><span class="line">          term.write(event.data);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          console.log(event.data.split(&#x27;\r\n&#x27;))</span><br><span class="line">          cmd = &#x27;&#x27;</span><br><span class="line">          let res = event.data.replace(event.data.split(&#x27;\r\n&#x27;, 1)[0] + &quot;\r\n&quot;, &#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">          term.write(&#x27;\r\n&#x27; + res)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      term.prompt = () =&gt; &#123;</span><br><span class="line">        term.write(&#x27;\r\n&#x27;);</span><br><span class="line">        // term.write(&#x27;\r\n$ &#x27;)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      term.onKey(e =&gt; &#123;</span><br><span class="line">        console.log(e.key)</span><br><span class="line">        const ev = e.domEvent</span><br><span class="line">        const printable = !ev.altKey &amp;&amp; !ev.altGraphKey &amp;&amp; !ev.ctrlKey &amp;&amp; !ev.metaKey</span><br><span class="line"></span><br><span class="line">        if (ev.key === &quot;Enter&quot;) &#123;</span><br><span class="line">          // 按下回车键进行指令的发送</span><br><span class="line">          ws.send(cmd);</span><br><span class="line"></span><br><span class="line">        &#125; else if (ev.key === &quot;BackSpace&quot;) &#123;</span><br><span class="line">          // Do not delete the prompt</span><br><span class="line">          if (term._core.buffer.x &gt; 2) &#123;</span><br><span class="line">            term.write(&#x27;\b \b&#x27;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else if (printable) &#123;</span><br><span class="line">          term.write(e.key);</span><br><span class="line">          cmd += e.key</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      term.open(document.getElementById(&#x27;terminal&#x27;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><img src="assets/image-20220703093603883-6812165.png" alt="image-20220703093603883"></p>
<blockquote>
<p>top命令</p>
</blockquote>
<h4 id="（2）-后端实现">（2） 后端实现</h4>
<p>django没有原生支持的websocket模块，所以我们通过dwebsocket或者channels来完成。</p>
<p>安装channels</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install channels==<span class="number">2.3</span><span class="number">.1</span></span><br><span class="line">pip install channels-redis==<span class="number">2.4</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
<p>配置channel</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">   ...</span><br><span class="line">   <span class="string">&#x27;channels&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置channel的通道层</span></span><br><span class="line">CHANNEL_LAYERS = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;channels_redis.core.RedisChannelLayer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONFIG&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;hosts&quot;</span>: [(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在host应用下面创建一个routing.py文件</span></span><br><span class="line">ASGI_APPLICATION = <span class="string">&#x27;uric_api.routing.application&#x27;</span></span><br></pre></td></tr></table></figure>
<p><code>uric_api/uric_api/routing.py</code>文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.routing <span class="keyword">import</span> ProtocolTypeRouter, ChannelNameRouter</span><br><span class="line"></span><br><span class="line"><span class="comment"># ProtocolTypeRouter 根据不同的请求协议，分发到不同的协议处理系统，如果是websocket协议，那么自动找routing.ws_router进行路由转发，如果是channel，那么通过executors.SSHExecutor路由进行转发，如果是http协议，那么还是按照之前的方式进行分发</span></span><br><span class="line"><span class="keyword">from</span> host <span class="keyword">import</span> ws_urls  <span class="comment"># 这里类似原来的http编写代码时的路由，只是当时的路由信息，填写在了urls,而接下来，我们要编写websocket的路由，则写在routing，模块下</span></span><br><span class="line"></span><br><span class="line">application = ProtocolTypeRouter(&#123;</span><br><span class="line">    <span class="string">&#x27;websocket&#x27;</span>: ws_urls.ws_router</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>host.ws_urls.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> channels.routing <span class="keyword">import</span> URLRouter</span><br><span class="line"><span class="keyword">from</span> .consumer <span class="keyword">import</span> SSHCmdConsumer</span><br><span class="line"><span class="comment"># 由于我们可能会对websocket请求进行一些验证或者身份认证，所以我们在consumer应用下面在创建一个middleware文件，里面可以配置一些认证规则</span></span><br><span class="line">ws_router = URLRouter([</span><br><span class="line">        path(<span class="string">&#x27;ws/ssh/&lt;int:id&gt;/&#x27;</span>, SSHCmdConsumer),</span><br><span class="line">    ])</span><br></pre></td></tr></table></figure>
<p><code>host.consumer.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># websocket的视图类代码</span></span><br><span class="line"><span class="comment"># channels中所有的webscoetk视图类，都必须直接或间接继承于WebsocketConsumer</span></span><br><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> WebsocketConsumer</span><br><span class="line"><span class="keyword">from</span> host.models <span class="keyword">import</span> Host</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.key <span class="keyword">import</span> PkeyManager</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.ssh <span class="keyword">import</span> SSHParamiko</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSHCmdConsumer</span>(<span class="title class_ inherited__">WebsocketConsumer</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(*args, **kwargs)</span><br><span class="line">        self.<span class="built_in">id</span> = self.scope[<span class="string">&#x27;url_route&#x27;</span>][<span class="string">&#x27;kwargs&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        <span class="comment"># websocket通讯的管道对象</span></span><br><span class="line">        self.ssh_chan = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 这就是基于paramiko连接远程服务器时的ssh操作对象</span></span><br><span class="line">        self.ssh = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_response</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = self.ssh_chan.recv(<span class="number">64</span> * <span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                self.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            self.send(data.decode())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4 接收客户端发送过来的指令，并发送给主机执行指令</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">self, text_data=<span class="literal">None</span>, bytes_data=<span class="literal">None</span></span>):</span><br><span class="line">        data = text_data <span class="keyword">or</span> bytes_data</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;receive:&#x27;</span>, data, <span class="built_in">type</span>(data))</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            self.ssh_chan.send(data + <span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self, code</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;websocket断开连接以后，服务端这边也要和远程主机关闭ssh通信&quot;&quot;&quot;</span></span><br><span class="line">        self.ssh_chan.close()</span><br><span class="line">        self.ssh.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Connection close&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1 请求来了自动触发父类connect方法，我们继承拓展父类的connect方法，因为我们和客户端建立连接的同时，就可以和客户端想要操作的主机建立一个ssh连接通道。</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;connect连接来啦&#x27;</span>)</span><br><span class="line">        self.accept()  <span class="comment"># 建立websocket连接，进行连接的三次握手</span></span><br><span class="line">        self.send(<span class="string">&#x27;Connecting ...\r\n&#x27;</span>)</span><br><span class="line">        host = Host.objects.<span class="built_in">filter</span>(pk=self.<span class="built_in">id</span>).first()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            private_key, public_key = PkeyManager.get(settings.DEFAULT_KEY_NAME)</span><br><span class="line">            <span class="built_in">print</span>(private_key, public_key)</span><br><span class="line">            self.ssh = SSHParamiko(host.ip_addr, host.port, host.username, private_key)</span><br><span class="line">            self.client = self.ssh.get_connected_client()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.send(<span class="string">f&#x27;Exception: <span class="subst">&#123;e&#125;</span>\r\n&#x27;</span>)</span><br><span class="line">            self.close()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.ssh_chan = self.client.invoke_shell(</span><br><span class="line">            term=<span class="string">&#x27;xterm&#x27;</span>)  <span class="comment"># invoke_shell激活shell终端模式，也就是长连接模式，exec_command()函数是将服务器执行完的结果一次性返回给你；invoke_shell()函数类似shell终端，可以将执行结果分批次返回，所以我们接受数据时需要循环的取数据</span></span><br><span class="line">        self.ssh_chan.transport.set_keepalive(<span class="number">30</span>)  <span class="comment"># 连接中没有任何信息时，该连接能够维持30秒</span></span><br><span class="line">        <span class="comment"># 和主机的连接一旦建立，主机就会将连接信息返回给服务端和主机的连接通道中，并且以后我们还要在这个通道中进行指令发送和指令结果的读取，所以我们开启单独的线程，去连接中一直等待和获取指令执行结果的返回数据</span></span><br><span class="line">        t = Thread(target=self.read_response)</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>
<h1>五、批量与定时任务</h1>
<h2 id="5-1、批量命令执行">5.1、批量命令执行</h2>
<h3 id="5-1-1、前端实现">5.1.1、前端实现</h3>
<p><img src="assets/image-20220703005121759-6780682.png" alt="image-20220703005121759"></p>
<p>Ace-editor编辑器:：文档地址： <a target="_blank" rel="noopener" href="https://github.com/CarterLi/vue3-ace-editor">https://github.com/CarterLi/vue3-ace-editor</a></p>
<p>客户端根目录下，下载安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue3-ace-editor</span><br></pre></td></tr></table></figure>
<p>在需要引入编辑器插件的组件中先挂载插件，然后再使用，那么我们现在就需要在MultiExec.vue中注册插件。</p>
<p><code>MultiExec.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;multi_exec&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h3&gt;执行主机：&lt;/h3&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;a-tag closable @close=&quot;close_host(info_index)&quot; v-for=&quot;(info,info_index) in show_host_info&quot; :key=&quot;info.id&quot;&gt;</span><br><span class="line">          &#123;&#123; `$&#123;info.name&#125;($&#123;info.ip_addr&#125;:$&#123;info.port&#125;)` &#125;&#125;</span><br><span class="line">        &lt;/a-tag&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=&quot;margin-top: 10px;&quot;&gt;</span><br><span class="line">      &lt;a-button @click=&quot;showModal&quot; icon=&quot;plus&quot;&gt;从主机列表中选择&lt;/a-button&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;a-modal v-model:visible=&quot;MultiExecVisible&quot; title=&quot;&quot; @ok=&quot;onMultiExecSubmit&quot; @cancel=&quot;excelFormCancel&quot;</span><br><span class="line">                 :width=&quot;1000&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-form-item label=&quot;主机类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;</span><br><span class="line">                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; v-model=&quot;host_form.form.category&quot;</span><br><span class="line">                          @change=&quot;has_change_category&quot;&gt;</span><br><span class="line">                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value, index) in categorys&quot; :key=&quot;value.id&quot;&gt;</span><br><span class="line">                    &#123;&#123; value.name &#125;&#125;</span><br><span class="line">                  &lt;/a-select-option&gt;</span><br><span class="line">                &lt;/a-select&gt;</span><br><span class="line">              &lt;/a-form-item&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;主机别名：&quot;&gt;</span><br><span class="line">                &lt;a-input placeholder=&quot;请输入&quot;/&gt;</span><br><span class="line">              &lt;/a-form-item&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;已选：&quot;&gt;</span><br><span class="line">                &lt;span style=&quot;margin-left: 8px&quot;&gt;</span><br><span class="line">                  &lt;template v-if=&quot;hasSelected&quot;&gt;</span><br><span class="line">                    &#123;&#123; `$&#123;selectedRowKeys.length&#125;` &#125;&#125;</span><br><span class="line">                  &lt;/template&gt;</span><br><span class="line">                &lt;/span&gt;</span><br><span class="line">              &lt;/a-form-item&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">              &lt;a-button type=&quot;primary&quot; icon=&quot;sync&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data&quot;&gt;刷新&lt;/a-button&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;a-table</span><br><span class="line">                :columns=&quot;columns&quot;</span><br><span class="line">                :data-source=&quot;data&quot;</span><br><span class="line">                :pagination=&quot;false&quot;</span><br><span class="line">                :rowKey=&quot;record =&gt; record.id&quot;</span><br><span class="line">                :row-selection=&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;</span><br><span class="line">            &gt;&lt;/a-table&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/a-modal&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;v-ace-editor</span><br><span class="line">        v-model:value=&quot;content&quot;</span><br><span class="line">        @init=&quot;editorInit&quot;</span><br><span class="line">        lang=&quot;html&quot;</span><br><span class="line">        theme=&quot;chrome&quot;</span><br><span class="line">        style=&quot;height: 200px&quot;/&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; icon=&quot;thunderbolt&quot; @click=&quot;execute_cmd&quot;&gt;开始执行&lt;/a-button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;VAceEditor&#125; from &#x27;vue3-ace-editor&#x27;;</span><br><span class="line">import &#x27;ace-builds/src-noconflict/mode-html&#x27;;</span><br><span class="line">import &#x27;ace-builds/src-noconflict/theme-chrome&#x27;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import store from &quot;@/store&quot;;</span><br><span class="line">import &#123;message&#125; from &#x27;ant-design-vue&#x27;;</span><br><span class="line"></span><br><span class="line">const formItemLayout = &#123;</span><br><span class="line">  labelCol: &#123;span: 8&#125;,</span><br><span class="line">  wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">const columns = [</span><br><span class="line">  &#123;</span><br><span class="line">    // slots: &#123;title: &#x27;customTitle&#x27;&#125;,</span><br><span class="line">    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;类别&#x27;,</span><br><span class="line">    dataIndex: &#x27;category_name&#x27;,</span><br><span class="line">    key: &#x27;category_name&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;主机名称&#x27;,</span><br><span class="line">    dataIndex: &#x27;name&#x27;,</span><br><span class="line">    key: &#x27;name&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;连接地址&#x27;,</span><br><span class="line">    dataIndex: &#x27;ip_addr&#x27;,</span><br><span class="line">    key: &#x27;ip_addr&#x27;,</span><br><span class="line">    width: 200,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;端口&#x27;,</span><br><span class="line">    dataIndex: &#x27;port&#x27;,</span><br><span class="line">    key: &#x27;port&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;备注信息&#x27;,</span><br><span class="line">    dataIndex: &#x27;description&#x27;,</span><br><span class="line">    key: &#x27;description&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;MultiExec&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      formItemLayout,        // 弹窗的首行表单配置信息</span><br><span class="line">      columns,               // 弹窗的表格的每一列数据的配置信息</span><br><span class="line">      show_host_info: [],    // 显示选中的所有主机内容</span><br><span class="line">      MultiExecVisible: false,        // 是否显示主机列表的弹窗</span><br><span class="line">      host_form: &#123;</span><br><span class="line">        form: &#123;</span><br><span class="line">          category: undefined,// 当前选择的主机分类ID</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      data: [],              // 当前显示表格中的主机列表数据</span><br><span class="line">      categorys: [],         // 主机分类列表</span><br><span class="line">      selectedRowKeys: [],   // 已经勾选的主机ID列表</span><br><span class="line">      selected_host_ids: [], // 选中的主机id列表</span><br><span class="line">      content: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  // 计算属性</span><br><span class="line">  computed: &#123;</span><br><span class="line">    hasSelected() &#123;</span><br><span class="line">      return this.selectedRowKeys.length &gt; 0;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    this.get_host_category_list()</span><br><span class="line">    this.get_host_list()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    showModal() &#123;</span><br><span class="line">      this.MultiExecVisible = true;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 选中主机时触发的，selectedRowKeys被选中的主机id列表</span><br><span class="line">    onSelectChange(selectedRowKeys) &#123;</span><br><span class="line">      this.selectedRowKeys = selectedRowKeys;</span><br><span class="line">    &#125;,</span><br><span class="line">    onMultiExecSubmit() &#123;</span><br><span class="line">      this.data.forEach((v, k) =&gt; &#123;</span><br><span class="line">        if (this.selectedRowKeys.includes(v.id)) &#123; // 判断某元素是否在数组中用includes比较合适，不能用in</span><br><span class="line">          this.show_host_info.push(&#123;</span><br><span class="line">            id: v.id,</span><br><span class="line">            name: v.name,</span><br><span class="line">            ip_addr: v.ip_addr,</span><br><span class="line">            port: v.port,</span><br><span class="line">          &#125;)</span><br><span class="line">          this.selected_host_ids.push(v.id);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      // 关闭弹窗</span><br><span class="line">      this.MultiExecVisible = false;</span><br><span class="line">    &#125;,</span><br><span class="line">    get_host_category_list() &#123;</span><br><span class="line">      // 获取主机类别</span><br><span class="line">      // let token = sessionStorage.token || localStorage.token;</span><br><span class="line">      axios.get(`$&#123;this.$settings.host&#125;/host/category`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        this.categorys = response.data;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    get_host_list(category = null) &#123;</span><br><span class="line">      // 获取主机列表</span><br><span class="line">      let params = &#123;&#125;</span><br><span class="line">      if (category !== null) &#123;</span><br><span class="line">        params.category = category</span><br><span class="line">      &#125;</span><br><span class="line">      // let token = sessionStorage.token || localStorage.token;</span><br><span class="line">      axios.get(`$&#123;this.$settings.host&#125;/host/`, &#123;</span><br><span class="line">        params: params,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        this.data = response.data;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    has_change_category(category) &#123;</span><br><span class="line">      // 切换主机分类时，重新获取主机列表</span><br><span class="line">      this.get_host_list(category)</span><br><span class="line">    &#125;,</span><br><span class="line">    refresh_data() &#123;</span><br><span class="line">      // 刷新数据</span><br><span class="line">      this.host_form.form.category = undefined</span><br><span class="line">      this.get_host_list();</span><br><span class="line">    &#125;,</span><br><span class="line">    close_host(info_index) &#123;</span><br><span class="line">      // 移除已经勾选的主机信息</span><br><span class="line">      this.show_host_info.splice(info_index, 1);</span><br><span class="line">      let ids_list = this.selected_host_ids.splice(info_index, 1);</span><br><span class="line">      let id_index = this.selectedRowKeys.indexOf(ids_list[0]);</span><br><span class="line">      this.selectedRowKeys.splice(id_index, 1);</span><br><span class="line">    &#125;,</span><br><span class="line">    execute_cmd() &#123;</span><br><span class="line">      // let token = sessionStorage.token || localStorage.token;</span><br><span class="line">      axios.post(`$&#123;this.$settings.host&#125;/mtask/cmd_exec`, &#123;</span><br><span class="line">        host_ids: this.selected_host_ids,</span><br><span class="line">        cmd: this.content,</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((res) =&gt; &#123;</span><br><span class="line">        console.log(res);</span><br><span class="line">        message.success(&#x27;批量任务执行成功！&#x27;)</span><br><span class="line"></span><br><span class="line">      &#125;).catch((err) =&gt; &#123;</span><br><span class="line">        message.error(&#x27;批量任务执行失败！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    VAceEditor,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>路由代码，<code>src/router/index.js</code>，代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;multi_exec&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;MultiExec&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">MultiExec</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-2、后端实现">5.1.2、后端实现</h3>
<h4 id="（1）创建批量任务应用">（1）创建批量任务应用</h4>
<p>关于批量任务，我们是一个单独的模块，所以我们也创建一个单独的应用来完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ../../manage.py startapp mtask</span><br></pre></td></tr></table></figure>
<p>配置应用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;mtask&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>mtask/urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>总路由，<code>uric_api.urls</code>，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&#x27;mtask/&#x27;</span>, include(<span class="string">&#x27;mtask.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="（2）获取所有主机信息">（2）获取所有主机信息</h4>
<p>服务端提供主机列表数据</p>
<p>在原来的主机管理的视图集的基础上，增加一个按分类显示数据即可。</p>
<p><code>host/views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HostModelViewSet</span>(<span class="title class_ inherited__">ModelViewSet</span>):</span><br><span class="line">    serializer_class = HostModelSerializers</span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_queryset</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 重写qureyset方法，补充过滤主机列表参数，获取主机列表</span></span><br><span class="line">        category_id = self.request.query_params.get(<span class="string">&quot;category&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        queryset = Host.objects</span><br><span class="line">        <span class="keyword">if</span> category_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            queryset = queryset.<span class="built_in">filter</span>(category_id=category_id)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queryset.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>
<h4 id="（3）执行指令操作">（3）执行指令操作</h4>
<p>后端实现执行指令的api接口</p>
<p><code>mtask/urls.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;cmd_exec&#x27;</span>, views.CmdExecView.as_view()),</span><br></pre></td></tr></table></figure>
<p><code>mtask/views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> host.models <span class="keyword">import</span> Host</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.key <span class="keyword">import</span> PkeyManager</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.ssh <span class="keyword">import</span> SSHParamiko</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CmdExecView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request</span>):</span><br><span class="line">        host_ids = request.data.get(<span class="string">&#x27;host_ids&#x27;</span>)</span><br><span class="line">        cmd = request.data.get(<span class="string">&#x27;cmd&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;host_ids&quot;</span>, host_ids)</span><br><span class="line">        <span class="keyword">if</span> host_ids <span class="keyword">and</span> cmd:</span><br><span class="line">            exec_host_list = Host.objects.<span class="built_in">filter</span>(id__in=host_ids)</span><br><span class="line">            pkey, _ = PkeyManager.get(settings.DEFAULT_KEY_NAME)  <span class="comment"># 获取ssh秘钥</span></span><br><span class="line">            response_list = []</span><br><span class="line">            <span class="keyword">for</span> host <span class="keyword">in</span> exec_host_list:</span><br><span class="line">                ssh = SSHParamiko(host.ip_addr, host.port, host.username, pkey)</span><br><span class="line">                ssh.get_connected_client()</span><br><span class="line">                <span class="comment"># ssh 远程执行指令</span></span><br><span class="line">                res_code, res_data = ssh.execute_cmd(cmd)</span><br><span class="line">                <span class="comment"># res_code为0表示ok，不为0说明指令执行有问题</span></span><br><span class="line">                response_list.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;host_info&#x27;</span>: &#123;</span><br><span class="line">                        <span class="string">&#x27;id&#x27;</span>: host.<span class="built_in">id</span>,</span><br><span class="line">                        <span class="string">&#x27;name&#x27;</span>: host.name,</span><br><span class="line">                        <span class="string">&#x27;ip_addr&#x27;</span>: host.ip_addr,</span><br><span class="line">                        <span class="string">&#x27;port&#x27;</span>: host.port,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&#x27;res_code&#x27;</span>: res_code,</span><br><span class="line">                    <span class="string">&#x27;res_data&#x27;</span>: res_data,</span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">return</span> Response(response_list)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;没有该主机或者没有输入指令&#x27;</span>&#125;, status=<span class="number">400</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="5-2、指令模板">5.2、指令模板</h2>
<h3 id="5-2-1、前端实现">5.2.1、前端实现</h3>
<p><img src="assets/image-20220703151226691-6832348.png" alt="image-20220703151226691"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;multi_exec&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h3&gt;执行主机：&lt;/h3&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;a-tag closable @close=&quot;close_host(info_index)&quot; v-for=&quot;(info,info_index) in show_host_info&quot; :key=&quot;info.id&quot;&gt;</span><br><span class="line">          &#123;&#123; `$&#123;info.name&#125;($&#123;info.ip_addr&#125;:$&#123;info.port&#125;)` &#125;&#125;</span><br><span class="line">        &lt;/a-tag&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=&quot;margin-top: 10px;&quot;&gt;</span><br><span class="line">      &lt;a-button @click=&quot;showModal&quot; icon=&quot;plus&quot;&gt;从主机列表中选择&lt;/a-button&gt;</span><br><span class="line">      &lt;a-button @click=&quot;showModal2&quot;&gt;从执行模板中选择&lt;/a-button&gt;</span><br><span class="line">      &lt;div style=&quot;margin: 20px;&quot;&gt;</span><br><span class="line">        &lt;a-modal v-model:visible=&quot;visible2&quot; title=&quot;选择执行模板&quot; @ok=&quot;handleOk2&quot; width=&quot;960px&quot;&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;a-row&gt;</span><br><span class="line">              &lt;a-col :span=&quot;10&quot;&gt;</span><br><span class="line">                &lt;a-form-item label=&quot;模板类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot;</span><br><span class="line">                             :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;</span><br><span class="line">                  &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; @change=&quot;&quot;&gt;</span><br><span class="line">                  &lt;/a-select&gt;</span><br><span class="line">                &lt;/a-form-item&gt;</span><br><span class="line">              &lt;/a-col&gt;</span><br><span class="line">              &lt;a-col :span=&quot;10&quot;&gt;</span><br><span class="line">                &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;</span><br><span class="line">                             label=&quot;模板名称：&quot;&gt;</span><br><span class="line">                  &lt;a-input placeholder=&quot;请输入&quot;/&gt;</span><br><span class="line">                &lt;/a-form-item&gt;</span><br><span class="line">              &lt;/a-col&gt;</span><br><span class="line">              &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">                &lt;a-button type=&quot;primary&quot; icon=&quot;sync&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;&quot;&gt;刷新&lt;/a-button&gt;</span><br><span class="line">              &lt;/a-col&gt;</span><br><span class="line">            &lt;/a-row&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;a-table :columns=&quot;tem_columns&quot; :data-source=&quot;tem_data&quot; :rowKey=&quot;record =&gt; record.id&quot;</span><br><span class="line">                     :row-selection=&quot;&#123; radioselectedRow: radioselectedRow, onChange: onSelectChange2,type: &#x27;radio&#x27; &#125;&quot;&gt;</span><br><span class="line">            &lt;/a-table&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/a-modal&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;a-modal v-model:visible=&quot;MultiExecVisible&quot; title=&quot;&quot; @ok=&quot;onMultiExecSubmit&quot; @cancel=&quot;excelFormCancel&quot;</span><br><span class="line">                 :width=&quot;1000&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;a-row&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-form-item label=&quot;主机类别：&quot; :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot;&gt;</span><br><span class="line">                &lt;a-select style=&quot;width: 160px;&quot; placeholder=&quot;请选择&quot; v-model=&quot;host_form.form.category&quot;</span><br><span class="line">                          @change=&quot;has_change_category&quot;&gt;</span><br><span class="line">                  &lt;a-select-option :value=&quot;value.id&quot; v-for=&quot;(value, index) in categorys&quot; :key=&quot;value.id&quot;&gt;</span><br><span class="line">                    &#123;&#123; value.name &#125;&#125;</span><br><span class="line">                  &lt;/a-select-option&gt;</span><br><span class="line">                &lt;/a-select&gt;</span><br><span class="line">              &lt;/a-form-item&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;8&quot;&gt;</span><br><span class="line">              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;主机别名：&quot;&gt;</span><br><span class="line">                &lt;a-input placeholder=&quot;请输入&quot;/&gt;</span><br><span class="line">              &lt;/a-form-item&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">              &lt;a-form-item :label-col=&quot;formItemLayout.labelCol&quot; :wrapper-col=&quot;formItemLayout.wrapperCol&quot; label=&quot;已选：&quot;&gt;</span><br><span class="line">                &lt;span style=&quot;margin-left: 8px&quot;&gt;</span><br><span class="line">                  &lt;template v-if=&quot;hasSelected&quot;&gt;</span><br><span class="line">                    &#123;&#123; `$&#123;selectedRowKeys.length&#125;` &#125;&#125;</span><br><span class="line">                  &lt;/template&gt;</span><br><span class="line">                &lt;/span&gt;</span><br><span class="line">              &lt;/a-form-item&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">            &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">              &lt;a-button type=&quot;primary&quot; icon=&quot;sync&quot; style=&quot;margin-top: 3px;&quot; @click=&quot;refresh_data&quot;&gt;刷新&lt;/a-button&gt;</span><br><span class="line">            &lt;/a-col&gt;</span><br><span class="line">          &lt;/a-row&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;a-table</span><br><span class="line">                :columns=&quot;columns&quot;</span><br><span class="line">                :data-source=&quot;data&quot;</span><br><span class="line">                :pagination=&quot;false&quot;</span><br><span class="line">                :rowKey=&quot;record =&gt; record.id&quot;</span><br><span class="line">                :row-selection=&quot;&#123; selectedRowKeys: selectedRowKeys, onChange: onSelectChange &#125;&quot;</span><br><span class="line">            &gt;&lt;/a-table&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/a-modal&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;v-ace-editor</span><br><span class="line">        v-model:value=&quot;content&quot;</span><br><span class="line">        @init=&quot;editorInit&quot;</span><br><span class="line">        lang=&quot;html&quot;</span><br><span class="line">        theme=&quot;chrome&quot;</span><br><span class="line">        style=&quot;height: 200px&quot;/&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; icon=&quot;thunderbolt&quot; @click=&quot;execute_cmd&quot;&gt;开始执行&lt;/a-button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;VAceEditor&#125; from &#x27;vue3-ace-editor&#x27;;</span><br><span class="line">import &#x27;ace-builds/src-noconflict/mode-html&#x27;;</span><br><span class="line">import &#x27;ace-builds/src-noconflict/theme-chrome&#x27;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import store from &quot;@/store&quot;;</span><br><span class="line">import &#123;message&#125; from &#x27;ant-design-vue&#x27;;</span><br><span class="line"></span><br><span class="line">const formItemLayout = &#123;</span><br><span class="line">  labelCol: &#123;span: 8&#125;,</span><br><span class="line">  wrapperCol: &#123;span: 14&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">const columns = [</span><br><span class="line">  &#123;</span><br><span class="line">    // slots: &#123;title: &#x27;customTitle&#x27;&#125;,</span><br><span class="line">    scopedSlots: &#123;customRender: &#x27;action&#x27;&#125;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;类别&#x27;,</span><br><span class="line">    dataIndex: &#x27;category_name&#x27;,</span><br><span class="line">    key: &#x27;category_name&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;主机名称&#x27;,</span><br><span class="line">    dataIndex: &#x27;name&#x27;,</span><br><span class="line">    key: &#x27;name&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;连接地址&#x27;,</span><br><span class="line">    dataIndex: &#x27;ip_addr&#x27;,</span><br><span class="line">    key: &#x27;ip_addr&#x27;,</span><br><span class="line">    width: 200,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;端口&#x27;,</span><br><span class="line">    dataIndex: &#x27;port&#x27;,</span><br><span class="line">    key: &#x27;port&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;备注信息&#x27;,</span><br><span class="line">    dataIndex: &#x27;description&#x27;,</span><br><span class="line">    key: &#x27;description&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">const tem_columns = [</span><br><span class="line">  &#123;</span><br><span class="line">    title: &#x27;模板名称&#x27;,</span><br><span class="line">    dataIndex: &#x27;name&#x27;,</span><br><span class="line">    key: &#x27;name&#x27;,</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    title: &#x27;模板类型&#x27;,</span><br><span class="line">    dataIndex: &#x27;category_name&#x27;,</span><br><span class="line">    key: &#x27;category_name&#x27;,</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    title: &#x27;模板内容&#x27;,</span><br><span class="line">    dataIndex: &#x27;cmd&#x27;,</span><br><span class="line">    key: &#x27;cmd&#x27;,</span><br><span class="line">    width: 200,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    title: &#x27;描述信息&#x27;,</span><br><span class="line">    dataIndex: &#x27;description&#x27;,</span><br><span class="line">    key: &#x27;description&#x27;,</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;MultiExec&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line"></span><br><span class="line">      formItemLayout,        // 弹窗的首行表单配置信息</span><br><span class="line">      columns,               // 弹窗的表格的每一列数据的配置信息</span><br><span class="line">      show_host_info: [],    // 显示选中的所有主机内容</span><br><span class="line">      MultiExecVisible: false,        // 是否显示主机列表的弹窗</span><br><span class="line">      host_form: &#123;</span><br><span class="line">        form: &#123;</span><br><span class="line">          category: undefined,// 当前选择的主机分类ID</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      data: [],              // 当前显示表格中的主机列表数据</span><br><span class="line">      categorys: [],         // 主机分类列表</span><br><span class="line">      selectedRowKeys: [],   // 已经勾选的主机ID列表</span><br><span class="line">      selected_host_ids: [], // 选中的主机id列表</span><br><span class="line">      visible2: false,</span><br><span class="line">      template_form: &#123;</span><br><span class="line">        form: &#123;</span><br><span class="line">          category: undefined,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      tem_categorys: [],    // 指令模板分类列表</span><br><span class="line">      tem_data: [],         // 指令模板列表</span><br><span class="line">      radioselectedRow: [], //</span><br><span class="line">      content: &quot;&quot;,</span><br><span class="line">      tem_columns,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">// 计算属性</span><br><span class="line">  computed: &#123;</span><br><span class="line">    hasSelected() &#123;</span><br><span class="line">      return this.selectedRowKeys.length &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  created() &#123;</span><br><span class="line">    this.get_host_category_list()</span><br><span class="line">    /this.get_host_list()</span><br><span class="line">    // this.get_templates_category_list()</span><br><span class="line">    // this.get_templates_list()</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    showModal() &#123;</span><br><span class="line">      this.MultiExecVisible = true;</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    // 选中主机时触发的，selectedRowKeys被选中的主机id列表</span><br><span class="line">    onSelectChange(selectedRowKeys) &#123;</span><br><span class="line">      this.selectedRowKeys = selectedRowKeys;</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    onMultiExecSubmit() &#123;</span><br><span class="line">      this.data.forEach((v, k) =&gt; &#123;</span><br><span class="line">        if (this.selectedRowKeys.includes(v.id)) &#123; // 判断某元素是否在数组中用includes比较合适，不能用in</span><br><span class="line">          this.show_host_info.push(&#123;</span><br><span class="line">            id: v.id,</span><br><span class="line">            name: v.name,</span><br><span class="line">            ip_addr: v.ip_addr,</span><br><span class="line">            port: v.port,</span><br><span class="line">          &#125;)</span><br><span class="line">          this.selected_host_ids.push(v.id);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      // 关闭弹窗</span><br><span class="line">      this.MultiExecVisible = false;</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    get_host_category_list() &#123;</span><br><span class="line">      // 获取主机类别</span><br><span class="line">      // let token = sessionStorage.token || localStorage.token;</span><br><span class="line">      axios.get(`$&#123;this.$settings.host&#125;/host/category`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        this.categorys = response.data;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    get_host_list(category = null) &#123;</span><br><span class="line">      // 获取主机列表</span><br><span class="line">      let params = &#123;&#125;</span><br><span class="line">      if (category !== null) &#123;</span><br><span class="line">        params.category = category</span><br><span class="line">      &#125;</span><br><span class="line">      // let token = sessionStorage.token || localStorage.token;</span><br><span class="line">      axios.get(`$&#123;this.$settings.host&#125;/host/`, &#123;</span><br><span class="line">        params: params,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        this.data = response.data;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    has_change_category(category) &#123;</span><br><span class="line">      // 切换主机分类时，重新获取主机列表</span><br><span class="line">      this.get_host_list(category)</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    refresh_data() &#123;</span><br><span class="line">      // 刷新数据</span><br><span class="line">      this.host_form.form.category = undefined</span><br><span class="line">      this.get_host_list();</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    close_host(info_index) &#123;</span><br><span class="line">      // 移除已经勾选的主机信息</span><br><span class="line">      this.show_host_info.splice(info_index, 1);</span><br><span class="line">      let ids_list = this.selected_host_ids.splice(info_index, 1);</span><br><span class="line">      let id_index = this.selectedRowKeys.indexOf(ids_list[0]);</span><br><span class="line">      this.selectedRowKeys.splice(id_index, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    execute_cmd() &#123;</span><br><span class="line">      // let token = sessionStorage.token || localStorage.token;</span><br><span class="line">      axios.post(`$&#123;this.$settings.host&#125;/mtask/cmd_exec`, &#123;</span><br><span class="line">        host_ids: this.selected_host_ids,</span><br><span class="line">        cmd: this.content,</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((res) =&gt; &#123;</span><br><span class="line">        console.log(res);</span><br><span class="line">        message.success(&#x27;批量任务执行成功！&#x27;)</span><br><span class="line"></span><br><span class="line">      &#125;).catch((err) =&gt; &#123;</span><br><span class="line">        message.error(&#x27;批量任务执行失败！&#x27;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    showModal2() &#123;</span><br><span class="line">      this.visible2 = true;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleOk2(e) &#123;</span><br><span class="line">      let tid = this.radioselectedRow[0]; //选中的模板id值</span><br><span class="line">      // 通过模板id值，找到该模板记录中的cmd值，并赋值给content属性</span><br><span class="line">      this.tem_data.forEach((v, k) =&gt; &#123;</span><br><span class="line">        if (v.id === tid) &#123;</span><br><span class="line">          this.content = v.cmd;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      this.visible2 = false;</span><br><span class="line">    &#125;,</span><br><span class="line">    onSelectChange2(radioselectedRow) &#123;</span><br><span class="line">      // [6, 7, 8, 9]</span><br><span class="line">      console.log(&#x27;&gt;&gt;&gt;&gt;&gt; &#x27;, radioselectedRow);</span><br><span class="line">      this.radioselectedRow = radioselectedRow;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleSelectChange2(value) &#123;</span><br><span class="line">      // 切换模板分类</span><br><span class="line">      this.get_templates_list(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    refresh_data2() &#123;</span><br><span class="line">      this.get_templates_list();</span><br><span class="line">    &#125;,</span><br><span class="line">    get_templates_list(category = null) &#123;</span><br><span class="line">      let params = &#123;&#125;</span><br><span class="line">      if (category !== null) &#123;</span><br><span class="line">        params.category = category</span><br><span class="line">      &#125;</span><br><span class="line">      axios.get(`$&#123;this.$settings.host&#125;/mtask/templates`, &#123;</span><br><span class="line">        params: params,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(response =&gt; &#123;</span><br><span class="line">        this.tem_data = response.data;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    get_templates_category_list() &#123;</span><br><span class="line">      axios.get(`$&#123;this.$settings.host&#125;/mtask/templates/categorys`, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          Authorization: &quot;jwt &quot; + store.getters.token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">          .then(response =&gt; &#123;</span><br><span class="line">            this.tem_categorys = response.data;</span><br><span class="line">          &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  components: &#123;</span><br><span class="line">    VAceEditor,</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2、后端实现">5.2.2、后端实现</h3>
<p>mtask/models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> uric_api.utils.models <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CmdTemplateCategory</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;cmd_template_category&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;模板分类&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CmdTemplate</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    category = models.ForeignKey(<span class="string">&#x27;CmdTemplateCategory&#x27;</span>, on_delete=models.CASCADE,verbose_name=<span class="string">&#x27;模板类别&#x27;</span>)</span><br><span class="line">    cmd = models.TextField(verbose_name=<span class="string">&#x27;模板内容&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;cmd_template&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;指令模板&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure>
<p>数据迁移，终端下在服务端项目根目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>添加测试数据，mysql中执行以下SQL语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> uric.cmd_template_category (id, name, is_show, orders, is_deleted, created_time, updated_time, description) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;文件操作&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;2021-08-07 20:52:55&#x27;</span>, <span class="string">&#x27;2021-08-07 20:52:55&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> uric.cmd_template_category (id, name, is_show, orders, is_deleted, created_time, updated_time, description) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;文件夹操作&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;2021-08-07 20:52:55&#x27;</span>, <span class="string">&#x27;2021-08-07 20:52:55&#x27;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> uric.cmd_template (id, name, is_show, orders, is_deleted, created_time, updated_time, description, cmd, category_id) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;列出当前目录下所有文件&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;2021-08-07 20:55:45&#x27;</span>, <span class="string">&#x27;2021-08-07 20:55:45&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> uric.cmd_template (id, name, is_show, orders, is_deleted, created_time, updated_time, description, cmd, category_id) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;创建文件&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;2021-08-07 20:55:45&#x27;</span>, <span class="string">&#x27;2021-08-07 20:55:45&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;touch index.html&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> uric.cmd_template (id, name, is_show, orders, is_deleted, created_time, updated_time, description, cmd, category_id) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;家目录下创建文件夹&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;2021-08-07 20:55:45&#x27;</span>, <span class="string">&#x27;2021-08-07 20:55:45&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;cd /home</span></span><br><span class="line"><span class="string">mkdir uric&#x27;</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>mtask/urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;cmd_exec&#x27;</span>, views.CmdExecView.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;templates&#x27;</span>, views.TemplateView.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;templates/categorys&#x27;</span>, views.TemplateCategoryView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>mtask/views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListAPIView, CreateAPIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> CmdTemplate, CmdTemplateCategory</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CmdTemplateModelSerialzer, CmdTemplateCategoryModelSerialzer</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemplateView</span>(ListAPIView, CreateAPIView):</span><br><span class="line">    <span class="comment"># 获取所有执行模板</span></span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br><span class="line">    queryset = CmdTemplate.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CmdTemplateModelSerialzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemplateCategoryView</span>(ListAPIView, CreateAPIView):</span><br><span class="line">    <span class="comment"># 获取执行模板类别</span></span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br><span class="line">    queryset = CmdTemplateCategory.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CmdTemplateCategoryModelSerialzer</span><br></pre></td></tr></table></figure>
<p>mtask.serializers，代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> CmdTemplateCategory, CmdTemplate</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CmdTemplateModelSerialzer</span>(serializers.ModelSerializer):</span><br><span class="line">    category_name = serializers.CharField(source=<span class="string">&quot;category.name&quot;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = CmdTemplate</span><br><span class="line">        fields = [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;description&quot;</span>, <span class="string">&quot;category_name&quot;</span>, <span class="string">&quot;category&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CmdTemplateCategoryModelSerialzer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = CmdTemplateCategory</span><br><span class="line">        fields = <span class="string">&quot;__all__&quot;</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        Share
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://yunminitools.cn/2023/03/01/uric2022/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" rel="tag">编程技巧</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/03/01/How-to-Requirements-Review/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            如何做好需求评审？
          
        </div>
      </a>
    
    
      <a href="/2023/02/28/Network-Effects/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">什么是网络效应？</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2023-2024
        <i class="ri-heart-fill heart_icon"></i> Richard Z.
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
        <li>
          <a href="https://beian.miit.gov.cn/" target="_black" rel="nofollow">沪ICP备15046216号</a>
        </li>
        
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/desktopicon.png" alt="New structure for utility"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "base" });
  }
</script>


    
    

  </div>
</body>

</html>